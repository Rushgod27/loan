import { auth, db } from "./js/firebase.js";

import {
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  updateDoc,
  addDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let uid = null;

/* ================= NAVIGATION ================= */

window.goBorrowers = () => {
  location.href = "borrowers.html";
};

window.logoutUser = async () => {
  await signOut(auth);
  location.href = "index.html";
};

/* ================= AUTH ================= */

onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = "index.html";
    return;
  }
  uid = user.uid;
  loadDashboard();
});

/* ================= DASHBOARD ================= */

async function loadDashboard(){

  const today = new Date();
  today.setHours(0,0,0,0);

  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate()+1);

  let dueHTML="";
  let overdueHTML="";

  /* ================= BORROWERS ================= */

  const borrowerSnap = await getDocs(query(
    collection(db,"borrowers"),
    where("agentId","==",uid)
  ));

  const borrowerMap = {};
  borrowerSnap.forEach(d=>{
    borrowerMap[d.id] = d.data();
  });

  /* ================= INSTALLMENTS ================= */

  const instSnap = await getDocs(query(
    collection(db,"installments"),
    where("agentId","==",uid),
    where("status","==","pending")
  ));

  instSnap.forEach(d=>{

    const data = d.data();
    const borrower = borrowerMap[data.borrowerId];
    if(!borrower) return;

    const dueDate = new Date(data.dueDate);
    dueDate.setHours(0,0,0,0);

    const phone = borrower.phone;

    const msg =
      `Hello ${borrower.name}, your installment of â‚¹${data.amount} is pending.`;

    const waLink =
      `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

    const cardHTML = `
      <div class="card" style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <b>${borrower.name}</b><br>
            â‚¹${data.amount} <br>
            <small>${dueDate.toLocaleDateString()}</small><br>
            <a href="tel:${phone}">ğŸ“ ${phone}</a>
          </div>

          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button onclick="window.open('${waLink}','_blank')">ğŸ›ï¸</button>
            <button onclick="window.location.href='tel:${phone}'">ğŸ“</button>
            <button style="background:#16a34a;color:white;"
              onclick="markPaid('${d.id}','${data.loanId}',${data.amount})">
              âœ“ Paid
            </button>
          </div>
        </div>
      </div>
    `;

    if(dueDate >= today && dueDate < tomorrow){
      dueHTML += cardHTML;
    }

    if(dueDate < today){
      overdueHTML += cardHTML;
    }

  });

  content.innerHTML = `
    <div class="card">
      <h3>ğŸŸ  Due Today</h3>
      ${dueHTML || "No dues today"}
    </div>

    <div class="card">
      <h3>ğŸ”´ Overdue</h3>
      ${overdueHTML || "No overdue EMI"}
    </div>
  `;
}

/* ================= MARK PAID ================= */

window.markPaid = async(instId, loanId, amt) => {

  if(!confirm("Mark this installment as paid?")) return;

  // Update installment
  await updateDoc(
    doc(db,"installments",instId),
    { status:"completed" }
  );

  // Create collection entry
  await addDoc(collection(db,"collections"),{
    loanId,
    agentId: uid,
    amount: amt,
    type:"installment",
    date: Date.now()
  });

  // Check if loan completed
  const snap = await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  let completed = true;
  snap.forEach(d=>{
    if(d.data().status !== "completed")
      completed = false;
  });

  if(completed){
    await updateDoc(
      doc(db,"loans",loanId),
      { status:"completed" }
    );
  }

  loadDashboard(); // refresh UI
};