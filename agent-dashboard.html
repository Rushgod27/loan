<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">Agent Panel</div>

<div class="nav">
<div onclick="goDashboard()" class="active">Dashboard</div>
<div onclick="goBorrowers()">Borrowers</div>
<div onclick="goReports()">Reports</div>
<div onclick="logoutUser()">Logout</div>
</div>

<div id="dashboardContent"></div>

<script type="module">
import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, query, where,
  getDocs
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;

window.goBorrowers=()=>location.href="borrowers.html";
window.goReports=()=>location.href="reports.html";
window.goDashboard=()=>location.href="dashboard.html";
window.logoutUser=()=>signOut(auth);

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadDashboard();
});

async function loadDashboard(){

  let loanSnap=await getDocs(query(
    collection(db,"loans"),
    where("agentId","==",currentUserId)
  ));

  let activeLoans=0;
  loanSnap.forEach(d=>{
    if(d.data().status==="active")
      activeLoans++;
  });

  dashboardContent.innerHTML=`
  <div class="card">
  Active Loans<br>
  <b>${activeLoans}</b>
  </div>`;
}

</script>
</body>
</html>
