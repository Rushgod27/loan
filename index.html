<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="login-wrapper">
  <div class="login-card">
    <div class="login-title">Login</div>

    <input id="loginEmail" placeholder="Enter your email">

    <button class="login-btn" onclick="sendLoginLink()">
      Send Login Link
    </button>

    <div class="login-footer">
      You will receive a secure login link in your email.
    </div>
  </div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  sendSignInLinkToEmail,
  isSignInWithEmailLink,
  signInWithEmailLink,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= CONFIG ================= */

const actionCodeSettings = {
  url: window.location.origin + window.location.pathname,
  handleCodeInApp: true
};

/* ================= SEND LOGIN LINK ================= */

window.sendLoginLink = async () => {

  const email = document
    .getElementById("loginEmail")
    .value
    .trim()
    .toLowerCase();

  if(!email){
    alert("Enter your email");
    return;
  }

  try{

    // ðŸ” Check if user registered in Firestore
    const q = query(
      collection(db,"users"),
      where("email","==",email)
    );

    const snap = await getDocs(q);

    if(snap.empty){
      alert("Email not registered with the system.");
      return;
    }

    await sendSignInLinkToEmail(auth,email,actionCodeSettings);

    localStorage.setItem("emailForSignIn", email);

    alert("Login link sent. Check your email.");

  }catch(err){
    alert("Error: " + err.message);
  }
};

/* ================= HANDLE EMAIL LINK ================= */

if (isSignInWithEmailLink(auth, window.location.href)) {

  let email = localStorage.getItem("emailForSignIn");

  if (!email) {
    email = prompt("Enter your email to confirm");
  }

  signInWithEmailLink(auth, email, window.location.href)
    .then(async (result) => {

      localStorage.removeItem("emailForSignIn");

      const user = result.user;

      // ðŸ” Get role from Firestore
      const q = query(
        collection(db,"users"),
        where("email","==",user.email.toLowerCase())
      );

      const snap = await getDocs(q);

      if(snap.empty){
        alert("User role not assigned.");
        return;
      }

      const docData = snap.docs[0];
      const role = docData.data().role;

      // Save UID if not saved
      if(!docData.data().uid){
        await updateDoc(
          doc(db,"users",docData.id),
          { uid: user.uid }
        );
      }

      // ðŸ”€ ROLE BASED REDIRECT
      if(role === "boss"){
        window.location.href = "boss-dashboard.html";
      }
      else if(role === "owner"){
        window.location.href = "owner-dashboard.html";
      }
      else if(role === "agent"){
        window.location.href = "agent-dashboard.html";
      }
      else{
        alert("Invalid role.");
      }

    })
    .catch(err=>{
      alert("Login failed: " + err.message);
    });
}

/* ================= AUTO REDIRECT IF LOGGED ================= */

onAuthStateChanged(auth, async user => {

  if(!user) return;

  const q = query(
    collection(db,"users"),
    where("email","==",user.email.toLowerCase())
  );

  const snap = await getDocs(q);

  if(snap.empty) return;

  const role = snap.docs[0].data().role;

  if(role === "boss"){
    window.location.href="boss-dashboard.html";
  }
  else if(role === "owner"){
    window.location.href="owner-dashboard.html";
  }
  else if(role === "agent"){
    window.location.href="agent-dashboard.html";
  }

});

</script>

</body>
</html>