<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Finance Portal Login</title>

<meta name="viewport"
content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/styles.css">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>

/* ===== PAGE LAYOUT ===== */

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:linear-gradient(135deg,#eef2ff,#f8fafc);
}

/* ===== CARD ===== */

.card{
  max-width:400px;
  margin:60px auto;
  background:#ffffff;
  padding:30px;
  border-radius:20px;
  box-shadow:0 20px 45px rgba(0,0,0,0.07);
  text-align:center;
}

.portal-title{
  margin:0;
  font-size:24px;
  font-weight:700;
}

.portal-sub{
  font-size:14px;
  color:#6b7280;
  margin-bottom:25px;
}

/* ===== GOOGLE BUTTON ===== */

.google-btn{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  background:#fff;
  font-weight:600;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  transition:.3s;
}

.google-btn img{
  width:18px;
}

.google-btn:hover{
  background:#f9fafb;
}

/* ===== INPUTS ===== */

select,
input{
  width:100%;
  padding:12px;
  margin-top:12px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  font-size:14px;
}

.primary-btn{
  margin-top:15px;
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  background:#4f46e5;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.primary-btn:hover{
  opacity:.9;
}

.divider{
  margin:25px 0 15px;
  font-size:12px;
  color:#9ca3af;
  letter-spacing:1px;
}

.note{
  margin-top:18px;
  font-size:12px;
  color:#6b7280;
}

/* ===== INFO SECTION ===== */

.info-section{
  margin-top:25px;
  padding-top:15px;
  border-top:1px solid #e5e7eb;
  text-align:left;
}

.info-section h4{
  margin:0 0 10px;
  font-size:14px;
}

.info-section ul{
  padding-left:18px;
  font-size:13px;
  color:#6b7280;
}

/* ===== INSTALL GATE ===== */

.install-gate{
  position:fixed;
  inset:0;
  background:white;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:30px;
  text-align:center;
}

.install-box{
  max-width:360px;
}

.install-btn{
  margin-top:20px;
  padding:14px 28px;
  border-radius:999px;
  border:none;
  background:#4f46e5;
  color:#ffffff;
  font-weight:600;
  cursor:pointer;
}

</style>
</head>

<body>

<!-- INSTALL BLOCK -->
<div id="installGate" class="install-gate"></div>

<!-- LOGIN CONTENT -->
<div id="loginContent">

<div class="card">

<h2 class="portal-title">Finance Portal</h2>
<p class="portal-sub">Secure Loan Management System</p>

<button class="google-btn" onclick="googleLogin()">
  <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg">
  Sign in with Google
</button>

<div class="divider">OR APPLY</div>

<select id="roleSelect" style="display:none;">
  <option value="">Apply As</option>
  <option value="agent">Agent</option>
  <option value="owner">Owner</option>
</select>

<input id="codeInput"
       placeholder="Enter Invite Code"
       style="display:none;">

<button id="submitBtn"
        class="primary-btn"
        style="display:none;">
Submit Application
</button>

<div class="note">
New users must apply and wait for approval.
</div>

<div class="info-section">
  <h4>How It Works</h4>
  <ul>
    <li>Agent → Requires Owner Invite</li>
    <li>Owner → Requires Boss Invite</li>
    <li>Approval Required Before Access</li>
  </ul>
</div>

</div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  setDoc,
  getDoc,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ===== FORCE ACCOUNT CHOICE ===== */

window.googleLogin = async()=>{
  const provider = new GoogleAuthProvider();

  provider.setCustomParameters({
    prompt: "select_account"
  });

  await signInWithPopup(auth, provider);
};

/* ===== PWA INSTALL ===== */

function isStandalone(){
  return window.matchMedia('(display-mode: standalone)').matches
         || window.navigator.standalone === true;
}

const gate = document.getElementById("installGate");
const loginContent = document.getElementById("loginContent");

if(!isStandalone()){
  loginContent.style.display="none";
  gate.style.display="flex";

  gate.innerHTML=`
    <div class="install-box">
      <h2>Install App to Continue</h2>
      <p>Please install the app before login.</p>
      <button id="installBtn" class="install-btn">
        Install App
      </button>
      <p style="margin-top:10px;font-size:13px;">
        iPhone: Share → Add to Home Screen
      </p>
    </div>
  `;
}

let deferredPrompt;

window.addEventListener("beforeinstallprompt",(e)=>{
  e.preventDefault();
  deferredPrompt=e;
  document.getElementById("installBtn")?.addEventListener("click",async()=>{
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if(outcome==="accepted") location.reload();
  });
});

window.addEventListener("appinstalled",()=>location.reload());

/* ===== AUTH STATE ===== */

let currentUser=null;

onAuthStateChanged(auth,async(user)=>{

  const justLoggedOut = sessionStorage.getItem("justLoggedOut");
  if(justLoggedOut){
    sessionStorage.removeItem("justLoggedOut");
    return;
  }

  if(!user) return;

  currentUser=user;

  const userSnap=await getDoc(doc(db,"users",user.uid));

  if(userSnap.exists()){
    const data=userSnap.data();

    if(data.role==="pending"){
      alert("Waiting for approval.");
      await signOut(auth);
      return;
    }

    if(data.role==="boss")
      window.location.replace("boss-dashboard.html");

    if(data.role==="owner")
      window.location.replace("owner-dashboard.html");

    if(data.role==="agent")
      window.location.replace("agent.html");

    return;
  }

  roleSelect.style.display="block";
  submitBtn.style.display="block";
});

/* ROLE CHANGE */

roleSelect.addEventListener("change",(e)=>{
  codeInput.style.display="block";

  if(e.target.value==="agent"){
    codeInput.placeholder="Enter Owner Invite Code";
  }

  if(e.target.value==="owner"){
    codeInput.placeholder="Enter Boss Invite Code";
  }
});

/* SUBMIT */

submitBtn.addEventListener("click",async()=>{

  const role=roleSelect.value;
  const code=codeInput.value.trim();

  if(!role || !code){
    alert("Fill all fields");
    return;
  }

  const q=query(collection(db,"users"),
    where("inviteCode","==",code));

  const snap=await getDocs(q);

  if(snap.empty){
    alert("Invalid Invite Code");
    return;
  }

  const approverDoc=snap.docs[0];
  const approverData=approverDoc.data();

  if(role==="owner" && approverData.role!=="boss"){
    alert("Owner must use Boss invite code");
    return;
  }

  if(role==="agent" && approverData.role!=="owner"){
    alert("Agent must use Owner invite code");
    return;
  }

  await setDoc(doc(db,"users",currentUser.uid),{
    name:currentUser.displayName,
    email:currentUser.email,
    role:"pending",
    requestedRole:role,
    requestedTo:approverDoc.id,
    createdAt:Date.now()
  });

  alert("Application submitted. Wait for approval.");
  await signOut(auth);
});

/* SERVICE WORKER */

if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("./sw.js");
  });
}

</script>

</body>
</html>