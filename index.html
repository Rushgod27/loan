<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="login-wrapper">
  <div class="login-card">
    <div class="login-title">Loan Management Login</div>

    <input id="email" placeholder="Enter your email">

    <button class="login-btn" onclick="sendLink()">
      Send Login Link
    </button>

    <div class="login-footer">
      Passwordless Secure Login
    </div>
  </div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  sendSignInLinkToEmail,
  isSignInWithEmailLink,
  signInWithEmailLink
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* SEND LOGIN LINK */

window.sendLink = async () => {

  const email =
    document.getElementById("email")
    .value.trim()
    .toLowerCase();

  if(!email){
    alert("Enter email");
    return;
  }

  const q = query(
    collection(db,"users"),
    where("email","==",email)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    alert("Email not registered with the app.");
    return;
  }

  const actionCodeSettings = {
    url: window.location.href,
    handleCodeInApp: true
  };

  await sendSignInLinkToEmail(
    auth,
    email,
    actionCodeSettings
  );

  localStorage.setItem(
    "emailForSignIn",
    email
  );

  alert("Login link sent to your email.");
};

/* HANDLE LOGIN */

if(isSignInWithEmailLink(auth, window.location.href)){

  let email =
    localStorage.getItem("emailForSignIn");

  if(!email){
    email = prompt("Confirm email");
  }

  const result =
    await signInWithEmailLink(
      auth,
      email,
      window.location.href
    );

  localStorage.removeItem("emailForSignIn");

  const uid = result.user.uid;

  const q = query(
    collection(db,"users"),
    where("email","==",email)
  );

  const snap = await getDocs(q);

  if(snap.empty){
    alert("User record missing.");
    return;
  }

  const userDoc = snap.docs[0];
  const data    = userDoc.data();

  if(!data.uid){
    await updateDoc(userDoc.ref,{
      uid: uid
    });
  }

  if(data.role === "boss"){
    location.href="boss-dashboard.html";
  }
  else if(data.role === "owner"){
    location.href="owner-dashboard.html";
  }
  else if(data.role === "agent"){
    location.href="agent-dashboard.html";
  }
}

</script>
</body>
</html>