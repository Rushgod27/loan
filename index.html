<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="stylesheet" href="css/styles.css?v=15">

<style>
/* ================= INSTALL GATE ================= */

.install-gate{
  position:fixed;
  inset:0;
  background:#ffffff;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:30px;
  text-align:center;
}

.install-box{
  max-width:360px;
}

.install-box h2{
  margin-bottom:10px;
}

.install-box p{
  color:#64748b;
  font-size:14px;
}

.install-btn{
  margin-top:20px;
  padding:14px 28px;
  border-radius:999px;
  border:none;
  background:#eef2ff;
  color:#4f46e5;
  font-weight:600;
  cursor:pointer;
}
</style>

</head>
<body>

<!-- INSTALL BLOCKER -->
<div id="installGate" class="install-gate"></div>

<!-- LOGIN CONTENT -->
<div id="loginContent">

  <!-- ðŸ”½ KEEP YOUR EXISTING LOGIN FORM EXACTLY HERE ðŸ”½ -->
  <div class="login-wrapper">
    <div class="login-card">

      <div class="login-title">Agent Login</div>

      <input id="emailInput" type="email" placeholder="Email">
      <input id="passwordInput" type="password" placeholder="Password">

      <button onclick="loginUser()">Login</button>

    </div>
  </div>
  <!-- ðŸ”¼ END LOGIN FORM ðŸ”¼ -->

</div>

<script type="module">

import { auth } from "./js/firebase.js";
import { signInWithEmailAndPassword } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* ================= FORCE PWA INSTALL ================= */

let deferredPrompt;

function isStandalone(){
  return window.matchMedia('(display-mode: standalone)').matches
         || window.navigator.standalone === true;
}

const gate = document.getElementById("installGate");
const loginContent = document.getElementById("loginContent");

/* If NOT opened as installed app */
if(!isStandalone()){

  loginContent.style.display = "none";
  gate.style.display = "flex";

  gate.innerHTML = `
    <div class="install-box">
      <h2>Install App to Continue</h2>
      <p>
        For better performance and offline access,
        please install the app before logging in.
      </p>

      <button id="installBtn" class="install-btn">
        Install App
      </button>

      <p style="margin-top:15px;font-size:13px;">
        iPhone Users:<br>
        Tap <b>Share</b> â†’ <b>Add to Home Screen</b>
      </p>
    </div>
  `;
}

/* Android Install Prompt */
window.addEventListener("beforeinstallprompt", (e) => {

  e.preventDefault();
  deferredPrompt = e;

  const btn = document.getElementById("installBtn");

  if(btn){
    btn.onclick = async () => {

      deferredPrompt.prompt();

      const { outcome } = await deferredPrompt.userChoice;

      if(outcome === "accepted"){
        location.reload();
      }
    };
  }
});

/* After Installation */
window.addEventListener("appinstalled", () => {
  location.reload();
});

/* ================= LOGIN FUNCTION ================= */

window.loginUser = async function(){

  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;

  if(!email || !password){
    alert("Enter email and password");
    return;
  }

  try{
    await signInWithEmailAndPassword(auth,email,password);
    location.href="agent-dashboard.html";
  }
  catch(err){
    alert("Invalid credentials");
  }
};

</script>

</body>
</html>