<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Finance Portal Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>

<body>

<div class="card">

<h2>Finance Portal</h2>

<button onclick="googleLogin()">
Sign in with Google
</button>

<select id="roleSelect" style="display:none;">
  <option value="">Apply As</option>
  <option value="agent">Agent</option>
  <option value="owner">Owner</option>
</select>

<input id="codeInput"
       placeholder="Enter Invite Code"
       style="display:none;">

<button id="submitBtn"
        style="display:none;">
Submit Application
</button>

<div class="note">
New users must apply and wait for approval.
</div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  setDoc,
  getDoc,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUser=null;

/* GOOGLE LOGIN */

window.googleLogin = async()=>{
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

/* AUTH STATE */

onAuthStateChanged(auth, async(user)=>{

  if(!user) return;

  currentUser=user;

  const userSnap = await getDoc(doc(db,"users",user.uid));

  /* ===== EXISTING USER ===== */

  if(userSnap.exists()){

    const data=userSnap.data();

    if(data.role==="pending"){
      alert("Waiting for approval.");
      await signOut(auth);
      return;
    }

    if(data.role==="boss")
      location.href="boss-dashboard.html";

    if(data.role==="owner")
      location.href="owner-dashboard.html";

    if(data.role==="agent")
      location.href="agent-dashboard.html";

    return;
  }

  /* ===== NEW USER ===== */

  document.getElementById("roleSelect").style.display="block";
  document.getElementById("submitBtn").style.display="block";
});

/* ROLE CHANGE */

document.getElementById("roleSelect")
.addEventListener("change",(e)=>{

  const role=e.target.value;
  const codeInput=document.getElementById("codeInput");

  if(role==="agent"){
    codeInput.placeholder="Enter Owner Invite Code";
    codeInput.style.display="block";
  }

  if(role==="owner"){
    codeInput.placeholder="Enter Boss Invite Code";
    codeInput.style.display="block";
  }

});

/* SUBMIT APPLICATION */

document.getElementById("submitBtn")
.addEventListener("click",async()=>{

  const role=document.getElementById("roleSelect").value;
  const code=document.getElementById("codeInput").value.trim();

  if(!role || !code){
    alert("Fill all fields");
    return;
  }

  /* ===== VERIFY INVITE CODE ===== */

  const q=query(
    collection(db,"users"),
    where("inviteCode","==",code)
  );

  const snap=await getDocs(q);

  if(snap.empty){
    alert("Invalid Invite Code");
    return;
  }

  const approverDoc = snap.docs[0];
  const approverData = approverDoc.data();

  /* ===== ROLE VALIDATION ===== */

  if(role==="owner" && approverData.role!=="boss"){
    alert("Owner must use Boss invite code");
    return;
  }

  if(role==="agent" && approverData.role!=="owner"){
    alert("Agent must use Owner invite code");
    return;
  }

  const approverUID = approverDoc.id;

  /* ===== CREATE PENDING USER ===== */

  await setDoc(doc(db,"users",currentUser.uid),{
    name:currentUser.displayName,
    email:currentUser.email,
    role:"pending",
    requestedRole:role,
    requestedTo:approverUID,
    createdAt:Date.now()
  });

  alert("Application submitted. Wait for approval.");

  await signOut(auth);
});

</script>

</body>
</html>