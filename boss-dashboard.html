<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Boss Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>

<body>

<div class="header">Boss Panel (Super Admin)</div>

<div class="container">

<!-- ðŸ” BOSS INVITE CODE -->
<div class="card">
  <h3>Your Owner Invite Code</h3>
  <div id="bossCodeBox" class="code-box">Loading...</div>
  <button class="primary" onclick="regenerateBossCode()">
    Regenerate Code
  </button>
</div>

<!-- PENDING -->
<div class="card">
  <h3>Pending Requests</h3>
  <div id="pendingList"></div>
</div>

<!-- APPROVED -->
<div class="card">
  <h3>Approved Users Under You</h3>
  <div id="approvedList"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  collection, query, where, onSnapshot,
  updateDoc, deleteDoc, doc,
  getDoc, serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let bossUid=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth, async(user)=>{

  if(!user){
    location.href="index.html";
    return;
  }

  const userSnap = await getDoc(doc(db,"users",user.uid));

  if(!userSnap.exists() || userSnap.data().role!=="boss"){
    await signOut(auth);
    location.href="index.html";
    return;
  }

  bossUid = user.uid;

  await loadBossCode();
  listenPending();
  listenApproved();
});

/* ================= LOGOUT ================= */

window.logoutUser = async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= BOSS INVITE CODE SYSTEM ================= */

async function loadBossCode(){

  const ref = doc(db,"users",bossUid);
  const snap = await getDoc(ref);

  let code = snap.data().inviteCode;

  if(!code){
    code = generateCode("BOS");
    await updateDoc(ref,{ inviteCode: code });
  }

  document.getElementById("bossCodeBox").innerText = code;
}

window.regenerateBossCode = async()=>{

  const newCode = generateCode("BOS");

  await updateDoc(doc(db,"users",bossUid),{
    inviteCode:newCode
  });

  document.getElementById("bossCodeBox").innerText=newCode;
};

function generateCode(prefix){
  const random = Math.floor(100000 + Math.random() * 900000);
  return prefix + random;
}

/* ================= PENDING ================= */

function listenPending(){

  const q = query(
    collection(db,"users"),
    where("role","==","pending"),
    where("requestedTo","==",bossUid)
  );

  onSnapshot(q,(snap)=>{

    const container=document.getElementById("pendingList");
    container.innerHTML="";

    if(snap.empty){
      container.innerHTML="<p>No pending requests</p>";
      return;
    }

    snap.forEach(d=>{
      const data=d.data();

      container.innerHTML+=`
        <div class="card-row">
          <strong>${data.name}</strong>
          <span class="badge">${data.requestedRole}</span>
          <br>${data.email}
          <br><br>
          <button class="approve"
            onclick="approveUser('${d.id}')">
            Approve
          </button>
          <button class="reject"
            onclick="rejectUser('${d.id}')">
            Reject
          </button>
        </div>
      `;
    });
  });
}

/* ================= APPROVED USERS ================= */

function listenApproved(){

  const q=query(
    collection(db,"users"),
    where("approvedBy","==",bossUid)
  );

  onSnapshot(q,(snap)=>{

    const container=document.getElementById("approvedList");
    container.innerHTML="";

    snap.forEach(d=>{
      const data=d.data();

      container.innerHTML+=`
        <div class="card-row">
          <strong>${data.name}</strong>
          <span class="badge">${data.role}</span>
          <br>${data.email}
        </div>
      `;
    });
  });
}

/* ================= APPROVE ================= */

window.approveUser = async(id)=>{

  const ref = doc(db,"users",id);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const requestedRole = snap.data().requestedRole;

  await updateDoc(ref,{
    role: requestedRole,
    approvedBy: bossUid,
    approvedAt: serverTimestamp(),
    requestedRole: deleteField(),
    requestedTo: deleteField()
  });
};

/* ================= REJECT ================= */

window.rejectUser = async(id)=>{
  if(!confirm("Reject this request?")) return;
  await deleteDoc(doc(db,"users",id));
};

</script>

</body>
</html>