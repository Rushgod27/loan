<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Boss Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/boss.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>

<body>

<div class="header">
  <span>Boss Panel (Super Admin)</span>
  <button id="themeToggle" class="theme-btn">üåô</button>
</div>

<div class="container">

<!-- üîê BOSS INVITE CODE -->
<div class="card">
  <h3>Your Owner Invite Code</h3>

  <div class="invite-wrapper">
    <div id="bossCodeBox" class="code-box">Loading...</div>
    <div id="bossTimer" class="invite-timer">30s</div>
  </div>

  <button class="primary" onclick="regenerateBossCode()">
    Regenerate Code
  </button>
</div>

<!-- PENDING -->
<div class="card">
  <h3>Pending Requests</h3>
  <div id="pendingList"></div>
</div>

<!-- APPROVED -->
<div class="card">
  <h3>Approved Users Under You</h3>
  <div id="approvedList"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, query, where, onSnapshot,
updateDoc, deleteDoc, doc,
getDoc, serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* =====================================================
   GLOBAL STATE
===================================================== */

let bossUid = null;
let inviteInterval;
let inviteExpiry = null;

/* =====================================================
   AUTH
===================================================== */

onAuthStateChanged(auth, async(user)=>{

  if(!user){
    location.href = "index.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));

  if(!snap.exists() || snap.data().role !== "boss"){
    await signOut(auth);
    location.href = "index.html";
    return;
  }

  bossUid = user.uid;

  if(inviteInterval) clearInterval(inviteInterval);

  await loadBossCode();
  listenPending();
  listenApproved();
});

/* =====================================================
   LOGOUT
===================================================== */

window.logoutUser = async()=>{

  await signOut(auth);
  sessionStorage.setItem("justLoggedOut","true");
  window.location.replace("index.html");
};

/* =====================================================
   INVITE AUTO ROTATION SYSTEM
===================================================== */

async function loadBossCode(){

  const ref = doc(db,"users",bossUid);
  const snap = await getDoc(ref);
  const data = snap.data();

  if(!data.inviteCode || !data.inviteExpiry || data.inviteExpiry < Date.now()){
    await generateBossCode();
  }else{
    document.getElementById("bossCodeBox").innerText = data.inviteCode;
    inviteExpiry = data.inviteExpiry;
  }

  startBossTimer();
}

async function generateBossCode(){

  const code = generateCode("BOS");
  const expiry = Date.now() + 30000; // 30 seconds

  await updateDoc(doc(db,"users",bossUid),{
    inviteCode: code,
    inviteExpiry: expiry
  });

  document.getElementById("bossCodeBox").innerText = code;

  const timerEl = document.getElementById("bossTimer");
  timerEl.classList.remove("shake");

  inviteExpiry = expiry;
}

window.regenerateBossCode = async()=>{
  clearInterval(inviteInterval);
  await generateBossCode();
  startBossTimer();
};

function startBossTimer(){

  if(inviteInterval) clearInterval(inviteInterval);

  const timerEl = document.getElementById("bossTimer");

  inviteInterval = setInterval(async ()=>{

    const timeLeft = Math.floor((inviteExpiry - Date.now())/1000);

    if(timeLeft <= 0){
      clearInterval(inviteInterval);
      await generateBossCode();
      startBossTimer();
      return;
    }

    timerEl.innerText = timeLeft + "s";

    if(timeLeft <= 5){
      timerEl.classList.add("shake");
    }else{
      timerEl.classList.remove("shake");
    }

  },1000);
}

function generateCode(prefix){
  const random = Math.floor(100000 + Math.random() * 900000);
  return prefix + random;
}

/* =====================================================
   PENDING REQUESTS
===================================================== */

function listenPending(){

  const q = query(
    collection(db,"users"),
    where("role","==","pending"),
    where("requestedTo","==",bossUid)
  );

  onSnapshot(q,(snap)=>{

    const container = document.getElementById("pendingList");
    container.innerHTML = "";

    if(snap.empty){
      container.innerHTML = "<p>No pending requests</p>";
      return;
    }

    snap.forEach(d=>{
      const data = d.data();

      container.innerHTML += `
        <div class="card-row">
          <strong>${data.name}</strong>
          <span class="badge">${data.requestedRole}</span>
          <br>${data.email}
          <br><br>
          <button class="approve"
            onclick="approveUser('${d.id}')">
            Approve
          </button>
          <button class="reject"
            onclick="rejectUser('${d.id}')">
            Reject
          </button>
        </div>
      `;
    });
  });
}

/* =====================================================
   APPROVED USERS
===================================================== */

function listenApproved(){

  const q = query(
    collection(db,"users"),
    where("approvedBy","==",bossUid)
  );

  onSnapshot(q,(snap)=>{

    const container = document.getElementById("approvedList");
    container.innerHTML = "";

    snap.forEach(d=>{
      const data = d.data();

      container.innerHTML += `
        <div class="card-row">
          <strong>${data.name}</strong>
          <span class="badge">${data.role}</span>
          <br>${data.email}
        </div>
      `;
    });
  });
}

/* =====================================================
   APPROVE
===================================================== */

window.approveUser = async(id)=>{

  const ref = doc(db,"users",id);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const requestedRole = snap.data().requestedRole;

  await updateDoc(ref,{
    role: requestedRole,
    approvedBy: bossUid,
    approvedAt: serverTimestamp(),
    requestedRole: deleteField(),
    requestedTo: deleteField()
  });
};

/* =====================================================
   REJECT
===================================================== */

window.rejectUser = async(id)=>{

  if(!confirm("Reject this request?")) return;

  await deleteDoc(doc(db,"users",id));
};

/* =====================================================
   SERVICE WORKER (PWA)
===================================================== */

if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("/sw.js")
      .then(()=> console.log("PWA Ready"))
      .catch(err=> console.log("SW Error",err));
  });
}
/* ================= DARK MODE ================= */

document.getElementById("themeToggle").onclick = ()=>{

  document.body.classList.toggle("boss-dark");

  const isDark = document.body.classList.contains("boss-dark");
  localStorage.setItem("bossTheme", isDark ? "dark" : "light");

  themeToggle.innerText = isDark ? "‚òÄÔ∏è" : "üåô";
};

window.addEventListener("DOMContentLoaded", ()=>{

  const saved = localStorage.getItem("bossTheme");

  if(saved === "dark"){
    document.body.classList.add("boss-dark");
    themeToggle.innerText = "‚òÄÔ∏è";
  }
});
</script>

</body>
</html>