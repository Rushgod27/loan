<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Boss Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:system-ui;background:#f3f4f6}
.header{background:#111827;color:#fff;padding:16px;text-align:center;font-weight:600;font-size:18px}
.container{padding:16px}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 4px 10px rgba(0,0,0,0.08)}
.card-row{background:#f9fafb;padding:10px;border-radius:8px;margin-bottom:8px}
button{padding:8px 14px;border:none;border-radius:6px;color:#fff;cursor:pointer}
.approve{background:#16a34a}
.reject{background:#ef4444;margin-left:6px}
.logout{width:100%;margin-top:10px;background:#111827}
.badge{background:#e5e7eb;padding:2px 8px;border-radius:12px;font-size:12px;margin-left:6px}
</style>
</head>

<body>

<div class="header">Boss Panel (Super Admin)</div>

<div class="container">

<div class="card">
  <h3>Pending Owner / Boss Requests</h3>
  <div id="pendingList"></div>
</div>

<div class="card">
  <h3>Approved Users</h3>
  <div id="approvedList"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { 
  collection, 
  query, 
  where, 
  onSnapshot, 
  updateDoc, 
  deleteDoc, 
  doc, 
  getDoc, 
  serverTimestamp, 
  deleteField 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let bossUid=null;

/* ================= AUTH CHECK ================= */

onAuthStateChanged(auth, async(user)=>{

  if(!user){
    location.href="index.html";
    return;
  }

  const userRef = doc(db,"users",user.uid);
  const userSnap = await getDoc(userRef);

  if(!userSnap.exists() || userSnap.data().role!=="boss"){
    await signOut(auth);
    location.href="index.html";
    return;
  }

  bossUid = user.uid;

  listenPending();
  listenApproved();
});

/* ================= LOGOUT ================= */

window.logoutUser = async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= REALTIME PENDING ================= */

function listenPending(){

  const q = query(
    collection(db,"users"),
    where("role","==","pending"),
    where("requestedRole","in",["owner","boss"])
  );

  onSnapshot(q,(snap)=>{
    const container=document.getElementById("pendingList");
    container.innerHTML="";

    if(snap.empty){
      container.innerHTML="<p>No pending requests</p>";
      return;
    }

    snap.forEach(d=>{
      const data=d.data();

      container.innerHTML+=`
        <div class="card-row">
          <strong>${data.name}</strong>
          <span class="badge">${data.requestedRole}</span>
          <br>${data.email}
          <br><br>
          <button class="approve" onclick="approveUser('${d.id}')">
            Approve
          </button>
          <button class="reject" onclick="rejectUser('${d.id}')">
            Reject
          </button>
        </div>
      `;
    });
  });
}

/* ================= REALTIME APPROVED ================= */

function listenApproved(){

  const q=query(
    collection(db,"users"),
    where("role","in",["owner","boss"])
  );

  onSnapshot(q,(snap)=>{
    const container=document.getElementById("approvedList");
    container.innerHTML="";

    snap.forEach(d=>{
      const data=d.data();

      container.innerHTML+=`
        <div class="card-row">
          <strong>${data.name}</strong>
          <span class="badge">${data.role}</span>
          <br>${data.email}
        </div>
      `;
    });
  });
}

/* ================= APPROVE ================= */

window.approveUser = async(id)=>{

  const ref = doc(db,"users",id);
  const snap = await getDoc(ref);

  if(!snap.exists()) return;

  const requestedRole = snap.data().requestedRole;

  await updateDoc(ref,{
    role: requestedRole,
    approvedBy: bossUid,
    approvedAt: serverTimestamp(),
    requestedRole: deleteField()
  });
};

/* ================= REJECT ================= */

window.rejectUser = async(id)=>{

  if(!confirm("Reject this request?")) return;

  await deleteDoc(doc(db,"users",id));
};

</script>


</body>
</html>