<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">Borrower Profile</div>

<div class="nav">
  <div onclick="goBorrowers()">Borrowers</div>
  <div onclick="goDashboard()">Dashboard</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container">

  <!-- PROFILE -->
  <div id="profileCard" class="card"></div>

  <!-- CREATE LOAN BUTTON -->
  <div class="card">
    <button onclick="toggleLoanForm()">+ Create Loan</button>
  </div>

  <!-- LOAN FORM -->
  <div id="loanForm" class="card hidden">
    <input id="principal" placeholder="Principal Amount">
    <input id="interest" placeholder="Interest %" >
    <input id="count" placeholder="Number of EMIs">
    
    <select id="interval">
      <option value="7">7 Days</option>
      <option value="15">15 Days</option>
      <option value="30">30 Days</option>
    </select>

    <input type="date" id="loanDate">

    <button onclick="createLoan()">Confirm Loan</button>
  </div>

  <!-- LOANS -->
  <div id="loanSection"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  getDoc,
  getDocs,
  collection,
  query,
  where,
  addDoc,
  updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let borrowerId = null;

const params = new URLSearchParams(window.location.search);
borrowerId = params.get("id");

/* AUTH */
onAuthStateChanged(auth, user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadBorrower();
  loadLoans();
});

/* NAV */
window.goBorrowers = () =>
  location.href="borrowers.html";

window.goDashboard = () =>
  location.href="agent-dashboard.html";

window.logout = async ()=>{
  await signOut(auth);
  location.href="index.html";
};

/* PROFILE LOAD */
async function loadBorrower(){

  const snap = await getDoc(
    doc(db,"borrowers",borrowerId)
  );

  const b = snap.data();

  profileCard.innerHTML = `
    <h3>${b.name}</h3>
    ðŸ“ž <a href="tel:${b.phone}">
      ${b.phone}
    </a><br><br>

    <a href="https://wa.me/${b.phone}"
       target="_blank">
       ðŸ’¬ WhatsApp
    </a>
  `;
}

/* TOGGLE FORM */
window.toggleLoanForm = ()=>{
  loanForm.classList.toggle("hidden");
};

/* CREATE LOAN */
window.createLoan = async ()=>{

  const principalVal = parseFloat(principal.value);
  const interestVal = parseFloat(interest.value);
  const countVal = parseInt(count.value);
  const intervalVal = parseInt(interval.value);
  const dateVal = loanDate.value;

  if(!principalVal || isNaN(interestVal) ||
     !countVal || !dateVal){
    alert("Fill all fields");
    return;
  }

  const start = new Date(dateVal).getTime();

  const interestAmount =
    (principalVal * interestVal)/100;

  const disbursed =
    principalVal - interestAmount;

  const installmentAmount =
    principalVal / countVal;

  const loanRef = await addDoc(
    collection(db,"loans"),
    {
      borrowerId,
      principal: principalVal,
      interestPercent: interestVal,
      interestAmount,
      disbursedAmount: disbursed,
      count: countVal,
      interval: intervalVal,
      startDate: start,
      status:"active",
      createdAt: Date.now()
    }
  );

  // Save upfront interest collection
  await addDoc(collection(db,"collections"),{
    loanId: loanRef.id,
    borrowerId,
    amount: interestAmount,
    type:"upfront_interest",
    date: Date.now()
  });

  // Create installments
  for(let i=0;i<countVal;i++){
    await addDoc(collection(db,"installments"),{
      loanId: loanRef.id,
      borrowerId,
      number:i+1,
      amount: installmentAmount,
      dueDate:
        start + ((i+1)*intervalVal*86400000),
      status:"pending"
    });
  }

  alert("Loan Created Successfully");

  loanForm.classList.add("hidden");
  loadLoans();
};

/* LOAD LOANS */
async function loadLoans(){

  const q = query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  );

  const snap = await getDocs(q);

  loanSection.innerHTML="";

  snap.forEach(d=>{
    const loan=d.data();

    loanSection.innerHTML+=`
      <div class="card">
        <b>Loan â‚¹${loan.principal}</b><br>
        Status: ${loan.status}<br>
        <button onclick="
          toggleInstallments('${d.id}')">
          View Installments
        </button>
        <div id="inst-${d.id}"
          class="hidden"></div>
      </div>
    `;
  });
}

/* INSTALLMENTS */
window.toggleInstallments =
async(loanId)=>{

  const box =
    document.getElementById(
      `inst-${loanId}`);

  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  const list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  box.innerHTML="";

  list.forEach(i=>{
    box.innerHTML+=`
      <div class="card ${
        i.status==="completed"
        ? "completed":""
      }">

        EMI ${i.number}<br>
        â‚¹${i.amount}<br>
        ${new Date(
          i.dueDate
        ).toLocaleDateString()}<br>

        ${
          i.status==="pending"
          ? `<button onclick="
             pay('${i.id}',
             '${loanId}',
             ${i.amount})">
             Mark Paid</button>`
          : "Paid"
        }
      </div>`;
  });
};

/* PAY */
window.pay =
async(id,loanId,amt)=>{

  await updateDoc(
    doc(db,"installments",id),
    {status:"completed"}
  );

  toggleInstallments(loanId);
};

</script>
</body>
</html>