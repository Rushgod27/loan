<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  <span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
  Borrower Profile
</div>

<div class="section-content">

  <!-- PROFILE INFO -->
  <div id="profileCard" class="card"></div>

  <!-- CREATE LOAN -->
  <div id="createLoanSection"></div>

  <!-- LOANS -->
  <div id="loanContainer"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* GET BORROWER ID FROM URL */
const params = new URLSearchParams(window.location.search);
const borrowerId = params.get("id");

if(!borrowerId){
  alert("Borrower not found");
  location.href="borrowers.html";
}

window.goBack = () => location.href="borrowers.html";

let currentUserId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadProfile();
});

/* LOAD PROFILE */
async function loadProfile(){

  const snap = await getDoc(doc(db,"borrowers",borrowerId));
  if(!snap.exists()){
    alert("Borrower not found");
    return;
  }

  const b = snap.data();

  profileCard.innerHTML=`
    <div style="display:flex;justify-content:space-between;">
      <div>
        <h3 style="margin:0">${b.name}</h3>
        <a href="tel:${b.phone}"
        style="color:#2563eb;text-decoration:none;">
        üìû ${b.phone}</a><br>
        <a target="_blank"
        href="https://wa.me/91${b.phone}">
        üí¨ WhatsApp</a>
      </div>

      <button class="btn btn-primary"
      onclick="toggleCreateLoan()">+ Loan</button>
    </div>
  `;

  loadLoans();
}

/* TOGGLE CREATE LOAN */
window.toggleCreateLoan = ()=>{
  if(createLoanSection.innerHTML){
    createLoanSection.innerHTML="";
    return;
  }

  createLoanSection.innerHTML=`
    <div class="card">
      <input id="principal" placeholder="Principal">
      <input id="interest" placeholder="Interest %">
      <input id="count" placeholder="Installments Count">
      <select id="interval">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>
      <input type="date" id="startDate">
      <button class="btn btn-success"
      onclick="createLoan()">Create</button>
    </div>
  `;
};

/* CREATE LOAN */
window.createLoan = async () => {

  const principalValue =
    parseFloat(document.getElementById("principal").value);

  const interestValue =
    parseFloat(document.getElementById("interest").value);

  const countValue =
    parseInt(document.getElementById("count").value);

  const intervalValue =
    parseInt(document.getElementById("interval").value);

  const startValue =
    document.getElementById("startDate").value;

  if(!principalValue || isNaN(interestValue)
     || !countValue || !startValue){
    alert("Fill properly");
    return;
  }

  const startTime = new Date(startValue).getTime();
  const installment = principalValue / countValue;
  const interestAmount = (principalValue * interestValue) / 100;

  const loanRef = await addDoc(collection(db,"loans"),{
    borrowerId,
    agentId: currentUserId,
    principal: principalValue,
    interestPercent: interestValue,
    interestAmount,
    count: countValue,
    interval: intervalValue,
    startDate: startTime,
    status: "active",
    createdAt: Date.now()
  });

  for(let i=0;i<countValue;i++){
    await addDoc(collection(db,"installments"),{
      loanId: loanRef.id,
      borrowerId,
      number: i+1,
      amount: installment,
      dueDate: startTime + ((i+1)*intervalValue*86400000),
      status: "pending"
    });
  }

  alert("Loan Created Successfully");

  createLoanSection.innerHTML="";
  loadLoans();
};

/* LOAD LOANS */
async function loadLoans(){

  const snap = await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  const loans=[];
  snap.forEach(d=>{
    loans.push({id:d.id,...d.data()});
  });

  renderLoans(loans);
}

/* RENDER LOANS */
function renderLoans(loans){

  loanContainer.innerHTML="";

  if(!loans.length){
    loanContainer.innerHTML=
    "<div class='card'>No loans found</div>";
    return;
  }

  const active=loans.filter(l=>l.status==="active");
  const completed=loans.filter(l=>l.status==="completed");

  function section(title,list){
    if(!list.length) return "";

    let html=`<h4 style="margin:14px 0">${title}</h4>`;

    list.forEach(loan=>{
      html+=`
      <div class="card">
        <div style="display:flex;
        justify-content:space-between;">
          <div>
            <b>‚Çπ${loan.principal}</b><br>
            <small>Started:
            ${new Date(loan.startDate)
              .toLocaleDateString()}</small>
          </div>

          <button class="btn btn-primary"
          onclick="toggleInstallments('${loan.id}')">
          View
          </button>
        </div>

        <div id="inst-${loan.id}"
        class="inst hidden"></div>
      </div>`;
    });

    return html;
  }

  loanContainer.innerHTML=
    section("Active Loans",active) +
    section("Completed Loans",completed);
}

/* TOGGLE EMI */
window.toggleInstallments=async(loanId)=>{

  document.querySelectorAll(".inst")
  .forEach(el=>{
    if(el.id!==`inst-${loanId}`){
      el.classList.add("hidden");
      el.innerHTML="";
    }
  });

  const box=document.getElementById(
    `inst-${loanId}`);

  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  const list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  list.forEach(i=>{

    let state="emi-pending";
    if(i.status==="completed")
      state="emi-paid";
    else if(i.dueDate<Date.now())
      state="emi-overdue";

    box.innerHTML+=`
      <div class="emi-row ${state}">
        <div>
          EMI ${i.number} |
          ‚Çπ${i.amount} |
          ${new Date(i.dueDate)
           .toLocaleDateString()}
        </div>

        ${
          i.status==="pending"
          ? `<button class="btn btn-success"
             onclick="pay('${i.id}',
             '${loanId}',
             ${i.amount})">
             Pay</button>`
          : "Paid"
        }
      </div>
    `;
  });
};

/* PAY */
window.pay = async(id,loanId,amt)=>{

  if(!confirm("Mark this EMI as Paid?"))
    return;

  await updateDoc(doc(db,
    "installments",id),
    {status:"completed"});

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  let done=true;
  snap.forEach(d=>{
    if(d.data().status!=="completed")
      done=false;
  });

  if(done){
    await updateDoc(
      doc(db,"loans",loanId),
      {status:"completed"}
    );
  }

  toggleInstallments(loanId);
  loadLoans();
};

</script>
</body>
</html>