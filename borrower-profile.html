<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">

<style>

/* ---------- PROFILE ACTIONS ---------- */

.contact-btn{
  display:inline-block;
  padding:6px 12px;
  border-radius:8px;
  text-decoration:none;
  font-size:13px;
  font-weight:600;
  margin-right:6px;
}

.call-btn{
  background:#2563eb;
  color:#fff;
}

.wa-btn{
  background:#16a34a;
  color:#fff;
}

/* ---------- LOAN CARD ---------- */

.loan-card{
  padding:15px;
  border-radius:14px;
  margin-bottom:15px;
  background:#fff;
  position:relative;
}

.completed{
  opacity:0.55;
}

.badge{
  position:absolute;
  right:15px;
  top:15px;
  padding:4px 8px;
  font-size:12px;
  border-radius:8px;
  background:#16a34a;
  color:#fff;
}

.progress{
  height:8px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
  margin:8px 0;
}

.progress-bar{
  height:100%;
  background:#2563eb;
}

/* ---------- INSTALLMENTS ---------- */

.inst-card{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
}

.inst-amount{
  font-size:20px;
  font-weight:bold;
}

.overdue{background:#fee2e2;}
.due{background:#fef9c3;}
.pending{background:#f3f4f6;}
.paid{background:#dcfce7;}

.pay-btn{
  background:#16a34a;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}

.view-btn{
  background:#2563eb;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}

.section-header{
  margin:20px 0 10px;
  font-size:16px;
  font-weight:600;
}

</style>
</head>

<body>

<div class="header">
<span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
Borrower Profile
</div>

<div class="section-content">
<div id="profileCard" class="card"></div>
<div id="createLoanSection"></div>
<div id="loanContainer"></div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
doc,getDoc,collection,query,where,
getDocs,addDoc,updateDoc
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const borrowerId=new URLSearchParams(window.location.search).get("id");

window.goBack=()=>location.href="borrowers.html";

let currentUserId=null;
let ownerId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth,async user=>{
if(!user){location.href="index.html";return;}

currentUserId=user.uid;

const userSnap=await getDoc(doc(db,"users",user.uid));
if(!userSnap.exists()||userSnap.data().role!=="agent"){
location.href="index.html";
return;
}

loadProfile();
});

/* ================= PROFILE ================= */

async function loadProfile(){

const snap=await getDoc(doc(db,"borrowers",borrowerId));
if(!snap.exists()){alert("Not found");return;}

const b=snap.data();
if(b.agentId!==currentUserId){
alert("Unauthorized");
location.href="borrowers.html";
return;
}

ownerId=b.ownerId;

profileCard.innerHTML=`
<div style="display:flex;justify-content:space-between">
<div>
<h3>${b.name}</h3>
<a class="contact-btn call-btn" href="tel:${b.phone}">üìû Call</a>
<a class="contact-btn wa-btn" 
   target="_blank"
   href="https://wa.me/91${b.phone}?text=Hello%20${b.name}">
   üí¨ WhatsApp
</a>
</div>
<button class="view-btn"
onclick="toggleCreateLoan()">+ Loan</button>
</div>`;

loadLoans();
}

/* ================= CREATE LOAN FORM ================= */

window.toggleCreateLoan=()=>{
if(createLoanSection.innerHTML){
createLoanSection.innerHTML="";
return;
}

createLoanSection.innerHTML=`
<div class="card">
<input id="principal" type="number" placeholder="Principal">
<input id="interest" type="number" placeholder="Interest %">
<input id="count" type="number" placeholder="Installments Count">

<select id="interval">
<option value="">Select Interval</option>
<option value="7">7 Days</option>
<option value="15">15 Days</option>
<option value="30">30 Days</option>
</select>

<input type="date" id="startDate">

<button class="view-btn" onclick="createLoan()">
Create Loan
</button>
</div>`;
};

/* ================= CREATE LOAN ================= */

window.createLoan=async()=>{

const principalValue=parseFloat(document.getElementById("principal").value);
const interestValue=parseFloat(document.getElementById("interest").value)||0;
const countValue=parseInt(document.getElementById("count").value);
const intervalValue=parseInt(document.getElementById("interval").value);
const startValue=document.getElementById("startDate").value;

if(!principalValue||!countValue||!intervalValue||!startValue){
alert("All fields required");
return;
}

if(!confirm("Are you sure you want to create this loan?"))
return;

const startTime=new Date(startValue).getTime();
const installment=principalValue/countValue;

const loanRef=await addDoc(collection(db,"loans"),{
borrowerId,
agentId:currentUserId,
ownerId,
principal:principalValue,
interestPercent:interestValue,
interestAmount:(principalValue*interestValue)/100,
count:countValue,
interval:intervalValue,
startDate:startTime,
status:"active",
createdAt:Date.now()
});

for(let i=0;i<countValue;i++){
await addDoc(collection(db,"installments"),{
loanId:loanRef.id,
borrowerId,
agentId:currentUserId,
ownerId,
number:i+1,
interval:intervalValue,
amount:installment,
dueDate:startTime+((i+1)*intervalValue*86400000),
status:"pending"
});
}

createLoanSection.innerHTML="";
loadLoans();
};

/* ================= LOAD LOANS ================= */

async function loadLoans(){

const loanSnap=await getDocs(query(
collection(db,"loans"),
where("borrowerId","==",borrowerId),
where("agentId","==",currentUserId)
));

let loans=[];
loanSnap.forEach(d=>loans.push({id:d.id,...d.data()}));

loanContainer.innerHTML="";
if(!loans.length){
loanContainer.innerHTML="<div class='card'>No loans</div>";
return;
}

/* üî• ACTIVE FIRST */
loans.sort((a,b)=>{
if(a.status==="active" && b.status==="completed") return -1;
if(a.status==="completed" && b.status==="active") return 1;
return b.createdAt-a.createdAt;
});

for(const loan of loans){

const colSnap=await getDocs(query(
collection(db,"collections"),
where("loanId","==",loan.id)
));

let paid=0;
colSnap.forEach(d=>paid+=d.data().amount||0);

let outstanding=loan.principal-paid;
let progress=(paid/loan.principal)*100;
if(progress>100)progress=100;
let completed=outstanding<=0;

loanContainer.innerHTML+=`
<div class="loan-card ${completed?'completed':''}">
${completed?'<div class="badge">Completed</div>':''}
<b>‚Çπ${loan.principal}</b><br>
Started: ${new Date(loan.startDate).toLocaleDateString()}<br>
Paid: ‚Çπ${paid} | Outstanding: ‚Çπ${outstanding}

<div class="progress">
<div class="progress-bar" style="width:${progress}%"></div>
</div>

<button class="view-btn"
onclick="toggleInstallments('${loan.id}')">
View Installments
</button>

<div id="inst-${loan.id}" style="margin-top:10px"></div>
</div>`;
}
}
/* ================= VIEW INSTALLMENTS ================= */

window.toggleInstallments = async (loanId) => {

  const box = document.getElementById("inst-" + loanId);

  // Toggle open/close
  if (box.dataset.open === "true") {
    box.innerHTML = "";
    box.dataset.open = "false";
    return;
  }

  box.dataset.open = "true";
  box.innerHTML = "Loading...";

  const snap = await getDocs(query(
    collection(db, "installments"),
    where("loanId", "==", loanId)
  ));

  let installments = [];
  snap.forEach(d => installments.push({ id: d.id, ...d.data() }));

  if (!installments.length) {
    box.innerHTML = "No installments found";
    return;
  }

  installments.sort((a, b) => a.number - b.number);

  const today = new Date();
  today.setHours(0,0,0,0);

  let html = "";

  installments.forEach(i => {

    let dueDate = new Date(i.dueDate);
    dueDate.setHours(0,0,0,0);

    let statusClass = "pending";
    let statusText = "Pending";

    if (i.status === "completed") {
      statusClass = "paid";
      statusText = "Paid";
    } else if (dueDate < today) {
      statusClass = "overdue";
      statusText = "Overdue";
    } else if (dueDate.getTime() === today.getTime()) {
      statusClass = "due";
      statusText = "Due Today";
    }

    let periodLabel = "";
    if (i.interval === 7) periodLabel = `Week ${i.number}`;
    if (i.interval === 15) periodLabel = `15 Days ${i.number}`;
    if (i.interval === 30) periodLabel = `Month ${i.number}`;

    html += `
      <div class="inst-card ${statusClass}">
        <div>
          <div>${periodLabel}</div>
          <div class="inst-amount">‚Çπ${i.amount}</div>
          <div>${dueDate.toLocaleDateString()}</div>
          <div>${statusText}</div>
        </div>

        ${i.status !== "completed" ? `
          <button class="pay-btn"
            onclick="pay('${i.id}','${loanId}',${i.amount})">
            Mark Paid
          </button>
        ` : ``}
      </div>
    `;
  });

  box.innerHTML = html;
};
/* ================= PAY ================= */

window.pay=async(id,loanId,amt)=>{
if(!confirm("Mark installment as paid?"))return;

await updateDoc(doc(db,"installments",id),
{status:"completed"});

await addDoc(collection(db,"collections"),{
loanId,borrowerId,
agentId:currentUserId,
ownerId,
amount:amt,
type:"installment",
date:Date.now()
});

loadLoans();
};

</script>
</body>
</html>