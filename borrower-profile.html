<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  <span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
  Borrower Profile
</div>

<div class="section-content">

  <!-- PROFILE INFO -->
  <div id="profileCard" class="card"></div>

  <!-- CREATE LOAN -->
  <div id="createLoanSection"></div>

  <!-- LOANS -->
  <div id="loanContainer"></div>

</div><script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);
const borrowerId = params.get("id");

if(!borrowerId){
  alert("Borrower not found");
  location.href="borrowers.html";
}

window.goBack = () => location.href="borrowers.html";

let currentUserId=null;
let borrowerData=null;
let ownerId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth, async user => {

  if(!user){
    location.href="index.html";
    return;
  }

  currentUserId = user.uid;

  const userSnap = await getDoc(doc(db,"users", user.uid));

  if(!userSnap.exists() || userSnap.data().role !== "agent"){
    location.href="index.html";
    return;
  }

  loadProfile();
});

/* ================= LOAD PROFILE ================= */

async function loadProfile(){

  const snap = await getDoc(doc(db,"borrowers",borrowerId));

  if(!snap.exists()){
    alert("Borrower not found");
    return;
  }

  borrowerData = snap.data();

  if(borrowerData.agentId !== currentUserId){
    alert("Unauthorized access.");
    location.href="borrowers.html";
    return;
  }

  ownerId = borrowerData.ownerId;

  const b = borrowerData;

  profileCard.innerHTML=`
    <div style="display:flex;justify-content:space-between;">
      <div>
        <h3>${b.name}</h3>
        üìû ${b.phone}
      </div>
      <button class="btn btn-primary"
        onclick="toggleCreateLoan()">+ Loan</button>
    </div>
  `;

  loadLoans();
}

/* ================= TOGGLE LOAN FORM ================= */

window.toggleCreateLoan = () => {

  if(createLoanSection.innerHTML){
    createLoanSection.innerHTML="";
    return;
  }

  createLoanSection.innerHTML=`
    <div class="card">
      <input id="principal" placeholder="Principal">
      <input id="interest" placeholder="Interest %">
      <input id="count" placeholder="Installments Count">
      <select id="interval">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>
      <input type="date" id="startDate">
      <button class="btn btn-success"
        onclick="createLoan()">Create</button>
    </div>
  `;
};

/* ================= CREATE LOAN ================= */

window.createLoan = async () => {

  const principalValue =
    parseFloat(document.getElementById("principal").value);

  const interestValue =
    parseFloat(document.getElementById("interest").value);

  const countValue =
    parseInt(document.getElementById("count").value);

  const intervalValue =
    parseInt(document.getElementById("interval").value);

  const startValue =
    document.getElementById("startDate").value;

  if(!principalValue || !countValue || !startValue){
    alert("Fill properly");
    return;
  }

  const startTime = new Date(startValue).getTime();
  const installment = principalValue / countValue;

  const loanRef = await addDoc(collection(db,"loans"),{
    borrowerId,
    agentId: currentUserId,
    ownerId,
    principal: principalValue,
    interestPercent: interestValue || 0,
    interestAmount: (principalValue*(interestValue||0))/100,
    count: countValue,
    interval: intervalValue,
    startDate: startTime,
    status:"active",
    createdAt:Date.now()
  });

  for(let i=0;i<countValue;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loanRef.id,
      borrowerId,
      agentId:currentUserId,
      ownerId,
      number:i+1,
      amount:installment,
      dueDate:startTime+((i+1)*intervalValue*86400000),
      status:"pending"
    });
  }

  alert("Loan Created Successfully");

  createLoanSection.innerHTML="";
  loadLoans();
};

/* ================= LOAD LOANS ================= */

async function loadLoans(){

  const snap = await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId),
    where("agentId","==",currentUserId)
  ));

  let loans=[];
  snap.forEach(d=>loans.push({id:d.id,...d.data()}));

  renderLoans(loans);
}

/* ================= RENDER LOANS ================= */

function renderLoans(loans){

  loanContainer.innerHTML="";

  if(!loans.length){
    loanContainer.innerHTML="<div class='card'>No loans yet</div>";
    return;
  }

  loans.forEach(loan=>{

    loanContainer.innerHTML+=`
      <div class="card">
        <b>‚Çπ${loan.principal}</b>
        <small> | ${loan.status}</small>
        <br>
        <button class="btn btn-primary"
          onclick="toggleInstallments('${loan.id}')">
          View Installments
        </button>
        <div id="inst-${loan.id}" class="hidden"></div>
      </div>`;
  });
}

/* ================= INSTALLMENTS ================= */

window.toggleInstallments = async (loanId) => {

  const box = document.getElementById("inst-" + loanId);

  // If already visible -> collapse
  if(box.style.display === "block"){
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }

  box.style.display = "block";
  box.innerHTML = "Loading...";

  const snap = await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  let list = [];
  snap.forEach(d => list.push({id:d.id,...d.data()}));

  list.sort((a,b)=>a.number-b.number);

  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = "No installments found";
    return;
  }

  list.forEach(i => {

    box.innerHTML += `
      <div style="padding:8px 0;border-bottom:1px solid #eee;">
        EMI ${i.number} |
        ‚Çπ${i.amount} |
        ${new Date(i.dueDate).toLocaleDateString()} |
        ${i.status}
        ${
          i.status === "pending"
          ? `<button 
              style="margin-left:10px"
              onclick="pay('${i.id}','${loanId}',${i.amount})">
              Pay
            </button>`
          : ""
        }
      </div>
    `;
  });
};

/* ================= PAY ================= */

window.pay = async(id,loanId,amt)=>{

  await updateDoc(doc(db,"installments",id),
    {status:"completed"});

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    agentId:currentUserId,
    ownerId,
    amount:amt,
    type:"installment",
    date:Date.now()
  });

  loadLoans();
};

</script></body>
</html>