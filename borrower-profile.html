<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  <span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
  Borrower Profile
</div>

<div class="section-content">

  <!-- PROFILE INFO -->
  <div id="profileCard" class="card"></div>

  <!-- CREATE LOAN -->
  <div id="createLoanSection"></div>

  <!-- LOANS -->
  <div id="loanContainer"></div>

</div>
<script type="module">

import { auth, db } from "./js/firebase.js";
import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  getDoc,
  collection,
  query,
  where,
  getDocs,
  addDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* GET BORROWER ID FROM URL */
const params = new URLSearchParams(window.location.search);
const borrowerId = params.get("id");

if(!borrowerId){
  alert("Borrower not found");
  location.href="borrowers.html";
}

window.goBack = () => location.href="borrowers.html";

let currentUserId=null;
let borrowerData=null;
let ownerId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadProfile();
});

/* LOAD PROFILE */
async function loadProfile(){

  const snap = await getDoc(doc(db,"borrowers",borrowerId));
  if(!snap.exists()){
    alert("Borrower not found");
    return;
  }

  borrowerData = snap.data();
  ownerId = borrowerData.ownerId || null;

  const b = borrowerData;

  profileCard.innerHTML=`
    <div style="display:flex;justify-content:space-between;">
      <div>
        <h3 style="margin:0">${b.name}</h3>
        <a href="tel:${b.phone}"
        style="color:#2563eb;text-decoration:none;">
        üìû ${b.phone}</a><br>
        <a target="_blank"
        href="https://wa.me/91${b.phone}">
        üí¨ WhatsApp</a>
      </div>

      <button class="btn btn-primary"
      onclick="toggleCreateLoan()">+ Loan</button>
    </div>
  `;

  loadLoans();
}

/* TOGGLE CREATE LOAN */
window.toggleCreateLoan = ()=>{
  if(createLoanSection.innerHTML){
    createLoanSection.innerHTML="";
    return;
  }

  createLoanSection.innerHTML=`
    <div class="card">
      <input id="principal" placeholder="Principal">
      <input id="interest" placeholder="Interest %">
      <input id="count" placeholder="Installments Count">
      <select id="interval">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>
      <input type="date" id="startDate">
      <button class="btn btn-success"
      onclick="createLoan()">Create</button>
    </div>
  `;
};

/* CREATE LOAN */
window.createLoan = async () => {

  const principalValue =
    parseFloat(document.getElementById("principal").value);

  const interestValue =
    parseFloat(document.getElementById("interest").value);

  const countValue =
    parseInt(document.getElementById("count").value);

  const intervalValue =
    parseInt(document.getElementById("interval").value);

  const startValue =
    document.getElementById("startDate").value;

  if(!principalValue || isNaN(interestValue)
     || !countValue || !startValue){
    alert("Fill properly");
    return;
  }

  const startTime = new Date(startValue).getTime();
  const installment = principalValue / countValue;
  const interestAmount = (principalValue * interestValue) / 100;

  /* ===== CREATE LOAN WITH OWNERID ===== */

  const loanRef = await addDoc(collection(db,"loans"),{
    borrowerId,
    agentId: currentUserId,
    ownerId: ownerId,

    principal: principalValue,
    interestPercent: interestValue,
    interestAmount,

    count: countValue,
    interval: intervalValue,
    startDate: startTime,

    status: "active",
    createdAt: Date.now()
  });

  /* ===== CREATE INSTALLMENTS WITH OWNERID ===== */

  for(let i=0;i<countValue;i++){
    await addDoc(collection(db,"installments"),{
      loanId: loanRef.id,
      borrowerId,
      agentId: currentUserId,
      ownerId: ownerId,

      number: i+1,
      amount: installment,
      dueDate: startTime + ((i+1)*intervalValue*86400000),
      status: "pending"
    });
  }

  alert("Loan Created Successfully");

  createLoanSection.innerHTML="";
  loadLoans();
};

/* LOAD LOANS */
async function loadLoans(){

  const snap = await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  const loans=[];
  snap.forEach(d=>{
    loans.push({id:d.id,...d.data()});
  });

  renderLoans(loans);
}

/* PAY */
window.pay = async(id,loanId,amt)=>{

  if(!confirm("Mark this EMI as Paid?")) return;

  await updateDoc(
    doc(db,"installments",id),
    {status:"completed"}
  );

  /* ===== CREATE COLLECTION WITH OWNERID ===== */

  await addDoc(collection(db,"collections"),{
    loanId:loanId,
    borrowerId:borrowerId,
    agentId:currentUserId,
    ownerId:ownerId,

    amount:amt,
    type:"installment",
    date:Date.now()
  });

  const snap = await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  let done=true;
  snap.forEach(d=>{
    if(d.data().status!=="completed")
      done=false;
  });

  if(done){
    await updateDoc(
      doc(db,"loans",loanId),
      {status:"completed"}
    );
  }

  toggleInstallments(loanId);
  loadLoans();
};

</script>
</body>
</html>