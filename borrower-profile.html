<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">

<style>
.loan-card{margin-bottom:15px}
.section-title{margin:15px 0 5px;font-weight:600}
.emi-card{
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  font-size:14px;
}
.overdue{background:#fee2e2}
.due{background:#fef9c3}
.pending{background:#f3f4f6}
.paid{background:#dcfce7}
.btn-pay{
  margin-top:6px;
  padding:6px 10px;
  border:none;
  border-radius:6px;
  background:#16a34a;
  color:#fff;
  cursor:pointer;
}
</style>

</head>
<body>

<div class="header">
<span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
Borrower Profile
</div>

<div class="section-content">
<div id="profileCard" class="card"></div>
<div id="createLoanSection"></div>
<div id="loanContainer"></div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
doc,getDoc,collection,query,where,
getDocs,addDoc,updateDoc
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const borrowerId = new URLSearchParams(window.location.search).get("id");
if(!borrowerId){ alert("Invalid borrower"); location.href="borrowers.html"; }

window.goBack=()=>location.href="borrowers.html";

let currentUserId=null;
let borrowerData=null;
let ownerId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth, async user=>{
if(!user){ location.href="index.html"; return; }

currentUserId=user.uid;
const userSnap=await getDoc(doc(db,"users",user.uid));
if(!userSnap.exists()||userSnap.data().role!=="agent"){
location.href="index.html"; return;
}
loadProfile();
});

/* ================= PROFILE ================= */

async function loadProfile(){

const snap=await getDoc(doc(db,"borrowers",borrowerId));
if(!snap.exists()){ alert("Not found"); return; }

borrowerData=snap.data();
if(borrowerData.agentId!==currentUserId){
alert("Unauthorized"); location.href="borrowers.html"; return;
}

ownerId=borrowerData.ownerId;

profileCard.innerHTML=`
<div style="display:flex;justify-content:space-between">
<div>
<h3>${borrowerData.name}</h3>
<a href="tel:${borrowerData.phone}">üìû ${borrowerData.phone}</a><br>
<a target="_blank"
href="https://wa.me/91${borrowerData.phone}?text=Hello%20${borrowerData.name}">
üí¨ WhatsApp</a>
</div>

<button class="btn btn-primary"
onclick="toggleCreateLoan()">+ Loan</button>
</div>`;

loadLoans();
}

/* ================= CREATE LOAN FORM ================= */

window.toggleCreateLoan=()=>{

if(createLoanSection.innerHTML){
createLoanSection.innerHTML=""; return;
}

createLoanSection.innerHTML=`
<div class="card">
<input id="loanPrincipal" placeholder="Principal">
<input id="loanInterest" placeholder="Interest %">
<input id="loanCount" placeholder="Installment Count">
<select id="loanInterval">
<option value="">Select Interval</option>
<option value="7">7 Days</option>
<option value="15">15 Days</option>
<option value="30">30 Days</option>
</select>
<input type="date" id="loanStartDate">
<button class="btn btn-success"
onclick="createLoan()">Create Loan</button>
</div>`;
};

/* ================= CREATE LOAN ================= */

window.createLoan=async()=>{

const principal = parseFloat(document.getElementById("loanPrincipal").value);
const interest = parseFloat(document.getElementById("loanInterest").value)||0;
const count = parseInt(document.getElementById("loanCount").value);
const interval = parseInt(document.getElementById("loanInterval").value);
const startValue = document.getElementById("loanStartDate").value;

if(!principal||!count||!interval||!startValue){
alert("Please fill all fields and select date.");
return;
}

if(!confirm("Are you sure you want to create this loan?"))
return;

const start=new Date(startValue).getTime();
const emi=principal/count;

const loanRef=await addDoc(collection(db,"loans"),{
borrowerId,agentId:currentUserId,ownerId,
principal,interestPercent:interest,
interestAmount:(principal*interest)/100,
count,interval,startDate:start,
status:"active",createdAt:Date.now()
});

for(let i=0;i<count;i++){
await addDoc(collection(db,"installments"),{
loanId:loanRef.id,
borrowerId,agentId:currentUserId,ownerId,
number:i+1,interval,
amount:emi,
dueDate:start+((i+1)*interval*86400000),
status:"pending"
});
}

alert("Loan created successfully");
createLoanSection.innerHTML="";
loadLoans();
};

/* ================= LOAD LOANS ================= */

async function loadLoans(){

const snap=await getDocs(query(
collection(db,"loans"),
where("borrowerId","==",borrowerId),
where("agentId","==",currentUserId)
));

let loans=[];
snap.forEach(d=>loans.push({id:d.id,...d.data()}));

renderLoans(loans);
}

/* ================= RENDER LOANS ================= */

function renderLoans(loans){

loanContainer.innerHTML="";

if(!loans.length){
loanContainer.innerHTML="<div class='card'>No loans</div>";
return;
}

loans.forEach(l=>{

loanContainer.innerHTML+=`
<div class="card loan-card">
<b>‚Çπ${l.principal}</b><br>
Interest: ${l.interestPercent}%<br>
Installments: ${l.count}<br><br>

<button class="btn btn-primary"
onclick="toggleInstallments('${l.id}')">
View Installments
</button>

<div id="inst-${l.id}" style="display:none;margin-top:10px"></div>
</div>`;
});
}

/* ================= INSTALLMENTS ================= */

window.toggleInstallments=async(loanId)=>{

const box=document.getElementById("inst-"+loanId);

if(box.style.display==="block"){
box.style.display="none"; box.innerHTML=""; return;
}

box.style.display="block";
box.innerHTML="Loading...";

const snap=await getDocs(query(
collection(db,"installments"),
where("loanId","==",loanId)
));

let list=[];
snap.forEach(d=>list.push({id:d.id,...d.data()}));
list.sort((a,b)=>a.number-b.number);

box.innerHTML="";

const today=new Date(); today.setHours(0,0,0,0);

const groups={
overdue:[],due:[],pending:[],paid:[]
};

list.forEach(i=>{
let due=new Date(i.dueDate);
due.setHours(0,0,0,0);

if(i.status==="completed")
groups.paid.push(i);
else if(due<today)
groups.overdue.push(i);
else if(due.getTime()===today.getTime())
groups.due.push(i);
else
groups.pending.push(i);
});

renderGroup("Overdue",groups.overdue,"overdue",box);
renderGroup("Due Today",groups.due,"due",box);
renderGroup("Pending",groups.pending,"pending",box);
renderGroup("Paid",groups.paid,"paid",box);
};

/* ================= RENDER GROUP ================= */

function renderGroup(title,list,type,box){

if(!list.length) return;

box.innerHTML+=`<div class="section-title">${title}</div>`;

list.forEach(i=>{

let label="";

if(i.interval==7) label=`Week ${i.number}`;
if(i.interval==15) label=`Half-Month ${i.number}`;
if(i.interval==30) label=`Month ${i.number}`;

box.innerHTML+=`
<div class="emi-card ${type}">
${label}<br>
‚Çπ${i.amount}<br>
Due: ${new Date(i.dueDate).toLocaleDateString()}

${
type!=="paid"
? `<br><button class="btn-pay"
onclick="pay('${i.id}','${i.loanId}',${i.amount})">
Mark Paid</button>`
:""
}
</div>`;
});
}

/* ================= PAY ================= */

window.pay=async(id,loanId,amt)=>{

if(!confirm("Confirm mark as paid?")) return;

await updateDoc(doc(db,"installments",id),
{status:"completed"});

await addDoc(collection(db,"collections"),{
loanId,borrowerId,
agentId:currentUserId,ownerId,
amount:amt,type:"installment",
date:Date.now()
});

toggleInstallments(loanId);
};

</script>
</body>
</html>