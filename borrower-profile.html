<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
<style>
.badge{
  padding:4px 8px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
}
.badge.green{
  background:#dcfce7;
  color:#166534;
}
.badge.blue{
  background:#dbeafe;
  color:#1e40af;
}
.completed{
  opacity:0.6;
}
.section-title{
  font-weight:600;
  margin:16px 0 8px;
}
.inst{ margin-top:10px; }
.hidden{ display:none; }
</style>
</head>
<body>

<div class="header">Borrower Profile</div>

<div class="nav">
  <div onclick="goBorrowers()">Borrowers</div>
  <div onclick="goDashboard()">Dashboard</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container">

  <!-- PROFILE -->
  <div id="profileCard" class="card"></div>

  <!-- CREATE LOAN BUTTON -->
  <div class="card">
    <button onclick="toggleLoanForm()">+ Create Loan</button>
  </div>

  <!-- LOAN FORM -->
  <div id="loanForm" class="card hidden">
    <input id="principal" placeholder="Principal Amount">
    <input id="interest" placeholder="Interest %">
    <input id="count" placeholder="Number of EMIs">

    <select id="interval">
      <option value="7">7 Days</option>
      <option value="15">15 Days</option>
      <option value="30">30 Days</option>
    </select>

    <input type="date" id="loanDate">
    <button onclick="createLoan()">Confirm Loan</button>
  </div>

  <!-- LOANS -->
  <div id="loanSection"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  getDoc,
  getDocs,
  collection,
  query,
  where,
  addDoc,
  updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let borrowerId = null;
let borrowerData = null;

const params = new URLSearchParams(window.location.search);
borrowerId = params.get("id");

/* AUTH PROTECTION */
onAuthStateChanged(auth, user => {
  if(!user){
    location.href="index.html";
    return;
  }
  if(!borrowerId){
    location.href="borrowers.html";
    return;
  }
  loadProfile();
  loadLoans();
});

/* NAVIGATION */
window.goBorrowers = () =>
  location.href="borrowers.html";

window.goDashboard = () =>
  location.href="agent-dashboard.html";

window.logout = async ()=>{
  await signOut(auth);
  location.href="index.html";
};

/* LOAD PROFILE */
async function loadProfile(){
  const snap = await getDoc(
    doc(db,"borrowers",borrowerId)
  );
  borrowerData = snap.data();

  profileCard.innerHTML = `
    <h3>${borrowerData.name}</h3>
    ðŸ“ž <a href="tel:${borrowerData.phone}">
      ${borrowerData.phone}
    </a><br><br>

    <a href="https://wa.me/${borrowerData.phone}"
       target="_blank">
       ðŸ’¬ WhatsApp
    </a>
  `;
}

/* TOGGLE FORM */
window.toggleLoanForm = ()=>{
  loanForm.classList.toggle("hidden");
};

/* CREATE LOAN */
window.createLoan = async ()=>{

  const principalVal = parseFloat(principal.value);
  const interestVal = parseFloat(interest.value);
  const countVal = parseInt(count.value);
  const intervalVal = parseInt(interval.value);
  const dateVal = loanDate.value;

  if(!principalVal || isNaN(interestVal) ||
     !countVal || !dateVal){
    alert("Fill all fields");
    return;
  }

  const start = new Date(dateVal).getTime();

  const interestAmount =
    (principalVal * interestVal)/100;

  const disbursed =
    principalVal - interestAmount;

  const installmentAmount =
    principalVal / countVal;

  const loanRef = await addDoc(
    collection(db,"loans"),{
      borrowerId,
      principal: principalVal,
      interestPercent: interestVal,
      interestAmount,
      disbursedAmount: disbursed,
      count: countVal,
      interval: intervalVal,
      startDate: start,
      status:"active",
      createdAt: Date.now()
    }
  );

  // upfront interest
  await addDoc(collection(db,"collections"),{
    loanId: loanRef.id,
    borrowerId,
    amount: interestAmount,
    type:"upfront_interest",
    date: Date.now()
  });

  // create installments
  for(let i=0;i<countVal;i++){
    await addDoc(collection(db,"installments"),{
      loanId: loanRef.id,
      borrowerId,
      number:i+1,
      amount: installmentAmount,
      dueDate:
        start + ((i+1)*intervalVal*86400000),
      status:"pending"
    });
  }

  alert("Loan Created Successfully");

  loanForm.classList.add("hidden");
  loadLoans();
};

/* LOAD LOANS */
async function loadLoans(){

  const q = query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  );

  const snap = await getDocs(q);

  let activeHTML = "";
  let completedHTML = "";

  snap.forEach(d=>{
    const loan=d.data();

    const startDate=new Date(
      loan.startDate
    ).toLocaleDateString("en-IN");

    const card = `
      <div class="card ${
        loan.status==="completed"?"completed":""
      }">

        <b>Loan â‚¹${loan.principal}</b><br>
        Interest: ${loan.interestPercent}%<br>
        Disbursed: â‚¹${loan.disbursedAmount}<br>
        Start Date: ${startDate}<br>
        EMI: ${loan.count} Ã— (${loan.interval} days)<br>

        <span class="badge ${
          loan.status==="completed"
          ?"green":"blue"
        }">
          ${loan.status}
        </span>

        <br><br>
        <button onclick="
          toggleInstallments('${d.id}')">
          View Installments
        </button>

        <div id="inst-${d.id}"
          class="inst hidden"></div>

      </div>
    `;

    if(loan.status==="completed")
      completedHTML+=card;
    else
      activeHTML+=card;
  });

  loanSection.innerHTML = `
    <div class="section-title">
      Active Loans
    </div>
    ${activeHTML || "No active loans"}

    <div class="section-title">
      Completed Loans
    </div>
    ${completedHTML || "No completed loans"}
  `;
}

/* INSTALLMENTS */
window.toggleInstallments =
async(loanId)=>{

  // collapse others
  document.querySelectorAll(".inst")
  .forEach(el=>{
    if(el.id!==`inst-${loanId}`){
      el.classList.add("hidden");
      el.innerHTML="";
    }
  });

  const box =
    document.getElementById(
      `inst-${loanId}`);

  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");

  const snap = await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  const list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  let pendingHTML="";
  let completedHTML="";
  let allCompleted=true;

  list.forEach(i=>{

    const emiCard = `
      <div class="card ${
        i.status==="completed"
        ?"completed":""
      }">

        EMI ${i.number}<br>
        â‚¹${i.amount}<br>
        ${new Date(
          i.dueDate
        ).toLocaleDateString("en-IN")}<br>

        ${
          i.status==="pending"
          ? `<button onclick="
             pay('${i.id}',
             '${loanId}',
             ${i.amount})">
             Mark Paid</button>`
          : "Paid"
        }

      </div>
    `;

    if(i.status==="pending"){
      pendingHTML+=emiCard;
      allCompleted=false;
    }else{
      completedHTML+=emiCard;
    }
  });

  if(allCompleted){
    await updateDoc(
      doc(db,"loans",loanId),
      {status:"completed"}
    );
    loadLoans();
  }

  box.innerHTML = `
    <div class="section-title">
      Pending EMIs
    </div>
    ${pendingHTML || "None"}

    <div class="section-title">
      Completed EMIs
    </div>
    ${completedHTML || "None"}
  `;
};

/* PAY */
window.pay =
async(id,loanId,amt)=>{

  const confirmPay =
    confirm("Confirm payment received?");

  if(!confirmPay) return;

  await updateDoc(
    doc(db,"installments",id),
    {status:"completed"}
  );

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    amount:amt,
    type:"installment",
    date:Date.now()
  });

  toggleInstallments(loanId);
};

</script>
</body>
</html>