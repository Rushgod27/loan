<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">

<style>

.loan-card{
  padding:15px;
  border-radius:14px;
  margin-bottom:15px;
  position:relative;
}

.completed{
  opacity:0.5;
  filter:blur(1px);
}

.badge{
  position:absolute;
  right:15px;
  top:15px;
  padding:4px 8px;
  font-size:12px;
  border-radius:8px;
  background:#16a34a;
  color:#fff;
}

.progress{
  height:8px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
  margin:8px 0;
}

.progress-bar{
  height:100%;
  background:#2563eb;
}

.inst-section-title{
  margin:15px 0 8px;
  font-weight:600;
}

.inst-card{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  background:#f9fafb;
}

.inst-amount{
  font-size:18px;
  font-weight:bold;
}

.overdue{background:#fee2e2;}
.due{background:#fef9c3;}
.pending{background:#f3f4f6;}
.paid{background:#dcfce7;}

.pay-btn{
  background:#16a34a;
  color:white;
  border:none;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
}

.view-btn{
  background:#2563eb;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}

.section-header{
  margin:20px 0 10px;
  font-size:16px;
  font-weight:600;
}

</style>
</head>
<body>

<div class="header">
<span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
Borrower Profile
</div>

<div class="section-content">
<div id="profileCard" class="card"></div>
<div id="createLoanSection"></div>
<div id="loanContainer"></div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
doc,getDoc,collection,query,where,
getDocs,addDoc,updateDoc
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const borrowerId=new URLSearchParams(window.location.search).get("id");

if(!borrowerId){
alert("Invalid borrower");
location.href="borrowers.html";
}

window.goBack=()=>location.href="borrowers.html";

let currentUserId=null;
let ownerId=null;

onAuthStateChanged(auth,async user=>{
if(!user){location.href="index.html";return;}

currentUserId=user.uid;

const userSnap=await getDoc(doc(db,"users",user.uid));
if(!userSnap.exists()||userSnap.data().role!=="agent"){
location.href="index.html";
return;
}

loadProfile();
});

async function loadProfile(){

const snap=await getDoc(doc(db,"borrowers",borrowerId));
if(!snap.exists()){alert("Not found");return;}

const b=snap.data();
if(b.agentId!==currentUserId){
alert("Unauthorized");
location.href="borrowers.html";
return;
}

ownerId=b.ownerId;

profileCard.innerHTML=`
<div style="display:flex;justify-content:space-between">
<div>
<h3>${b.name}</h3>
<a href="tel:${b.phone}">üìû ${b.phone}</a><br>
<a target="_blank" 
href="https://wa.me/91${b.phone}?text=Hello%20${b.name}">
üí¨ WhatsApp</a>
</div>
<button class="btn btn-primary"
onclick="toggleCreateLoan()">+ Loan</button>
</div>`;

loadLoans();
}

/* ================= LOAD LOANS ================= */

async function loadLoans(){

const loanSnap=await getDocs(query(
collection(db,"loans"),
where("borrowerId","==",borrowerId),
where("agentId","==",currentUserId)
));

let loans=[];
loanSnap.forEach(d=>loans.push({id:d.id,...d.data()}));

renderLoans(loans);
}

/* ================= RENDER LOANS ================= */

async function renderLoans(loans){

loanContainer.innerHTML="";

if(!loans.length){
loanContainer.innerHTML="<div class='card'>No loans</div>";
return;
}

let activeHTML="";
let completedHTML="";

for(const loan of loans){

/* GET COLLECTION TOTAL */
const colSnap=await getDocs(query(
collection(db,"collections"),
where("loanId","==",loan.id)
));

let paid=0;
colSnap.forEach(d=>paid+=d.data().amount||0);

let outstanding=loan.principal-paid;
let progress=(paid/loan.principal)*100;
if(progress>100)progress=100;

let isCompleted = outstanding<=0;

let cardHTML=`
<div class="card loan-card ${isCompleted?'completed':''}">
${isCompleted?'<div class="badge">Completed</div>':''}

<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<b>‚Çπ${loan.principal}</b><br>
Started: ${new Date(loan.startDate).toLocaleDateString()}<br>
Paid: ‚Çπ${paid}<br>
Outstanding: ‚Çπ${outstanding}
<div class="progress">
<div class="progress-bar" style="width:${progress}%"></div>
</div>
</div>

<button class="view-btn"
onclick="toggleInstallments('${loan.id}')">
View
</button>

</div>
<div id="inst-${loan.id}" style="display:none;margin-top:10px"></div>
</div>`;

if(isCompleted)
completedHTML+=cardHTML;
else
activeHTML+=cardHTML;
}

if(activeHTML)
loanContainer.innerHTML+=
`<div class="section-header">Active Loans</div>`+activeHTML;

if(completedHTML)
loanContainer.innerHTML+=
`<div class="section-header">Completed Loans</div>`+completedHTML;
}

/* ================= INSTALLMENTS ================= */

window.toggleInstallments=async(loanId)=>{

const box=document.getElementById("inst-"+loanId);

if(box.style.display==="block"){
box.style.display="none";
box.innerHTML="";
return;
}

box.style.display="block";

const snap=await getDocs(query(
collection(db,"installments"),
where("loanId","==",loanId)
));

let list=[];
snap.forEach(d=>list.push({id:d.id,...d.data()}));
list.sort((a,b)=>a.number-b.number);

const today=new Date();
today.setHours(0,0,0,0);

const groups={
overdue:[],due:[],pending:[],paid:[]
};

list.forEach(i=>{
let due=new Date(i.dueDate);
due.setHours(0,0,0,0);

if(i.status==="completed")
groups.paid.push(i);
else if(due<today)
groups.overdue.push(i);
else if(due.getTime()===today.getTime())
groups.due.push(i);
else
groups.pending.push(i);
});

box.innerHTML="";

renderGroup("Overdue",groups.overdue,"overdue",box);
renderGroup("Due Today",groups.due,"due",box);
renderGroup("Pending",groups.pending,"pending",box);
renderGroup("Paid",groups.paid,"paid",box);
};

function renderGroup(title,list,type,box){

if(!list.length)return;

box.innerHTML+=`<div class="inst-section-title">${title}</div>`;

list.forEach(i=>{

let label="";
if(i.interval==7)label=`Week ${i.number}`;
if(i.interval==15)label=`Half-Month ${i.number}`;
if(i.interval==30)label=`Month ${i.number}`;

box.innerHTML+=`
<div class="inst-card ${type}">
<div>
<div>${label}</div>
<div class="inst-amount">‚Çπ${i.amount}</div>
<div>${new Date(i.dueDate).toLocaleDateString()}</div>
</div>
${type!=="paid"?
`<button class="pay-btn"
onclick="pay('${i.id}','${i.loanId}',${i.amount})">
Pay
</button>`:""}
</div>`;
});
}

/* ================= PAY ================= */

window.pay=async(id,loanId,amt)=>{
if(!confirm("Mark this installment as paid?"))return;

await updateDoc(doc(db,"installments",id),
{status:"completed"});

await addDoc(collection(db,"collections"),{
loanId,borrowerId,
agentId:currentUserId,
ownerId,
amount:amt,
type:"installment",
date:Date.now()
});

loadLoans();
};

</script>

</body>
</html>