<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">Borrower Profile</div>

<div class="nav">
  <div onclick="goBorrowers()">Borrowers</div>
  <div onclick="goDashboard()">Dashboard</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container">

  <!-- PROFILE CARD -->
  <div id="profileCard" class="card"></div>

  <!-- CREATE LOAN BUTTON -->
  <div class="card">
    <button onclick="toggleLoanForm()">+ Create Loan</button>
  </div>

  <!-- LOAN FORM -->
  <div id="loanForm" class="card hidden">
    <input id="principal" placeholder="Principal Amount">
    <input id="interest" placeholder="Interest %">
    <input id="count" placeholder="Number of EMIs">

    <select id="interval">
      <option value="7">7 Days EMI</option>
      <option value="15">15 Days EMI</option>
      <option value="30">30 Days EMI</option>
    </select>

    <input type="date" id="loanDate">
    <button onclick="createLoan()">Confirm Loan</button>
  </div>

  <!-- LOAN SECTION -->
  <div id="loanSection"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  getDoc,
  getDocs,
  collection,
  query,
  where,
  addDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);
const borrowerId = params.get("id");

if(!borrowerId){
  location.href="borrowers.html";
}

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  loadProfile();
  loadLoans();
});

/* NAVIGATION */
window.goBorrowers=()=>location.href="borrowers.html";
window.goDashboard=()=>location.href="agent-dashboard.html";
window.logout=async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* LOAD PROFILE */
async function loadProfile(){
  const snap=await getDoc(doc(db,"borrowers",borrowerId));
  if(!snap.exists()) return;

  const b=snap.data();

  profileCard.innerHTML=`
    <h3>${b.name}</h3>

    ðŸ“ž <a href="tel:${b.phone}">
      ${b.phone}
    </a><br><br>

    <a href="https://wa.me/${b.phone}"
       target="_blank">
       ðŸ’¬ WhatsApp
    </a>
  `;
}

/* TOGGLE FORM */
window.toggleLoanForm=()=>{
  loanForm.classList.toggle("hidden");
};

/* CREATE LOAN */
window.createLoan=async()=>{

  const principalVal=parseFloat(principal.value);
  const interestVal=parseFloat(interest.value);
  const countVal=parseInt(count.value);
  const intervalVal=parseInt(interval.value);
  const dateVal=loanDate.value;

  if(!principalVal || isNaN(interestVal)
     || !countVal || !dateVal){
    alert("Fill all fields correctly");
    return;
  }

  const start=new Date(dateVal).getTime();
  const interestAmount=(principalVal*interestVal)/100;
  const disbursedAmount=principalVal-interestAmount;
  const installmentAmount=principalVal/countVal;

  const loanRef=await addDoc(collection(db,"loans"),{
    borrowerId,
    principal:principalVal,
    interestPercent:interestVal,
    interestAmount,
    disbursedAmount,
    count:countVal,
    interval:intervalVal,
    startDate:start,
    status:"active",
    createdAt:Date.now()
  });

  // upfront interest collection
  await addDoc(collection(db,"collections"),{
    loanId:loanRef.id,
    borrowerId,
    amount:interestAmount,
    type:"upfront_interest",
    date:Date.now()
  });

  // create EMIs
  for(let i=0;i<countVal;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loanRef.id,
      borrowerId,
      number:i+1,
      amount:installmentAmount,
      dueDate:start+((i+1)*intervalVal*86400000),
      status:"pending"
    });
  }

  alert("Loan Created Successfully");
  loanForm.classList.add("hidden");
  loadLoans();
};

/* LOAD LOANS */
async function loadLoans(){

  const snap=await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  let activeHTML="";
  let completedHTML="";

  snap.forEach(d=>{
    const loan=d.data();
    const startDate=new Date(
      loan.startDate
    ).toLocaleDateString("en-IN");

    const loanClass =
      loan.status==="completed"
      ? "loan-completed"
      : "loan-active";

    const card=`
      <div class="card ${loanClass}">

        <b>Loan â‚¹${loan.principal}</b><br>
        Interest: ${loan.interestPercent}%<br>
        Disbursed: â‚¹${loan.disbursedAmount}<br>
        Start: ${startDate}<br>
        EMI: ${loan.count} Ã— (${loan.interval} days)<br>

        <span class="badge ${
          loan.status==="completed"
          ? "green":"blue"
        }">
          ${loan.status}
        </span>

        <br><br>
        <button onclick="
          toggleInstallments('${d.id}')">
          View Installments
        </button>

        <div id="inst-${d.id}" class="inst hidden"></div>

      </div>
    `;

    if(loan.status==="completed")
      completedHTML+=card;
    else
      activeHTML+=card;
  });

  loanSection.innerHTML=`
    <div class="section-title">
      Active Loans
    </div>
    ${activeHTML || "No active loans"}

    <div class="section-title">
      Completed Loans
    </div>
    ${completedHTML || "No completed loans"}
  `;
}

/* TOGGLE INSTALLMENTS */
window.toggleInstallments=
async(loanId)=>{

  // collapse others
  document.querySelectorAll(".inst")
  .forEach(el=>{
    if(el.id!==`inst-${loanId}`){
      el.classList.add("hidden");
      el.innerHTML="";
    }
  });

  const box=document.getElementById(`inst-${loanId}`);

  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  const list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  let pendingHTML="";
  let paidHTML="";
  let allCompleted=true;

  list.forEach(i=>{

    const overdue =
      i.status==="pending" &&
      i.dueDate<Date.now();

    let emiClass="emi-pending";
    if(overdue) emiClass="emi-overdue";
    if(i.status==="completed")
      emiClass="emi-paid";

    const card=`
      <div class="card ${emiClass}">
        EMI ${i.number}<br>
        â‚¹${i.amount}<br>
        ${new Date(i.dueDate)
        .toLocaleDateString("en-IN")}<br>

        ${
          i.status==="pending"
          ? `<button onclick="
             pay('${i.id}',
             '${loanId}',
             ${i.amount})">
             Mark Paid</button>`
          : "Paid"
        }
      </div>
    `;

    if(i.status==="pending"){
      pendingHTML+=card;
      allCompleted=false;
    }else{
      paidHTML+=card;
    }
  });

  // Auto complete loan
  if(allCompleted){
    await updateDoc(
      doc(db,"loans",loanId),
      {status:"completed"}
    );
    loadLoans();
  }

  box.innerHTML=`
    <div class="section-title">
      Pending EMIs
    </div>
    ${pendingHTML || "None"}

    <div class="section-title">
      Paid EMIs
    </div>
    ${paidHTML || "None"}
  `;
};

/* PAY */
window.pay=
async(id,loanId,amt)=>{

  const confirmPay=
    confirm("Confirm payment received?");

  if(!confirmPay) return;

  await updateDoc(
    doc(db,"installments",id),
    {status:"completed"}
  );

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    amount:amt,
    type:"installment",
    date:Date.now()
  });

  toggleInstallments(loanId);
};

</script>
</body>
</html>