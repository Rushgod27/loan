<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrower Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">

<style>
.loan-title{font-weight:600;margin-bottom:6px}
.emi-card{
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
  font-size:14px;
}
.emi-overdue{background:#fee2e2}
.emi-due{background:#fef9c3}
.emi-pending{background:#f3f4f6}
.emi-paid{background:#dcfce7}
.section-heading{
  font-weight:600;
  margin:15px 0 5px;
}
.btn-pay{
  background:#16a34a;
  border:none;
  padding:6px 10px;
  color:#fff;
  border-radius:6px;
  cursor:pointer;
}
</style>

</head>
<body>

<div class="header">
<span onclick="goBack()" style="position:absolute;left:15px;cursor:pointer;">‚Üê</span>
Borrower Profile
</div>

<div class="section-content">

<div id="profileCard" class="card"></div>
<div id="createLoanSection"></div>
<div id="loanContainer"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
doc,getDoc,collection,query,where,
getDocs,addDoc,updateDoc
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const params=new URLSearchParams(window.location.search);
const borrowerId=params.get("id");

if(!borrowerId){
alert("Borrower not found");
location.href="borrowers.html";
}

window.goBack=()=>location.href="borrowers.html";

let currentUserId=null;
let borrowerData=null;
let ownerId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth,async user=>{
if(!user){location.href="index.html";return;}

currentUserId=user.uid;

const userSnap=await getDoc(doc(db,"users",user.uid));

if(!userSnap.exists()||userSnap.data().role!=="agent"){
location.href="index.html";return;
}

loadProfile();
});

/* ================= PROFILE ================= */

async function loadProfile(){

const snap=await getDoc(doc(db,"borrowers",borrowerId));
if(!snap.exists()){alert("Not found");return;}

borrowerData=snap.data();
if(borrowerData.agentId!==currentUserId){
alert("Unauthorized");location.href="borrowers.html";return;
}

ownerId=borrowerData.ownerId;

profileCard.innerHTML=`
<div style="display:flex;justify-content:space-between;">
<div>
<h3>${borrowerData.name}</h3>

<a href="tel:${borrowerData.phone}" 
style="text-decoration:none;color:#2563eb">
üìû ${borrowerData.phone}
</a><br>

<a target="_blank"
href="https://wa.me/91${borrowerData.phone}?text=Hello%20${borrowerData.name}">
üí¨ WhatsApp
</a>

</div>

<button class="btn btn-primary"
onclick="toggleCreateLoan()">+ Loan</button>
</div>`;

loadLoans();
}

/* ================= CREATE LOAN ================= */

window.toggleCreateLoan=()=>{

if(createLoanSection.innerHTML){
createLoanSection.innerHTML="";return;
}

createLoanSection.innerHTML=`
<div class="card">
<input id="principal" placeholder="Principal">
<input id="interest" placeholder="Interest %">
<input id="count" placeholder="Installments Count">
<select id="interval">
<option value="7">7 Days</option>
<option value="15">15 Days</option>
<option value="30">30 Days</option>
</select>
<input type="date" id="startDate">
<button class="btn btn-success"
onclick="createLoan()">Create Loan</button>
</div>`;
};

window.createLoan=async()=>{

if(!confirm("Are you sure you want to create this loan?"))
return;

const principal=parseFloat(principal.value);
const interest=parseFloat(interest.value)||0;
const count=parseInt(count.value);
const interval=parseInt(interval.value);
const startValue=startDate.value;

if(!principal||!count||!startValue){
alert("Fill properly");return;
}

const start=new Date(startValue).getTime();
const emi=principal/count;

const loanRef=await addDoc(collection(db,"loans"),{
borrowerId,agentId:currentUserId,ownerId,
principal,interestPercent:interest,
interestAmount:(principal*interest)/100,
count,interval,startDate:start,
status:"active",createdAt:Date.now()
});

for(let i=0;i<count;i++){
await addDoc(collection(db,"installments"),{
loanId:loanRef.id,
borrowerId,agentId:currentUserId,ownerId,
number:i+1,amount:emi,
dueDate:start+((i+1)*interval*86400000),
status:"pending"
});
}

alert("Loan created");
createLoanSection.innerHTML="";
loadLoans();
};

/* ================= LOAD LOANS ================= */

async function loadLoans(){

const snap=await getDocs(query(
collection(db,"loans"),
where("borrowerId","==",borrowerId),
where("agentId","==",currentUserId)
));

let loans=[];
snap.forEach(d=>loans.push({id:d.id,...d.data()}));

renderLoans(loans);
}

/* ================= RENDER LOANS ================= */

async function renderLoans(loans){

loanContainer.innerHTML="";

if(!loans.length){
loanContainer.innerHTML="<div class='card'>No loans</div>";
return;
}

const active=loans.filter(l=>l.status==="active");
const completed=loans.filter(l=>l.status==="completed");

renderSection("Active Loans",active);
renderSection("Completed Loans",completed);
}

/* ================= LOAN SECTION ================= */

async function renderSection(title,list){

if(!list.length) return;

loanContainer.innerHTML+=
`<div class="section-heading">${title}</div>`;

for(const loan of list){

const snap=await getDocs(query(
collection(db,"installments"),
where("loanId","==",loan.id)
));

let installments=[];
snap.forEach(d=>installments.push({id:d.id,...d.data()}));

installments.sort((a,b)=>a.number-b.number);

let paid=installments.filter(i=>i.status==="completed").length;

loanContainer.innerHTML+=`
<div class="card">
<div class="loan-title">
‚Çπ${loan.principal}
</div>
<div style="font-size:13px;margin-bottom:10px">
EMIs: ${paid}/${loan.count}
</div>

${renderEmis(installments,loan.id)}
</div>`;
}
}

/* ================= EMI RENDER ================= */

function renderEmis(list,loanId){

let today=new Date();today.setHours(0,0,0,0);

let html="";

list.forEach(i=>{

let due=new Date(i.dueDate);
due.setHours(0,0,0,0);

let cls="emi-pending";
if(i.status==="completed") cls="emi-paid";
else if(due<today) cls="emi-overdue";
else if(due.getTime()===today.getTime()) cls="emi-due";

html+=`
<div class="emi-card ${cls}">
EMI ${i.number} | ‚Çπ${i.amount} |
${due.toLocaleDateString()} |
${i.status}

${
i.status==="pending"
? `<button class="btn-pay"
onclick="pay('${i.id}','${loanId}',${i.amount})">
Mark Paid</button>`
:""
}
</div>`;
});

return html;
}

/* ================= PAY ================= */

window.pay=async(id,loanId,amt)=>{

if(!confirm("Mark this EMI as Paid?")) return;

await updateDoc(doc(db,"installments",id),
{status:"completed"});

await addDoc(collection(db,"collections"),{
loanId,borrowerId,
agentId:currentUserId,
ownerId,amount:amt,
type:"installment",date:Date.now()
});

loadLoans();
};

</script>
</body>
</html>