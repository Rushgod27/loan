<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Borrower Profile</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  <button onclick="goBack()" class="back-btn">‚Üê</button>
  Borrower Profile
</div>

<div id="profileContainer"></div>

<div id="loanSection"></div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc, getDoc, updateDoc,
  collection, addDoc,
  query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


let borrowerId =
  new URLSearchParams(location.search)
  .get("id");

let currentUserId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth,async(user)=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadProfile();
});

/* ================= LOAD PROFILE ================= */

async function loadProfile(){

  const snap=
    await getDoc(doc(db,"borrowers",borrowerId));

  if(!snap.exists()){
    profileContainer.innerHTML=
    "<div class='card'>Borrower not found</div>";
    return;
  }

  const b=snap.data();

  profileContainer.innerHTML=`
  <div class="profile-card">

    <div class="profile-top">
      <div class="profile-name">
        ${b.name}
      </div>

      <div class="profile-phone">
        <a href="tel:${b.phone}">
          üìû ${b.phone}
        </a>
      </div>

      <div class="profile-whatsapp">
        <a target="_blank"
        href="https://wa.me/${b.phone}">
          üí¨ WhatsApp
        </a>
      </div>
    </div>

    <button class="create-loan-btn"
      onclick="toggleCreateLoan()">
      + Create Loan
    </button>

    <div id="createLoanBox"
         class="hidden"></div>

  </div>
  `;

  loadLoans();
}

/* ================= CREATE LOAN ================= */

window.toggleCreateLoan = ()=>{

  const box =
    document.getElementById("createLoanBox");

  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");

  box.innerHTML=`
    <div class="card">
      <input id="principalInput"
             placeholder="Principal Amount">

      <input id="interestInput"
             placeholder="Interest %">

      <input id="countInput"
             placeholder="Number of EMIs">

      <select id="intervalInput">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>

      <input type="date"
             id="startInput">

      <button onclick="createLoan()">
        Confirm Loan
      </button>
    </div>`;
};

window.createLoan = async ()=>{

  const principal=
    parseFloat(principalInput.value);

  const percent=
    parseFloat(interestInput.value);

  const count=
    parseInt(countInput.value);

  const interval=
    parseInt(intervalInput.value);

  const startValue=
    startInput.value;

  if(!principal || isNaN(percent)
     || !count || !startValue){
    alert("Fill correctly");
    return;
  }

  const start =
    new Date(startValue).getTime();

  const interestAmount =
    (principal*percent)/100;

  const installmentAmount =
    principal/count;

  const loan =
    await addDoc(collection(db,"loans"),{
      borrowerId,
      agentId:currentUserId,
      principal,
      interestPercent:percent,
      interestAmount,
      startDate:start,
      interval,
      count,
      status:"active",
      createdAt:Date.now()
    });

  for(let i=0;i<count;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loan.id,
      borrowerId,
      number:i+1,
      amount:installmentAmount,
      dueDate:start+((i+1)
        *interval*86400000),
      status:"pending"
    });
  }

  alert("Loan Created");
  loadLoans();
};

/* ================= LOAD LOANS ================= */

async function loadLoans(){

  const q=query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  );

  const snap=await getDocs(q);

  let activeHTML="";
  let completedHTML="";

  for(const d of snap.docs){

    const l=d.data();

    const instSnap=
      await getDocs(query(
        collection(db,"installments"),
        where("loanId","==",d.id)
      ));

    let total=0;
    let paid=0;

    instSnap.forEach(i=>{
      total+=i.data().amount;
      if(i.data().status==="completed")
        paid+=i.data().amount;
    });

    const percent=
      total?Math.round(
        (paid/total)*100
      ):0;

    const loanCard=`
    <div class="loan-card ${l.status}">

      <div class="loan-header">
        <div>
          <div class="loan-title">
            ‚Çπ${l.principal}
          </div>
          <div class="loan-sub">
            Started:
            ${new Date(l.startDate)
              .toLocaleDateString("en-IN")}
          </div>
        </div>

        <div>
          <button class="view-btn"
            onclick="toggleInstallments('${d.id}')">
            View
          </button>
        </div>
      </div>

      <div class="progress-wrap">
        <div class="progress-bar"
             style="width:${percent}%">
        </div>
      </div>

      <div class="inst hidden"
           id="inst-${d.id}">
      </div>

    </div>
    `;

    if(l.status==="active")
      activeHTML+=loanCard;
    else
      completedHTML+=loanCard;
  }

  loanSection.innerHTML=`
    <div class="section-title">
      Active Loans
    </div>
    ${activeHTML||"None"}

    <div class="section-title">
      Completed Loans
    </div>
    ${completedHTML||"None"}
  `;
}

/* ================= TOGGLE INSTALLMENTS ================= */

window.toggleInstallments=
async(loanId)=>{

  document.querySelectorAll(".inst")
  .forEach(el=>{
    if(el.id!==`inst-${loanId}`){
      el.classList.add("hidden");
      el.innerHTML="";
    }
  });

  const box=
    document.getElementById(
      `inst-${loanId}`);

  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  const list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  list.forEach(i=>{

    box.innerHTML+=`
      <div class="emi-row
        ${i.status==="completed"?
          "paid":""}">

        <div>
          EMI ${i.number}
          | ‚Çπ${i.amount}
          | ${new Date(
              i.dueDate)
              .toLocaleDateString()}
        </div>

        ${
          i.status==="pending"
          ? `<button
               onclick="pay('${i.id}',
               '${loanId}',
               ${i.amount})">
               Pay
             </button>`
          : `<span class="badge">
               Paid
             </span>`
        }
      </div>`;
  });
};

/* ================= PAY ================= */

window.pay=
async(id,loanId,amt)=>{

  if(!confirm("Confirm payment?"))
    return;

  await updateDoc(
    doc(db,"installments",id),
    {status:"completed"}
  );

  const snap=
    await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",loanId)
    ));

  let allDone=true;

  snap.forEach(d=>{
    if(d.data().status!=="completed")
      allDone=false;
  });

  if(allDone){
    await updateDoc(
      doc(db,"loans",loanId),
      {status:"completed"}
    );
  }

  loadLoans();
};

window.goBack =
()=>location.href="borrowers.html";

</script>

</body>
</html>