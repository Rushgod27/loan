<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/owner.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="owner-header">
  <span>Owner Dashboard ðŸ‘‘</span>
  <button id="themeToggle">ðŸŒ™</button>
</div>

<div class="container">

<!-- WELCOME HERO -->
<div class="owner-hero">
  <div>
    <div class="owner-hero-title">
      Hi <span id="ownerName">Owner</span> ðŸ‘‹
    </div>
    <div class="owner-hero-sub">
      Here's your business performance overview
    </div>
  </div>
</div>

<!-- ðŸ” INVITE CODE -->
<div class="card">
  <h3>Your Agent Invite Code</h3>
  <div id="ownerCodeBox" class="code-box">Loading...</div>
  <button onclick="regenerateCode()">Regenerate Code</button>
</div>

<!-- ðŸ‘¤ AGENT REQUESTS -->
<div class="card">
  <h3>Agent Requests</h3>
  <div id="agentRequests"></div>
</div>

<!-- FILTER -->
<div class="card">
  <h3>Filters</h3>
  <div class="filter-grid">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="agentFilter"></select>
    <button onclick="applyFilter()">Apply</button>
    <button onclick="clearFilter()">Reset</button>
  </div>
</div>

<!-- KPI -->
<div class="owner-kpi-grid">
  <div class="owner-kpi blue">
    <div class="kpi-number" id="kpiTotalLoan">0</div>
    <div class="kpi-label">Total Loan</div>
  </div>

  <div class="owner-kpi purple">
    <div class="kpi-number" id="kpiTotalCollection">0</div>
    <div class="kpi-label">Total Collection</div>
  </div>

  <div class="owner-kpi green">
    <div class="kpi-number" id="kpiOutstanding">0</div>
    <div class="kpi-label">Outstanding</div>
  </div>

  <div class="owner-kpi orange">
    <div class="kpi-number" id="kpiPercent">0%</div>
    <div class="kpi-label">Collection %</div>
  </div>

  <div class="owner-kpi teal">
    <div class="kpi-number" id="kpiYear">0</div>
    <div class="kpi-label">This Year</div>
  </div>

  <div class="owner-kpi indigo">
    <div class="kpi-number" id="kpiMonth">0</div>
    <div class="kpi-label">This Month</div>
  </div>

  <div class="owner-kpi yellow">
    <div class="kpi-number" id="kpiToday">0</div>
    <div class="kpi-label">Today</div>
  </div>

  <div class="owner-kpi red">
    <div class="kpi-number" id="kpiDue">0</div>
    <div class="kpi-label">Total Due</div>
  </div>
</div>

<!-- CHART -->
<div class="card">
  <h3>Agent Performance</h3>
  <canvas id="agentChart"></canvas>
</div>

<!-- DUE -->
<div class="card">
  <h3>Due Today</h3>
  <div id="dueToday"></div>
</div>

<!-- OVERDUE -->
<div class="card">
  <h3>Overdue</h3>
  <div id="overdue"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, query, where, getDocs,
onSnapshot, updateDoc, deleteDoc,
doc, getDoc, serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;
let ownerName="";
let agentsMap={};
let chart;

/* AUTH */
onAuthStateChanged(auth, async(user)=>{
 if(!user){ location.href="index.html"; return; }

 const snap = await getDoc(doc(db,"users",user.uid));
 if(!snap.exists() || snap.data().role!=="owner"){
   await signOut(auth);
   location.href="index.html";
   return;
 }

 ownerId = user.uid;
 ownerName = snap.data().name || user.email.split("@")[0] || "Owner";
 document.getElementById("ownerName").innerText = ownerName;

 await loadInviteCode();
 listenAgentRequests();
 await loadAgents();
 setupRealtimeAnalytics();
});

/* LOGOUT */
window.logoutUser = async()=>{
 await signOut(auth);
 sessionStorage.setItem("justLoggedOut", "true");
 window.location.replace("index.html");
};

/* INVITE SYSTEM */
async function loadInviteCode(){
 const ref=doc(db,"users",ownerId);
 const snap=await getDoc(ref);
 let code=snap.data().inviteCode;
 if(!code){
   code="OWN"+Math.floor(100000+Math.random()*900000);
   await updateDoc(ref,{inviteCode:code});
 }
 ownerCodeBox.innerText=code;
}

window.regenerateCode = async()=>{
 const code="OWN"+Math.floor(100000+Math.random()*900000);
 await updateDoc(doc(db,"users",ownerId),{inviteCode:code});
 ownerCodeBox.innerText=code;
};

/* AGENT REQUESTS REALTIME */
function listenAgentRequests(){
 const q=query(collection(db,"users"),
  where("role","==","pending"),
  where("requestedRole","==","agent"),
  where("requestedTo","==",ownerId)
 );

 onSnapshot(q,snap=>{
   agentRequests.innerHTML="";
   if(snap.empty){
     agentRequests.innerHTML="<p>No agent requests</p>";
     return;
   }

   snap.forEach(d=>{
     const data=d.data();
     agentRequests.innerHTML+=`
     <div class="card-row">
       <strong>${data.name}</strong><br>
       ${data.email}<br><br>
       <button onclick="approveAgent('${d.id}')">Approve</button>
       <button onclick="rejectAgent('${d.id}')">Reject</button>
     </div>`;
   });
 });
}

window.approveAgent=async(id)=>{
 await updateDoc(doc(db,"users",id),{
   role:"agent",
   approvedBy:ownerId,
   approvedAt:serverTimestamp(),
   requestedRole:deleteField(),
   requestedTo:deleteField()
 });
};

window.rejectAgent=async(id)=>{
 await deleteDoc(doc(db,"users",id));
};

/* LOAD AGENTS */
async function loadAgents(){
 const snap=await getDocs(query(collection(db,"users"),
   where("role","==","agent"),
   where("approvedBy","==",ownerId)
 ));
 agentFilter.innerHTML=`<option value="all">All Agents</option>`;
 snap.forEach(d=>{
   agentsMap[d.id]=d.data().name;
   agentFilter.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
 });
}

/* REALTIME DATA */
function setupRealtimeAnalytics(){
 onSnapshot(query(collection(db,"loans"),
   where("ownerId","==",ownerId)),()=>processData());
 onSnapshot(query(collection(db,"collections"),
   where("ownerId","==",ownerId)),()=>processData());
 onSnapshot(query(collection(db,"installments"),
   where("ownerId","==",ownerId)),()=>processData());
}

window.applyFilter=()=>processData();
window.clearFilter=()=>{
 startDate.value="";
 endDate.value="";
 agentFilter.value="all";
 processData();
};

/* PROCESS */
async function processData(){

 const start = startDate.value;
 const end = endDate.value;
 const agentId = agentFilter.value || "all";

 const startTime = start ? new Date(start).getTime() : null;
 const endTime = end ? new Date(end).setHours(23,59,59,999) : null;

 const loanSnap = await getDocs(query(
   collection(db,"loans"),
   where("ownerId","==",ownerId)
 ));

 let totalLoan = 0;

 loanSnap.forEach(d=>{
   const data = d.data();
   if(agentId!=="all" && data.agentId!==agentId) return;
   if(startTime && data.createdAt < startTime) return;
   if(endTime && data.createdAt > endTime) return;
   totalLoan += data.principal || 0;
 });

 const colSnap = await getDocs(query(
   collection(db,"collections"),
   where("ownerId","==",ownerId)
 ));

 let totalCollection = 0;
 let yearCollection = 0;
 let monthCollection = 0;
 let todayCollection = 0;
 let agentPerf = {};

 const now = new Date();
 const year = now.getFullYear();
 const month = now.getMonth();
 const today = new Date().setHours(0,0,0,0);

 colSnap.forEach(d=>{
   const data=d.data();
   if(agentId!=="all" && data.agentId!==agentId) return;
   if(startTime && data.date<startTime) return;
   if(endTime && data.date>endTime) return;

   totalCollection += data.amount || 0;

   const dateObj = new Date(data.date);

   if(dateObj.getFullYear()===year) yearCollection+=data.amount;
   if(dateObj.getMonth()===month) monthCollection+=data.amount;
   if(new Date(data.date).setHours(0,0,0,0)===today)
      todayCollection+=data.amount;

   if(!agentPerf[data.agentId]) agentPerf[data.agentId]=0;
   agentPerf[data.agentId]+=data.amount;
 });

 const outstanding = totalLoan - totalCollection;
 const percent = totalLoan ? ((totalCollection/totalLoan)*100).toFixed(1) : 0;

 // ===============================
// FULL DUE + OVERDUE + TOTAL DUE
// ===============================

const instSnap = await getDocs(query(
  collection(db,"installments"),
  where("ownerId","==",ownerId),
  where("status","==","pending")
));

const borrowersSnap = await getDocs(query(
  collection(db,"borrowers"),
  where("ownerId","==",ownerId)
));

let borrowersMap = {};
borrowersSnap.forEach(d=>{
  borrowersMap[d.id] = d.data().name;
});

let dueCount = 0;

dueToday.innerHTML = "";
overdue.innerHTML = "";

const todayDate = new Date();
todayDate.setHours(0,0,0,0);

instSnap.forEach(d=>{

  const data = d.data();
  if(agentId!=="all" && data.agentId!==agentId) return;

  dueCount += data.amount || 0;

  const dueDate = new Date(data.dueDate);
  dueDate.setHours(0,0,0,0);

  const borrowerName = borrowersMap[data.borrowerId] || "Unknown";
  const agentNameDisplay = agentsMap[data.agentId] || "Agent";

  const cardHTML = `
    <div class="card-row">
      <strong>${borrowerName}</strong><br>
      Amount: â‚¹${data.amount}<br>
      Due Date: ${new Date(data.dueDate).toLocaleDateString()}<br>
      Agent: ${agentNameDisplay}
    </div>
  `;

  if(dueDate.getTime() === todayDate.getTime()){
    dueToday.innerHTML += cardHTML;
  }

  if(dueDate < todayDate){
    overdue.innerHTML += cardHTML;
  }

});

// EMPTY STATES
if(dueToday.innerHTML===""){
  dueToday.innerHTML = "<p>No dues today</p>";
}

if(overdue.innerHTML===""){
  overdue.innerHTML = "<p>No overdue payments</p>";
}

 // UPDATE UI
 kpiTotalLoan.innerText = totalLoan;
 kpiTotalCollection.innerText = totalCollection;
 kpiOutstanding.innerText = outstanding;
 kpiPercent.innerText = percent + "%";
 kpiYear.innerText = yearCollection;
 kpiMonth.innerText = monthCollection;
 kpiToday.innerText = todayCollection;
 kpiDue.innerText = dueCount;

 // CHART
 if(chart) chart.destroy();

 chart=new Chart(agentChart,{
   type:"bar",
   data:{
     labels:Object.keys(agentPerf).map(a=>agentsMap[a]||"Agent"),
     datasets:[{
       label:"Collection",
       data:Object.values(agentPerf)
     }]
   }
 });

}

</script>
</body>
</html>