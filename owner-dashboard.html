<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">Owner Panel</div>

<div class="container">

  <div class="card">
    <h3>Add New Agent</h3>

    <input id="agentName"
      placeholder="Agent Name">

    <input id="agentEmail"
      placeholder="Agent Email">

    <button class="btn btn-primary"
      onclick="addAgent()">
      Add Agent
    </button>
  </div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  addDoc,
  query,
  where,
  getDocs
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentOwnerUid = null;

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentOwnerUid = user.uid;
});

window.addAgent = async () => {

  const name  =
    document.getElementById("agentName")
    .value.trim();

  const email =
    document.getElementById("agentEmail")
    .value.trim()
    .toLowerCase();

  if(!name || !email){
    alert("Enter name and email");
    return;
  }

  const q = query(
    collection(db,"users"),
    where("email","==",email)
  );

  const snap = await getDocs(q);

  if(!snap.empty){
    alert("Agent already registered.");
    return;
  }

  await addDoc(collection(db,"users"),{
    name,
    email,
    role:"agent",
    ownerId: currentOwnerUid,
    status:"active",
    uid:null,
    createdAt: Date.now()
  });

  alert("Agent added. Agent must login using email link.");

  document.getElementById("agentName").value="";
  document.getElementById("agentEmail").value="";
};

</script>
</body>
</html>