<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  Owner Panel
</div>

<div class="nav">
  <div class="active">Dashboard</div>
  <div onclick="logoutUser()">Logout</div>
</div>

<div class="container">

  <!-- ADD AGENT SECTION -->
  <div class="card">

    <div class="card-row">
      <div class="card-title">Add New Agent</div>
      <button class="btn btn-primary"
        onclick="toggleAddAgent()">+ Add</button>
    </div>

    <div id="addAgentSection"
         class="hidden"
         style="margin-top:15px;">

      <input id="agentName"
        placeholder="Agent Name">

      <input id="agentEmail"
        placeholder="Agent Email">

      <input id="tempPassword"
        placeholder="Temporary Password"
        type="password">

      <button class="btn btn-success"
        onclick="createAgent()">
        Create Agent
      </button>

    </div>

  </div>

  <!-- AGENT LIST -->
  <div id="agentList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut,
  createUserWithEmailAndPassword,
  getAuth
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  doc,
  setDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
  initializeApp,
  deleteApp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

let currentOwner=null;

/* ================= AUTH CHECK ================= */

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentOwner=user.uid;
  loadAgents();
});

/* ================= LOGOUT ================= */

window.logoutUser = async ()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= TOGGLE FORM ================= */

window.toggleAddAgent = ()=>{
  addAgentSection.classList.toggle("hidden");
};

/* ================= CREATE AGENT (PRO MODE) ================= */

window.createAgent = async ()=>{

  const name = agentName.value.trim();
  const email = agentEmail.value.trim();
  const password = tempPassword.value.trim();

  if(!name || !email || !password){
    alert("Fill all fields");
    return;
  }

  if(password.length < 6){
    alert("Password minimum 6 characters");
    return;
  }

  try{

    /* ===== Secondary App ===== */
    const secondaryApp = initializeApp({
      apiKey: auth.app.options.apiKey,
      authDomain: auth.app.options.authDomain,
      projectId: auth.app.options.projectId
    }, "Secondary");

    const secondaryAuth = getAuth(secondaryApp);

    /* ===== Create Auth User ===== */
    const userCredential =
      await createUserWithEmailAndPassword(
        secondaryAuth,
        email,
        password
      );

    const newUser = userCredential.user;

    /* ===== Firestore Role ===== */
    await setDoc(doc(db,"users",newUser.uid),{
      name: name,
      email: email,
      role: "agent",
      ownerId: currentOwner,
      mustChangePassword: true,
      createdAt: Date.now()
    });

    /* ===== Delete Secondary App ===== */
    await deleteApp(secondaryApp);

    alert("Agent created successfully");

    agentName.value="";
    agentEmail.value="";
    tempPassword.value="";
    addAgentSection.classList.add("hidden");

    loadAgents();

  }catch(err){
    alert("Error: " + err.message);
  }

};

/* ================= LOAD AGENTS ================= */

async function loadAgents(){

  const snap = await getDocs(query(
    collection(db,"users"),
    where("ownerId","==",currentOwner)
  ));

  agentList.innerHTML="";

  if(snap.empty){
    agentList.innerHTML =
      "<div class='card'>No agents found</div>";
    return;
  }

  snap.forEach(docData=>{
    const data = docData.data();

    agentList.innerHTML+=`
      <div class="card">
        <div class="card-row">
          <div class="card-details">
            <div class="card-title">${data.name}</div>
            <div class="card-sub">${data.email}</div>
          </div>
          <div class="badge active-badge">
            Agent
          </div>
        </div>
      </div>
    `;
  });
}

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut,
  createUserWithEmailAndPassword,
  getAuth
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  doc,
  setDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
  initializeApp,
  deleteApp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

let currentOwner=null;

/* ================= AUTH CHECK ================= */

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentOwner=user.uid;
  loadAgents();
});

/* ================= LOGOUT ================= */

window.logoutUser = async ()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= TOGGLE FORM ================= */

window.toggleAddAgent = ()=>{
  addAgentSection.classList.toggle("hidden");
};

/* ================= CREATE AGENT (PRO MODE) ================= */

window.createAgent = async ()=>{

  const name = agentName.value.trim();
  const email = agentEmail.value.trim();
  const password = tempPassword.value.trim();

  if(!name || !email || !password){
    alert("Fill all fields");
    return;
  }

  if(password.length < 6){
    alert("Password minimum 6 characters");
    return;
  }

  try{

    /* ===== Secondary App ===== */
    const secondaryApp = initializeApp({
      apiKey: auth.app.options.apiKey,
      authDomain: auth.app.options.authDomain,
      projectId: auth.app.options.projectId
    }, "Secondary");

    const secondaryAuth = getAuth(secondaryApp);

    /* ===== Create Auth User ===== */
    const userCredential =
      await createUserWithEmailAndPassword(
        secondaryAuth,
        email,
        password
      );

    const newUser = userCredential.user;

    /* ===== Firestore Role ===== */
    await setDoc(doc(db,"users",newUser.uid),{
      name: name,
      email: email,
      role: "agent",
      ownerId: currentOwner,
      mustChangePassword: true,
      createdAt: Date.now()
    });

    /* ===== Delete Secondary App ===== */
    await deleteApp(secondaryApp);

    alert("Agent created successfully");

    agentName.value="";
    agentEmail.value="";
    tempPassword.value="";
    addAgentSection.classList.add("hidden");

    loadAgents();

  }catch(err){
    alert("Error: " + err.message);
  }

};

/* ================= LOAD AGENTS ================= */

async function loadAgents(){

  const snap = await getDocs(query(
    collection(db,"users"),
    where("ownerId","==",currentOwner)
  ));

  agentList.innerHTML="";

  if(snap.empty){
    agentList.innerHTML =
      "<div class='card'>No agents found</div>";
    return;
  }

  snap.forEach(docData=>{
    const data = docData.data();

    agentList.innerHTML+=`
      <div class="card">
        <div class="card-row">
          <div class="card-details">
            <div class="card-title">${data.name}</div>
            <div class="card-sub">${data.email}</div>
          </div>
          <div class="badge active-badge">
            Agent
          </div>
        </div>
      </div>
    `;
  });
}

</script>


  

</body>
</html>
