<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="header">Owner Dashboard</div>

<div class="container">

<!-- ðŸ” INVITE CODE -->
<div class="card">
  <h3>Your Agent Invite Code</h3>
  <div id="ownerCodeBox" class="code-box">Loading...</div>
  <button class="primary" onclick="regenerateCode()">Regenerate Code</button>
</div>

<!-- AGENT REQUESTS -->
<div class="card">
  <h3>Agent Requests</h3>
  <div id="agentRequests"></div>
</div>

<!-- FILTERS -->
<div class="card">
  <h3>Filters</h3>
  <div class="grid">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="agentFilter"></select>
    <button onclick="applyFilter()">Apply</button>
  </div>
</div>

<!-- OVERVIEW -->
<div class="card">
  <h3>Overview</h3>
  <div>Total Loan: â‚¹ <span class="stat" id="totalLoan">0</span></div>
  <div>Total Collection: â‚¹ <span class="stat" id="totalCollection">0</span></div>
  <div>Outstanding: â‚¹ <span class="stat" id="outstanding">0</span></div>
  <div>Top Agent: <span class="stat" id="topAgent">-</span></div>
</div>

<!-- CHART -->
<div class="card">
  <h3>Agent Performance</h3>
  <canvas id="agentChart"></canvas>
</div>

<!-- DUE -->
<div class="card">
  <h3>Due Today</h3>
  <div id="dueToday"></div>
</div>

<!-- OVERDUE -->
<div class="card">
  <h3>Overdue</h3>
  <div id="overdue"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, query, where, getDocs,
  onSnapshot, updateDoc, deleteDoc,
  doc, getDoc, serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;
let agentsMap={};
let chart;

/* ================= AUTH ================= */

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="index.html"; return; }

  const snap = await getDoc(doc(db,"users",user.uid));

  if(!snap.exists() || snap.data().role!=="owner"){
    await signOut(auth);
    location.href="index.html";
    return;
  }

  ownerId = user.uid;

  await loadInviteCode();
  listenAgentRequests();
  await loadAgents();
  setupRealtimeAnalytics();
});

window.logoutUser = async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= INVITE CODE SYSTEM ================= */

async function loadInviteCode(){

  const ref=doc(db,"users",ownerId);
  const snap=await getDoc(ref);

  let code=snap.data().inviteCode;

  if(!code){
    code=generateCode("OWN");
    await updateDoc(ref,{inviteCode:code});
  }

  document.getElementById("ownerCodeBox").innerText=code;
}

window.regenerateCode = async()=>{

  const newCode=generateCode("OWN");

  await updateDoc(doc(db,"users",ownerId),{
    inviteCode:newCode
  });

  document.getElementById("ownerCodeBox").innerText=newCode;
};

function generateCode(prefix){
  const random=Math.floor(100000+Math.random()*900000);
  return prefix+random;
}

/* ================= AGENT REQUESTS ================= */

function listenAgentRequests(){

  const q=query(
    collection(db,"users"),
    where("role","==","pending"),
    where("requestedRole","==","agent"),
    where("requestedTo","==",ownerId)
  );

  onSnapshot(q,(snap)=>{
    const box=document.getElementById("agentRequests");
    box.innerHTML="";

    if(snap.empty){
      box.innerHTML="<p>No agent requests</p>";
      return;
    }

    snap.forEach(d=>{
      const data=d.data();

      box.innerHTML+=`
      <div class="card-row">
        <strong>${data.name}</strong><br>
        ${data.email}
        <br><br>
        <button class="approve"
          onclick="approveAgent('${d.id}')">
          Approve
        </button>
        <button class="reject"
          onclick="rejectAgent('${d.id}')">
          Reject
        </button>
      </div>`;
    });
  });
}

window.approveAgent=async(id)=>{
  await updateDoc(doc(db,"users",id),{
    role:"agent",
    approvedBy:ownerId,
    approvedAt:serverTimestamp(),
    requestedRole:deleteField(),
    requestedTo:deleteField()
  });
};

window.rejectAgent=async(id)=>{
  if(!confirm("Reject this agent request?"))return;
  await deleteDoc(doc(db,"users",id));
};

/* ================= LOAD AGENTS ================= */

async function loadAgents(){

  const snap=await getDocs(query(
    collection(db,"users"),
    where("role","==","agent"),
    where("approvedBy","==",ownerId)
  ));

  const select=document.getElementById("agentFilter");
  select.innerHTML=`<option value="all">All Agents</option>`;
  agentsMap={};

  snap.forEach(d=>{
    agentsMap[d.id]=d.data().name;
    select.innerHTML+=
      `<option value="${d.id}">${d.data().name}</option>`;
  });
}

/* ================= REALTIME ANALYTICS ================= */

function setupRealtimeAnalytics(){

  onSnapshot(query(collection(db,"loans"),
  where("ownerId","==",ownerId)),()=>processData());

  onSnapshot(query(collection(db,"collections"),
  where("ownerId","==",ownerId)),()=>processData());

  onSnapshot(query(collection(db,"installments"),
  where("ownerId","==",ownerId)),()=>processData());
}

window.applyFilter=()=>processData();

/* ================= PROCESS DATA ================= */

async function processData(){

  const start=document.getElementById("startDate").value;
  const end=document.getElementById("endDate").value;
  const agentFilter=document.getElementById("agentFilter").value||"all";

  const startTime=start?new Date(start).getTime():null;
  const endTime=end?new Date(end).setHours(23,59,59,999):null;

  const loanSnap=await getDocs(query(
    collection(db,"loans"),
    where("ownerId","==",ownerId)
  ));

  let totalLoan=0;

  loanSnap.forEach(d=>{
    const data=d.data();
    if(agentFilter!=="all" && data.agentId!==agentFilter) return;
    if(startTime && data.createdAt<startTime) return;
    if(endTime && data.createdAt>endTime) return;
    totalLoan+=data.principal||0;
  });

  const colSnap=await getDocs(query(
    collection(db,"collections"),
    where("ownerId","==",ownerId)
  ));

  let totalCollection=0;
  let agentPerf={};

  colSnap.forEach(d=>{
    const data=d.data();
    if(agentFilter!=="all" && data.agentId!==agentFilter) return;
    if(startTime && data.date<startTime) return;
    if(endTime && data.date>endTime) return;

    totalCollection+=data.amount||0;

    if(!agentPerf[data.agentId]) agentPerf[data.agentId]=0;
    agentPerf[data.agentId]+=data.amount;
  });

  document.getElementById("totalLoan").innerText=totalLoan;
  document.getElementById("totalCollection").innerText=totalCollection;
  document.getElementById("outstanding")
    .innerText=totalLoan-totalCollection;

  let top="-",max=0;
  Object.keys(agentPerf).forEach(a=>{
    if(agentPerf[a]>max){
      max=agentPerf[a];
      top=agentsMap[a]||"-";
    }
  });

  document.getElementById("topAgent").innerText=top;

  if(chart) chart.destroy();

  chart=new Chart(document.getElementById("agentChart"),{
    type:"bar",
    data:{
      labels:Object.keys(agentPerf)
        .map(a=>agentsMap[a]||"Agent"),
      datasets:[{
        label:"Collection",
        data:Object.values(agentPerf)
      }]
    }
  });

  /* DUE + OVERDUE */

  const instSnap=await getDocs(query(
    collection(db,"installments"),
    where("ownerId","==",ownerId),
    where("status","==","pending")
  ));

  const today=new Date();
  today.setHours(0,0,0,0);

  dueToday.innerHTML="";
  overdue.innerHTML="";

  instSnap.forEach(d=>{
    const data=d.data();
    const dueDate=new Date(data.dueDate);
    dueDate.setHours(0,0,0,0);

    if(agentFilter!=="all" && data.agentId!==agentFilter) return;

    if(dueDate.getTime()===today.getTime()){
      dueToday.innerHTML+=
        `<div class="success-box">â‚¹${data.amount}</div>`;
    }

    if(dueDate<today){
      overdue.innerHTML+=
        `<div class="alert-box">â‚¹${data.amount}</div>`;
    }
  });

}

if("serviceWorker" in navigator){
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/sw.js")
      .then(() => console.log("PWA Ready"))
      .catch(err => console.log("SW Error", err));
  });
}
</script>
</body>
</html>