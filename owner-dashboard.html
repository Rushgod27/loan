<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/owner.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="header owner-header">
  <span>Owner Dashboard</span>
  <button id="themeToggle" onclick="toggleTheme()">üåô</button>
</div>

<div class="container">

<!-- INVITE CODE -->
<div class="card">
  <h3>Your Agent Invite Code</h3>
  <div id="ownerCodeBox" class="code-box">Loading...</div>
  <button class="primary" onclick="regenerateCode()">Regenerate Code</button>
</div>

<!-- AGENT REQUESTS -->
<div class="card">
  <h3>Agent Requests</h3>
  <div id="agentRequests"></div>
</div>

<!-- FILTERS -->
<div class="card">
  <h3>Filters</h3>
  <div class="grid">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="agentFilter"></select>
    <button onclick="applyFilter()">Apply</button>
    <button onclick="clearFilter()">Reset</button>
  </div>
</div>

<!-- KPI SECTION -->
<div class="card">
<h3>Performance KPIs</h3>
<div class="grid">

<div>Total Loan<br>‚Çπ <span class="stat" id="kpiTotalLoan">0</span></div>
<div>Total Collection<br>‚Çπ <span class="stat" id="kpiTotalCollection">0</span></div>
<div>Outstanding<br>‚Çπ <span class="stat" id="kpiOutstanding">0</span></div>
<div>Collection %<br><span class="stat" id="kpiPercent">0%</span></div>

<div>This Year<br>‚Çπ <span class="stat" id="kpiYear">0</span></div>
<div>This Month<br>‚Çπ <span class="stat" id="kpiMonth">0</span></div>
<div>Today<br>‚Çπ <span class="stat" id="kpiToday">0</span></div>
<div>Total Due<br>‚Çπ <span class="stat" id="kpiDue">0</span></div>

<div>Top Collector<br><span class="stat" id="kpiTopAgent">-</span></div>
<div>Total Agents<br><span class="stat" id="kpiTotalAgents">0</span></div>
<div>Total Borrowers<br><span class="stat" id="kpiBorrowers">0</span></div>

</div>
</div>

<!-- CHART -->
<div class="card">
  <h3>Agent Performance</h3>
  <canvas id="agentChart"></canvas>
</div>

<!-- AGENT DETAILS -->
<div class="card">
  <h3>Agents & Borrowers</h3>
  <div id="agentDetailsSection"></div>
</div>

<!-- DUE -->
<div class="card">
  <h3>Due Today</h3>
  <div id="dueToday"></div>
</div>

<!-- OVERDUE -->
<div class="card">
  <h3>Overdue</h3>
  <div id="overdue"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, query, where, getDocs,
onSnapshot, updateDoc, deleteDoc,
doc, getDoc, serverTimestamp, deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;
let agentsMap={};
let chart;

/* AUTH */
onAuthStateChanged(auth, async(user)=>{
if(!user){ location.href="index.html"; return; }

const snap = await getDoc(doc(db,"users",user.uid));
if(!snap.exists() || snap.data().role!=="owner"){
await signOut(auth);
location.href="index.html";
return;
}

ownerId=user.uid;
await loadInviteCode();
listenAgentRequests();
await loadAgents();
setupRealtimeAnalytics();
});

/* LOGOUT */
window.logoutUser = async()=>{
await signOut(auth);
window.location.replace("index.html");
};

/* INVITE CODE */
async function loadInviteCode(){
const ref=doc(db,"users",ownerId);
const snap=await getDoc(ref);
let code=snap.data().inviteCode;
if(!code){
code="OWN"+Math.floor(100000+Math.random()*900000);
await updateDoc(ref,{inviteCode:code});
}
ownerCodeBox.innerText=code;
}

window.regenerateCode=async()=>{
const code="OWN"+Math.floor(100000+Math.random()*900000);
await updateDoc(doc(db,"users",ownerId),{inviteCode:code});
ownerCodeBox.innerText=code;
};

/* AGENT REQUESTS */
function listenAgentRequests(){
const q=query(collection(db,"users"),
where("role","==","pending"),
where("requestedRole","==","agent"),
where("requestedTo","==",ownerId));

onSnapshot(q,snap=>{
agentRequests.innerHTML="";
if(snap.empty){agentRequests.innerHTML="<p>No agent requests</p>";return;}
snap.forEach(d=>{
const data=d.data();
agentRequests.innerHTML+=`
<div class="card-row">
<strong>${data.name}</strong><br>${data.email}<br><br>
<button onclick="approveAgent('${d.id}')">Approve</button>
<button onclick="rejectAgent('${d.id}')">Reject</button>
</div>`;
});
});
}

window.approveAgent=async(id)=>{
await updateDoc(doc(db,"users",id),{
role:"agent",
approvedBy:ownerId,
approvedAt:serverTimestamp(),
requestedRole:deleteField(),
requestedTo:deleteField()
});
};

window.rejectAgent=async(id)=>{
await deleteDoc(doc(db,"users",id));
};

/* LOAD AGENTS */
async function loadAgents(){
const snap=await getDocs(query(collection(db,"users"),
where("role","==","agent"),
where("approvedBy","==",ownerId)));

agentFilter.innerHTML=`<option value="all">All Agents</option>`;
agentsMap={};

snap.forEach(d=>{
agentsMap[d.id]=d.data().name;
agentFilter.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
});
}

/* REALTIME */
function setupRealtimeAnalytics(){
onSnapshot(query(collection(db,"loans"),
where("ownerId","==",ownerId)),()=>processData());
onSnapshot(query(collection(db,"collections"),
where("ownerId","==",ownerId)),()=>processData());
onSnapshot(query(collection(db,"installments"),
where("ownerId","==",ownerId)),()=>processData());
}

/* FILTER */
window.applyFilter=()=>processData();
window.clearFilter=()=>{
startDate.value="";
endDate.value="";
agentFilter.value="all";
processData();
};

/* PROCESS DATA */
async function processData(){

const start=startDate.value;
const end=endDate.value;
const agent=agentFilter.value||"all";

const startTime=start?new Date(start+"T00:00:00").getTime():null;
const endTime=end?new Date(end+"T23:59:59").getTime():null;

const now=new Date();
const yearStart=new Date(now.getFullYear(),0,1).getTime();
const monthStart=new Date(now.getFullYear(),now.getMonth(),1).getTime();
const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();

let totalLoan=0,totalCollection=0;
let yearCollection=0,monthCollection=0,todayCollection=0;
let totalDue=0;
let agentPerf={};
let borrowersSet=new Set();

/* LOANS */
const loanSnap=await getDocs(query(collection(db,"loans"),
where("ownerId","==",ownerId)));

loanSnap.forEach(d=>{
const data=d.data();
if(agent!=="all"&&data.agentId!==agent)return;
if(startTime&&data.createdAt<startTime)return;
if(endTime&&data.createdAt>endTime)return;
totalLoan+=data.principal||0;
});

/* COLLECTIONS */
const colSnap=await getDocs(query(collection(db,"collections"),
where("ownerId","==",ownerId)));

colSnap.forEach(d=>{
const data=d.data();
if(agent!=="all"&&data.agentId!==agent)return;
if(startTime&&data.date<startTime)return;
if(endTime&&data.date>endTime)return;

totalCollection+=data.amount||0;

if(data.date>=yearStart)yearCollection+=data.amount||0;
if(data.date>=monthStart)monthCollection+=data.amount||0;
if(data.date>=todayStart)todayCollection+=data.amount||0;

if(!agentPerf[data.agentId])agentPerf[data.agentId]=0;
agentPerf[data.agentId]+=data.amount||0;
});

/* INSTALLMENTS */
const instSnap=await getDocs(query(collection(db,"installments"),
where("ownerId","==",ownerId),
where("status","==","pending")));

const today=new Date();
today.setHours(0,0,0,0);

dueToday.innerHTML="";
overdue.innerHTML="";

instSnap.forEach(d=>{
const data=d.data();
if(agent!=="all"&&data.agentId!==agent)return;

if(startTime&&data.dueDate<startTime)return;
if(endTime&&data.dueDate>endTime)return;

const dueDate=new Date(data.dueDate);
dueDate.setHours(0,0,0,0);

if(dueDate>=today)totalDue+=data.amount||0;

if(dueDate.getTime()===today.getTime()){
dueToday.innerHTML+=`<div class="success-box">‚Çπ${data.amount}</div>`;
}
if(dueDate<today){
overdue.innerHTML+=`<div class="alert-box">‚Çπ${data.amount}</div>`;
}
});

/* BORROWERS */
const borrowerSnap=await getDocs(query(collection(db,"borrowers"),
where("ownerId","==",ownerId)));

const agentBorrowers={};
borrowerSnap.forEach(d=>{
const data=d.data();
if(agent!=="all"&&data.agentId!==agent)return;
borrowersSet.add(d.id);
if(!agentBorrowers[data.agentId])agentBorrowers[data.agentId]=[];
agentBorrowers[data.agentId].push(data.name);
});

/* UPDATE KPIs */
const outstanding=totalLoan-totalCollection;
const percent=totalLoan?((totalCollection/totalLoan)*100).toFixed(1):0;

kpiTotalLoan.innerText=totalLoan;
kpiTotalCollection.innerText=totalCollection;
kpiOutstanding.innerText=outstanding;
kpiPercent.innerText=percent+"%";

kpiYear.innerText=yearCollection;
kpiMonth.innerText=monthCollection;
kpiToday.innerText=todayCollection;
kpiDue.innerText=totalDue;

let top="-",max=0;
Object.keys(agentPerf).forEach(a=>{
if(agentPerf[a]>max){max=agentPerf[a];top=agentsMap[a]||"-";}
});

kpiTopAgent.innerText=top;
kpiTotalAgents.innerText=Object.keys(agentsMap).length;
kpiBorrowers.innerText=borrowersSet.size;

/* CHART */
if(chart)chart.destroy();
chart=new Chart(agentChart,{
type:"bar",
data:{
labels:Object.keys(agentPerf).map(a=>agentsMap[a]||"Agent"),
datasets:[{label:"Collection",data:Object.values(agentPerf)}]
}
});

/* AGENT DETAILS */
agentDetailsSection.innerHTML="";
Object.keys(agentBorrowers).forEach(a=>{
agentDetailsSection.innerHTML+=`
<div class="card-row">
<strong>${agentsMap[a]||"Agent"}</strong><br>
Borrowers: ${agentBorrowers[a].join(", ")}
</div>`;
});

}

/* DARK MODE */
window.toggleTheme = function(){
  document.body.classList.toggle("owner-dark");
  const isDark = document.body.classList.contains("owner-dark");
  localStorage.setItem("ownerTheme", isDark ? "dark" : "light");
  document.getElementById("themeToggle").innerText = isDark ? "‚òÄÔ∏è" : "üåô";
};

window.addEventListener("DOMContentLoaded", function(){
  const saved = localStorage.getItem("ownerTheme");
  if(saved === "dark"){
    document.body.classList.add("owner-dark");
    document.getElementById("themeToggle").innerText="‚òÄÔ∏è";
  }
});

</script>
</body>
</html>