<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css?v=15">
</head>
<body>

<div class="header">
  Owner Panel
</div>

<div class="nav">
  <div class="active">Dashboard</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container" id="content"></div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  signOut,
  onAuthStateChanged,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  addDoc,
  doc,
  updateDoc,
  getDoc,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  ownerId=user.uid;
  loadDashboard();
});

/* ================= LOGOUT ================= */

window.logout = async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= LOAD DASHBOARD ================= */

async function loadDashboard(){

  let totalAgents=0;
  let activeAgents=0;
  let totalBorrowers=0;
  let activeLoans=0;
  let todayCollection=0;

  const today = new Date();
  today.setHours(0,0,0,0);

  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate()+1);

  /* ================= AGENTS ================= */

  const agentSnap = await getDocs(query(
    collection(db,"users"),
    where("role","==","agent"),
    where("ownerId","==",ownerId)
  ));

  totalAgents = agentSnap.size;

  const agentMap={};

  agentSnap.forEach(d=>{
    agentMap[d.id]=d.data();
    if(d.data().status==="active"){
      activeAgents++;
    }
  });

  /* ================= BORROWERS ================= */

  const borrowerSnap = await getDocs(collection(db,"borrowers"));

  borrowerSnap.forEach(d=>{
    if(agentMap[d.data().agentId]){
      totalBorrowers++;
    }
  });

  /* ================= LOANS ================= */

  const loanSnap = await getDocs(collection(db,"loans"));

  loanSnap.forEach(d=>{
    const data=d.data();
    if(agentMap[data.agentId] && data.status==="active"){
      activeLoans++;
    }
  });

  /* ================= COLLECTION ================= */

  const colSnap = await getDocs(collection(db,"collections"));

  colSnap.forEach(d=>{
    const data=d.data();
    if(agentMap[data.agentId]){
      const date=new Date(data.date);
      if(date>=today && date<tomorrow){
        todayCollection+=data.amount;
      }
    }
  });

  /* ================= RENDER ================= */

  content.innerHTML=`

  <div class="card">
    <h3>ðŸ“Š Overview</h3>

    <div class="card-row">
      <div class="card-details">Total Agents</div>
      <div><b>${totalAgents}</b></div>
    </div>

    <div class="card-row">
      <div class="card-details">Active Agents</div>
      <div><b>${activeAgents}</b></div>
    </div>

    <div class="card-row">
      <div class="card-details">Total Borrowers</div>
      <div><b>${totalBorrowers}</b></div>
    </div>

    <div class="card-row">
      <div class="card-details">Active Loans</div>
      <div><b>${activeLoans}</b></div>
    </div>

    <div class="card-row">
      <div class="card-details">Today's Collection</div>
      <div><b>â‚¹${todayCollection}</b></div>
    </div>

  </div>

  <div class="card">
    <h3>âž• Add Agent</h3>

    <input id="agentName" placeholder="Agent Name">
    <input id="agentPhone" placeholder="Phone Number">
    <input id="agentEmail" placeholder="Email">
    <button class="btn btn-primary"
      onclick="addAgent()">
      Create Agent
    </button>
  </div>

  <div class="card">
    <h3>ðŸ“ˆ Agent Performance</h3>
    <div id="agentList"></div>
  </div>
  `;

  loadAgentPerformance(agentMap);
}

/* ================= ADD AGENT ================= */

window.addAgent = async ()=>{

  const name = agentName.value.trim();
  const phone = agentPhone.value.trim();
  const email = agentEmail.value.trim();

  if(!name || !phone || !email){
    alert("Fill all fields");
    return;
  }

  const tempPassword="Temp12345";

  const secondary = auth.app;
  const newUser = await createUserWithEmailAndPassword(auth,email,tempPassword);

  await setDoc(doc(db,"users",newUser.user.uid),{
    name,
    phone,
    role:"agent",
    ownerId,
    mustChangePassword:true,
    status:"active",
    createdAt:Date.now()
  });

  alert("Agent created with temporary password");

  loadDashboard();
};

/* ================= AGENT PERFORMANCE ================= */

async function loadAgentPerformance(agentMap){

  const agentListDiv = document.getElementById("agentList");
  agentListDiv.innerHTML="";

  for(const agentId in agentMap){

    const agent = agentMap[agentId];

    let agentBorrowers=0;
    let agentActiveLoans=0;

    const borrowerSnap=await getDocs(query(
      collection(db,"borrowers"),
      where("agentId","==",agentId)
    ));

    agentBorrowers = borrowerSnap.size;

    const loanSnap=await getDocs(query(
      collection(db,"loans"),
      where("agentId","==",agentId),
      where("status","==","active")
    ));

    agentActiveLoans = loanSnap.size;

    agentListDiv.innerHTML+=`
    <div class="card">
      <div class="card-row">
        <div class="card-details">
          <div class="card-title">
            ${agent.name}
          </div>
          <div class="card-sub">
            Borrowers: ${agentBorrowers} |
            Active Loans: ${agentActiveLoans}
          </div>
        </div>

        <div class="card-actions">
          <button class="btn btn-danger"
            onclick="toggleAgent('${agentId}','${agent.status}')">
            ${agent.status==="active"?"Freeze":"Unfreeze"}
          </button>
        </div>
      </div>
    </div>
    `;
  }
}

/* ================= FREEZE / UNFREEZE ================= */

window.toggleAgent = async(agentId,status)=>{

  const newStatus =
    status==="active" ? "frozen" : "active";

  await updateDoc(doc(db,"users",agentId),{
    status:newStatus
  });

  loadDashboard();
};

</script>
</body>
</html>
