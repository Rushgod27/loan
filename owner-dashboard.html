<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/owner.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="owner-header">
  <span>Owner Dashboard ğŸ‘‘</span>
  <button id="themeToggle">ğŸŒ™</button>
</div>

<div class="container">

<!-- HERO -->
<div class="owner-hero">
  <div>
    <div class="owner-hero-title">Welcome Back ğŸ‘‘</div>
    <div class="owner-hero-sub">Here's your complete performance overview</div>
  </div>
</div>

<!-- FILTER -->
<div class="card">
  <h3>Filters</h3>
  <div class="filter-grid">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="agentFilter"></select>
    <button id="applyFilterBtn">Apply</button>
    <button id="clearFilterBtn">Reset</button>
  </div>
</div>

<!-- KPI -->
<div class="owner-kpi-grid">

  <div class="owner-kpi blue">
    <div class="kpi-number" id="kpiTotalLoan">0</div>
    <div class="kpi-label">Total Loan</div>
  </div>

  <div class="owner-kpi purple">
    <div class="kpi-number" id="kpiTotalCollection">0</div>
    <div class="kpi-label">Total Collection</div>
  </div>

  <div class="owner-kpi green">
    <div class="kpi-number" id="kpiOutstanding">0</div>
    <div class="kpi-label">Outstanding</div>
  </div>

  <div class="owner-kpi orange">
    <div class="kpi-number" id="kpiPercent">0%</div>
    <div class="kpi-label">Collection %</div>
  </div>

  <div class="owner-kpi teal">
    <div class="kpi-number" id="kpiYear">0</div>
    <div class="kpi-label">This Year</div>
  </div>

  <div class="owner-kpi indigo">
    <div class="kpi-number" id="kpiMonth">0</div>
    <div class="kpi-label">This Month</div>
  </div>

  <div class="owner-kpi yellow">
    <div class="kpi-number" id="kpiToday">0</div>
    <div class="kpi-label">Today</div>
  </div>

  <div class="owner-kpi red">
    <div class="kpi-number" id="kpiDue">0</div>
    <div class="kpi-label">Total Due</div>
  </div>

</div>

<!-- CHART -->
<div class="card">
  <h3>Agent Performance</h3>
  <canvas id="agentChart"></canvas>
</div>

<!-- BORROWERS -->
<div class="card">
  <h3>Borrowers</h3>
  <div id="borrowersSection"></div>
</div>

<!-- DUE -->
<div class="card">
  <h3>Due Today</h3>
  <div id="dueToday"></div>
</div>

<!-- OVERDUE -->
<div class="card">
  <h3>Overdue</h3>
  <div id="overdue"></div>
</div>

<button class="logout" id="logoutBtn">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import { collection, query, where, getDocs, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;
let chart;
let agentsMap={};

const agentFilter=document.getElementById("agentFilter");

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="index.html"; return; }

  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()||snap.data().role!=="owner"){
    await signOut(auth);
    location.href="index.html";
    return;
  }

  ownerId=user.uid;
  await loadAgents();
  processData();
});

document.getElementById("logoutBtn").onclick=async()=>{
  await signOut(auth);
  location.href="index.html";
};

document.getElementById("applyFilterBtn").onclick=processData;

document.getElementById("clearFilterBtn").onclick=()=>{
  startDate.value="";
  endDate.value="";
  agentFilter.value="all";
  processData();
};

async function loadAgents(){
  const snap=await getDocs(query(collection(db,"users"),
   where("role","==","agent"),
   where("approvedBy","==",ownerId)));

  agentFilter.innerHTML=`<option value="all">All Agents</option>`;
  snap.forEach(d=>{
    agentsMap[d.id]=d.data().name;
    agentFilter.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
  });
}

async function processData(){

  const agent=agentFilter.value||"all";
  let totalLoan=0,totalCollection=0,totalDue=0;
  let agentPerf={};
  let borrowerHtml="";

  const loanSnap=await getDocs(query(collection(db,"loans"),
   where("ownerId","==",ownerId)));

  loanSnap.forEach(d=>{
    const data=d.data();
    if(agent!=="all"&&data.agentId!==agent)return;
    totalLoan+=data.principal||0;
  });

  const colSnap=await getDocs(query(collection(db,"collections"),
   where("ownerId","==",ownerId)));

  colSnap.forEach(d=>{
    const data=d.data();
    if(agent!=="all"&&data.agentId!==agent)return;
    totalCollection+=data.amount||0;
    if(!agentPerf[data.agentId])agentPerf[data.agentId]=0;
    agentPerf[data.agentId]+=data.amount||0;
  });

  const instSnap=await getDocs(query(collection(db,"installments"),
   where("ownerId","==",ownerId)));

  const today=new Date(); today.setHours(0,0,0,0);
  dueToday.innerHTML="";
  overdue.innerHTML="";

  instSnap.forEach(d=>{
    const data=d.data();
    if(agent!=="all"&&data.agentId!==agent)return;
    if(data.status==="pending"){
      const due=new Date(data.dueDate);
      due.setHours(0,0,0,0);
      if(due>=today)totalDue+=data.amount||0;
      if(due.getTime()===today.getTime())
        dueToday.innerHTML+=`<div class="success-box">â‚¹${data.amount}</div>`;
      if(due<today)
        overdue.innerHTML+=`<div class="alert-box">â‚¹${data.amount}</div>`;
    }
  });

  const borrowerSnap=await getDocs(query(collection(db,"borrowers"),
   where("ownerId","==",ownerId)));

  borrowerSnap.forEach(d=>{
    const data=d.data();
    if(agent!=="all"&&data.agentId!==agent)return;
    borrowerHtml+=`<div class="borrower-item">${data.name}</div>`;
  });

  document.getElementById("borrowersSection").innerHTML=
    borrowerHtml||"No borrowers found";

  const outstanding=totalLoan-totalCollection;
  const percent=totalLoan?((totalCollection/totalLoan)*100).toFixed(1):0;

  kpiTotalLoan.innerText=totalLoan;
  kpiTotalCollection.innerText=totalCollection;
  kpiOutstanding.innerText=outstanding;
  kpiPercent.innerText=percent+"%";
  kpiDue.innerText=totalDue;

  if(chart)chart.destroy();
  chart=new Chart(agentChart,{
    type:"bar",
    data:{
      labels:Object.keys(agentPerf).map(a=>agentsMap[a]||"Agent"),
      datasets:[{label:"Collection",data:Object.values(agentPerf)}]
    }
  });
}

/* DARK MODE */
const toggle=document.getElementById("themeToggle");

toggle.onclick=()=>{
  document.body.classList.toggle("owner-dark");
  const isDark=document.body.classList.contains("owner-dark");
  localStorage.setItem("ownerTheme",isDark?"dark":"light");
  toggle.innerText=isDark?"â˜€ï¸":"ğŸŒ™";
};

if(localStorage.getItem("ownerTheme")==="dark"){
  document.body.classList.add("owner-dark");
  toggle.innerText="â˜€ï¸";
}

</script>
</body>
</html>