<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f3f4f6}
.header{background:#2563eb;color:#fff;padding:16px;text-align:center;font-weight:600;font-size:18px}
.container{padding:16px}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 3px 8px rgba(0,0,0,0.08)}
.card-row{background:#f9fafb;padding:10px;border-radius:8px;margin-bottom:10px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
.stat{font-size:20px;font-weight:bold}
select,input{padding:8px;border-radius:6px;border:1px solid #ddd}
.alert-box{background:#fee2e2;padding:8px;border-radius:6px;margin-bottom:6px}
.success-box{background:#dcfce7;padding:8px;border-radius:6px;margin-bottom:6px}
button{padding:8px 14px;border:none;border-radius:6px;color:white;cursor:pointer}
.approve{background:#16a34a}
.reject{background:#ef4444;margin-left:6px}
.logout{width:100%;margin-top:10px;background:#111827}
</style>
</head>

<body>

<div class="header">Owner Dashboard</div>

<div class="container">

<!-- AGENT REQUESTS -->
<div class="card">
  <h3>Agent Requests</h3>
  <div id="agentRequests"></div>
</div>

<!-- FILTER -->
<div class="card">
  <h3>Filters</h3>
  <div class="grid">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="agentFilter"></select>
    <button onclick="applyFilter()">Apply</button>
  </div>
</div>

<!-- OVERVIEW -->
<div class="card">
  <h3>Overview</h3>
  <div>Total Loan: â‚¹ <span class="stat" id="totalLoan">0</span></div>
  <div>Total Collection: â‚¹ <span class="stat" id="totalCollection">0</span></div>
  <div>Outstanding: â‚¹ <span class="stat" id="outstanding">0</span></div>
  <div>Top Agent: <span class="stat" id="topAgent">-</span></div>
</div>

<!-- CHART -->
<div class="card">
  <h3>Agent Performance</h3>
  <canvas id="agentChart"></canvas>
</div>

<!-- DUE TODAY -->
<div class="card">
  <h3>Due Today</h3>
  <div id="dueToday"></div>
</div>

<!-- OVERDUE -->
<div class="card">
  <h3>Overdue</h3>
  <div id="overdue"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  onSnapshot,
  updateDoc,
  deleteDoc,
  doc,
  getDoc,
  serverTimestamp,
  deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;
let agentsMap={};
let chart;

/* ================= AUTH ================= */

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="index.html"; return; }

  const userRef = doc(db,"users", user.uid);
  const userSnap = await getDoc(userRef);

  if(!userSnap.exists() || userSnap.data().role !== "owner"){
    await signOut(auth);
    location.href="index.html";
    return;
  }

  ownerId = user.uid;

  listenAgentRequests();
  await loadAgents();
  processData(); // ðŸ”¥ LOAD ANALYTICS
});

window.logoutUser = async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ================= AGENT REQUESTS ================= */

function listenAgentRequests(){

  const q = query(
    collection(db,"users"),
    where("role","==","pending"),
    where("requestedRole","==","agent")
  );

  onSnapshot(q,(snapshot)=>{

    const box=document.getElementById("agentRequests");
    box.innerHTML="";

    if(snapshot.empty){
      box.innerHTML="<p>No agent requests</p>";
      return;
    }

    snapshot.forEach(d=>{
      const data=d.data();

      box.innerHTML+=`
      <div class="card-row">
        <strong>${data.name}</strong><br>
        ${data.email}
        <br><br>
        <button class="approve"
          onclick="approveAgent('${d.id}')">
          Approve
        </button>
        <button class="reject"
          onclick="rejectAgent('${d.id}')">
          Reject
        </button>
      </div>`;
    });

  });
}

window.approveAgent = async(id)=>{
  await updateDoc(doc(db,"users",id),{
    role:"agent",
    approvedBy:ownerId,
    approvedAt:serverTimestamp(),
    requestedRole:deleteField()
  });
};

window.rejectAgent = async(id)=>{
  if(!confirm("Reject this agent request?"))return;
  await deleteDoc(doc(db,"users",id));
};

/* ================= LOAD AGENTS ================= */

async function loadAgents(){

  const snap = await getDocs(query(
    collection(db,"users"),
    where("role","==","agent"),
    where("approvedBy","==",ownerId)
  ));

  const select=document.getElementById("agentFilter");
  select.innerHTML=`<option value="all">All Agents</option>`;
  agentsMap={};

  snap.forEach(d=>{
    agentsMap[d.id]=d.data().name;
    select.innerHTML+=`
      <option value="${d.id}">
        ${d.data().name}
      </option>`;
  });
}

/* ================= ANALYTICS ================= */

async function processData(){

  /* ----------- TOTAL LOANS ----------- */

  const loanSnap = await getDocs(query(
    collection(db,"loans"),
    where("ownerId","==",ownerId)
  ));

  let totalLoan = 0;

  loanSnap.forEach(d=>{
    totalLoan += d.data().principal || 0;
  });

  /* ----------- COLLECTION ----------- */

  const colSnap = await getDocs(query(
    collection(db,"collections"),
    where("ownerId","==",ownerId)
  ));

  let totalCollection = 0;
  let agentPerformance = {};

  colSnap.forEach(d=>{
    const data=d.data();
    totalCollection += data.amount || 0;

    if(!agentPerformance[data.agentId])
      agentPerformance[data.agentId]=0;

    agentPerformance[data.agentId]+=data.amount;
  });

  let outstanding = totalLoan - totalCollection;

  document.getElementById("totalLoan").innerText=totalLoan;
  document.getElementById("totalCollection").innerText=totalCollection;
  document.getElementById("outstanding").innerText=outstanding;

  /* ----------- TOP AGENT ----------- */

  let top="-",max=0;

  Object.keys(agentPerformance).forEach(a=>{
    if(agentPerformance[a]>max){
      max=agentPerformance[a];
      top=agentsMap[a]||"-";
    }
  });

  document.getElementById("topAgent").innerText=top;

  /* ----------- CHART ----------- */

  const labels=Object.keys(agentPerformance)
    .map(a=>agentsMap[a]||"Agent");

  const data=Object.values(agentPerformance);

  if(chart) chart.destroy();

  chart=new Chart(
    document.getElementById("agentChart"),{
      type:"bar",
      data:{
        labels:labels,
        datasets:[
          {
            label:"Collection",
            data:data
          }
        ]
      }
    }
  );

  /* ----------- DUE + OVERDUE ----------- */

  const instSnap = await getDocs(query(
    collection(db,"installments"),
    where("ownerId","==",ownerId),
    where("status","==","pending")
  ));

  const today=new Date();
  today.setHours(0,0,0,0);

  const dueDiv=document.getElementById("dueToday");
  const overdueDiv=document.getElementById("overdue");
  dueDiv.innerHTML="";
  overdueDiv.innerHTML="";

  instSnap.forEach(d=>{
    const data=d.data();
    const dueDate=new Date(data.dueDate);
    const balance=data.amount;

    if(dueDate.toDateString()===today.toDateString()){
      dueDiv.innerHTML+=
        `<div class="success-box">
           â‚¹${balance}
         </div>`;
    }

    if(dueDate<today){
      overdueDiv.innerHTML+=
        `<div class="alert-box">
           â‚¹${balance}
         </div>`;
    }

  });

}

window.applyFilter = ()=>{
  processData();
};

</script>

</body>
</html>