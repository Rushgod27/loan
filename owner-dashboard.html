<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/owner.css">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<div class="header owner-header">
  <span>Owner Dashboard üëë</span>
  <button id="themeToggle" onclick="toggleTheme()">üåô</button>
</div>

<div class="container">

<!-- HERO -->
<div class="owner-hero">
  <div>
    <div class="owner-hero-title">Welcome Back üëë</div>
    <div class="owner-hero-sub">Here‚Äôs your business overview</div>
  </div>
</div>

<!-- INVITE -->
<div class="card">
  <h3>Your Agent Invite Code</h3>
  <div id="ownerCodeBox" class="code-box">Loading...</div>
  <button onclick="regenerateCode()">Regenerate Code</button>
</div>

<!-- FILTER -->
<div class="card">
  <h3>Filters</h3>
  <div class="grid">
    <input type="date" id="startDate">
    <input type="date" id="endDate">
    <select id="agentFilter"></select>
    <button onclick="applyFilter()">Apply</button>
    <button onclick="clearFilter()">Reset</button>
  </div>
</div>

<!-- KPI -->
<div class="owner-kpi-grid">

  <div class="owner-kpi owner-blue">
    <div class="owner-kpi-number" id="kpiTotalLoan">0</div>
    <div class="owner-kpi-label">Total Loan</div>
  </div>

  <div class="owner-kpi owner-purple">
    <div class="owner-kpi-number" id="kpiTotalCollection">0</div>
    <div class="owner-kpi-label">Total Collection</div>
  </div>

  <div class="owner-kpi owner-green">
    <div class="owner-kpi-number" id="kpiOutstanding">0</div>
    <div class="owner-kpi-label">Outstanding</div>
  </div>

  <div class="owner-kpi owner-orange">
    <div class="owner-kpi-number" id="kpiPercent">0%</div>
    <div class="owner-kpi-label">Collection %</div>
  </div>

  <div class="owner-kpi owner-teal">
    <div class="owner-kpi-number" id="kpiYear">0</div>
    <div class="owner-kpi-label">This Year</div>
  </div>

  <div class="owner-kpi owner-indigo">
    <div class="owner-kpi-number" id="kpiMonth">0</div>
    <div class="owner-kpi-label">This Month</div>
  </div>

  <div class="owner-kpi owner-yellow">
    <div class="owner-kpi-number" id="kpiToday">0</div>
    <div class="owner-kpi-label">Today</div>
  </div>

  <div class="owner-kpi owner-red">
    <div class="owner-kpi-number" id="kpiDue">0</div>
    <div class="owner-kpi-label">Total Due</div>
  </div>

</div>

<!-- CHART -->
<div class="card">
  <h3>Agent Performance</h3>
  <canvas id="agentChart"></canvas>
</div>

<!-- BORROWERS -->
<div class="card">
  <h3>Borrowers</h3>
  <div id="borrowersSection"></div>
</div>

<!-- DUE -->
<div class="card">
  <h3>Due Today</h3>
  <div id="dueToday"></div>
</div>

<!-- OVERDUE -->
<div class="card">
  <h3>Overdue</h3>
  <div id="overdue"></div>
</div>

<button class="logout" onclick="logoutUser()">Logout</button>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, query, where, getDocs,
doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let ownerId=null;
let agentsMap={};
let chart;

onAuthStateChanged(auth, async(user)=>{
 if(!user){ location.href="index.html"; return; }

 const snap = await getDoc(doc(db,"users",user.uid));
 if(!snap.exists() || snap.data().role!=="owner"){
  await signOut(auth);
  location.href="index.html";
  return;
 }

 ownerId=user.uid;
 await loadAgents();
 processData();
});

window.logoutUser = async()=>{
 await signOut(auth);
 window.location.replace("index.html");
};

async function loadAgents(){
 const snap=await getDocs(query(collection(db,"users"),
  where("role","==","agent"),
  where("approvedBy","==",ownerId)));

 agentFilter.innerHTML=`<option value="all">All Agents</option>`;
 agentsMap={};

 snap.forEach(d=>{
  agentsMap[d.id]=d.data().name;
  agentFilter.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
 });
}

window.applyFilter=()=>processData();
window.clearFilter=()=>{
 startDate.value="";
 endDate.value="";
 agentFilter.value="all";
 processData();
};

async function processData(){

 const agent=agentFilter.value||"all";

 let totalLoan=0,totalCollection=0,totalDue=0;
 let borrowersHtml="";
 let agentPerf={};

 const loanSnap=await getDocs(query(collection(db,"loans"),
  where("ownerId","==",ownerId)));

 loanSnap.forEach(d=>{
  const data=d.data();
  if(agent!=="all"&&data.agentId!==agent)return;
  totalLoan+=data.principal||0;
 });

 const colSnap=await getDocs(query(collection(db,"collections"),
  where("ownerId","==",ownerId)));

 colSnap.forEach(d=>{
  const data=d.data();
  if(agent!=="all"&&data.agentId!==agent)return;
  totalCollection+=data.amount||0;

  if(!agentPerf[data.agentId])agentPerf[data.agentId]=0;
  agentPerf[data.agentId]+=data.amount||0;
 });

 const instSnap=await getDocs(query(collection(db,"installments"),
  where("ownerId","==",ownerId)));

 const today=new Date(); today.setHours(0,0,0,0);
 dueToday.innerHTML=""; overdue.innerHTML="";

 instSnap.forEach(d=>{
  const data=d.data();
  if(agent!=="all"&&data.agentId!==agent)return;

  const dueDate=new Date(data.dueDate);
  dueDate.setHours(0,0,0,0);

  if(data.status==="pending"){
   if(dueDate>=today) totalDue+=data.amount||0;

   if(dueDate.getTime()===today.getTime()){
    dueToday.innerHTML+=`<div class="success-box">‚Çπ${data.amount}</div>`;
   }
   if(dueDate<today){
    overdue.innerHTML+=`<div class="alert-box">‚Çπ${data.amount}</div>`;
   }
  }
 });

 const borrowerSnap=await getDocs(query(collection(db,"borrowers"),
  where("ownerId","==",ownerId)));

 borrowerSnap.forEach(d=>{
  const data=d.data();
  if(agent!=="all"&&data.agentId!==agent)return;
  borrowersHtml+=`<div class="card-row">${data.name}</div>`;
 });

 borrowersSection.innerHTML=borrowersHtml||"No borrowers found";

 const outstanding=totalLoan-totalCollection;
 const percent=totalLoan?((totalCollection/totalLoan)*100).toFixed(1):0;

 kpiTotalLoan.innerText=totalLoan;
 kpiTotalCollection.innerText=totalCollection;
 kpiOutstanding.innerText=outstanding;
 kpiPercent.innerText=percent+"%";
 kpiDue.innerText=totalDue;

 if(chart)chart.destroy();
 chart=new Chart(agentChart,{
  type:"bar",
  data:{
   labels:Object.keys(agentPerf).map(a=>agentsMap[a]||"Agent"),
   datasets:[{label:"Collection",data:Object.values(agentPerf)}]
  }
 });
}

/* DARK MODE */
window.toggleTheme=function(){
 document.body.classList.toggle("owner-dark");
 const isDark=document.body.classList.contains("owner-dark");
 localStorage.setItem("ownerTheme",isDark?"dark":"light");
 document.getElementById("themeToggle").innerText=isDark?"‚òÄÔ∏è":"üåô";
};

window.addEventListener("DOMContentLoaded",()=>{
 if(localStorage.getItem("ownerTheme")==="dark"){
  document.body.classList.add("owner-dark");
  document.getElementById("themeToggle").innerText="‚òÄÔ∏è";
 }
});

</script>
</body>
</html>