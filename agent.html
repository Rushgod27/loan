<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Agent App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/styles.css?v=40">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">


</head>

<body>

<div class="header" id="pageTitle">Dashboard</div>

<div class="nav">
  <div id="navDashboard" class="active" onclick="showDashboard()">Dashboard</div>
  <div id="navBorrowers" onclick="showBorrowers()">Borrowers</div>
</div>

<div id="dashboardSection" class="section-content"></div>
<div id="borrowersSection" class="section-content hidden"></div>
<div id="profileSection" class="section-content hidden"></div>

<div class="logout-wrapper">
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, query, where, onSnapshot,
  addDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let uid=null;
let state={borrowers:[],loans:[],installments:[],collections:[]};
let currentView="dashboard";
let currentProfileId=null;
let openedLoanId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){location.href="index.html";return;}
  uid=user.uid;
  startRealtime();
});

function startRealtime(){
  onSnapshot(query(collection(db,"borrowers"),where("agentId","==",uid)),s=>{
    state.borrowers=[];s.forEach(d=>state.borrowers.push({id:d.id,...d.data()}));refresh();
  });
  onSnapshot(query(collection(db,"loans"),where("agentId","==",uid)),s=>{
    state.loans=[];s.forEach(d=>state.loans.push({id:d.id,...d.data()}));refresh();
  });
  onSnapshot(query(collection(db,"installments"),where("agentId","==",uid)),s=>{
    state.installments=[];s.forEach(d=>state.installments.push({id:d.id,...d.data()}));refresh();
  });
  onSnapshot(query(collection(db,"collections"),where("agentId","==",uid)),s=>{
    state.collections=[];s.forEach(d=>state.collections.push({id:d.id,...d.data()}));refresh();
  });
}

function refresh(){
  if(currentView==="dashboard")renderDashboard();
  if(currentView==="borrowers")renderBorrowers();
  if(currentView==="profile")renderProfile(currentProfileId);
}

/* NAVIGATION */
window.showDashboard=()=>{currentView="dashboard";setActive("Dashboard")}
window.showBorrowers=()=>{currentView="borrowers";setActive("Borrowers")}
window.showProfile=(id)=>{currentProfileId=id;currentView="profile";setActive("Profile")}

function setActive(title){
  pageTitle.innerText=title;
  dashboardSection.classList.add("hidden");
  borrowersSection.classList.add("hidden");
  profileSection.classList.add("hidden");
  navDashboard.classList.remove("active");
  navBorrowers.classList.remove("active");

  if(title==="Dashboard"){dashboardSection.classList.remove("hidden");navDashboard.classList.add("active")}
  if(title==="Borrowers"){borrowersSection.classList.remove("hidden");navBorrowers.classList.add("active")}
  if(title==="Profile"){profileSection.classList.remove("hidden")}
  refresh();
}

/* DASHBOARD */
/* DASHBOARD */
function renderDashboard(){

  const today = new Date();
  today.setHours(0,0,0,0);

  let dueHTML = "";
  let overdueHTML = "";

  /* ===== BUSINESS SUMMARY ===== */

  const totalLoanValue =
    state.loans.reduce((a,b)=>a+(b.principal||0),0);

  const totalCollected =
    state.collections.reduce((a,b)=>a+(b.amount||0),0);

  const totalOutstanding =
    totalLoanValue - totalCollected;

  const activeLoans =
    state.loans.filter(l=>l.status==="active").length;

  let overviewHTML = `
  <div class="card">
    <h3>Business Summary</h3>
    <div>Total Borrowers: ${state.borrowers.length}</div>
    <div>Total Loans Value: â‚¹${totalLoanValue}</div>
    <div>Total Collection: â‚¹${totalCollected}</div>
    <div>Outstanding: â‚¹${totalOutstanding}</div>
    <div>Active Loans: ${activeLoans}</div>
  </div>
  `;

  /* ===== INSTALLMENTS LOOP ===== */

  state.installments.forEach(inst=>{

    if(inst.status!=="pending") return;

    const due = new Date(inst.dueDate);
    due.setHours(0,0,0,0);

    const borrower = state.borrowers.find(b=>b.id===inst.borrowerId);
    const loan = state.loans.find(l=>l.id===inst.loanId);

    if(!borrower || !loan) return;

    const photo = borrower.profileImage ||
      "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    const daysLate = Math.floor((today - due)/86400000);

    const reminderMsg =
`Hello ${borrower.name},

Loan Amount: â‚¹${loan.principal}
Installment: ${inst.number}
Amount: â‚¹${inst.amount}
Due Date: ${due.toLocaleDateString()}

${daysLate>0 ? `You are ${daysLate} days overdue.` : ""}

Please pay at the earliest.`;

    const waLink =
`https://wa.me/91${borrower.phone}?text=${encodeURIComponent(reminderMsg)}`;

    const card = `
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;">
          <img src="${photo}"
            onclick="showProfile('${borrower.id}')"
            style="width:60px;height:60px;border-radius:50%;object-fit:cover;cursor:pointer;">
          <div>
            <b>${borrower.name}</b><br>
            Loan: â‚¹${loan.principal}<br>
            Installment ${inst.number}<br>
            Amount: â‚¹${inst.amount}<br>
            Due: ${due.toLocaleDateString()}
          </div>
        </div>
        <br>
        <button onclick="confirmCall('${borrower.phone}')">Call</button>
        <button onclick="confirmReminder('${waLink}')">Send Reminder</button>
<button onclick="confirmMarkPaid('${inst.id}','${inst.loanId}','${inst.borrowerId}',${inst.amount})">
          Mark Paid
        </button>
      </div>
    `;

    if(due.getTime()===today.getTime()){
      dueHTML += card;
    }

    if(due < today){
      overdueHTML += card;
    }

  });

  dashboardSection.innerHTML =
    overviewHTML +
    `<div class="card"><h3>Due Today</h3>${dueHTML || "No dues today"}</div>` +
    `<div class="card"><h3>Overdue</h3>${overdueHTML || "No overdue payments"}</div>`;
}




window.confirmCall = (phone)=>{
  if(confirm("Call this borrower?")){
    window.location.href="tel:"+phone;
  }
};

window.confirmReminder = (waLink)=>{
  if(confirm("Send reminder message?")){
    window.open(waLink,"_blank");
  }
};

window.confirmMarkPaid = async(id,loanId,borrowerId,amt)=>{
  if(!confirm("Mark this installment as paid?")) return;

  await updateDoc(doc(db,"installments",id),
    {status:"completed"});

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    agentId:uid,
    amount:amt,
    type:"installment",
    date:Date.now()
  });

  alert("Payment recorded successfully");
};


/* BORROWERS */
function renderBorrowers(){
  borrowersSection.innerHTML=`
    <div class="card">
      <input id="searchInput" placeholder="Search borrower">
    </div>
    <div id="borrowerList"></div>`;
  renderBorrowerList(state.borrowers);
  searchInput.addEventListener("input",e=>{
    const v=e.target.value.toLowerCase();
    renderBorrowerList(state.borrowers.filter(b=>b.name.toLowerCase().includes(v)||b.phone.includes(v)));
  });
}

function renderBorrowerList(list){
  let html="";
  list.forEach(b=>{
    const activeLoan=state.loans.some(l=>l.borrowerId===b.id&&l.status==="active");
    const photo=b.profileImage||"https://cdn-icons-png.flaticon.com/512/149/149071.png";
    html+=`
      <div class="card borrower-card" onclick="showProfile('${b.id}')">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="${photo}" style="width:55px;height:55px;border-radius:50%;object-fit:cover">
          <div><b>${b.name}</b><br>${b.phone}</div>
          ${activeLoan?`<span class="badge-active">Active</span>`:""}
        </div>
      </div>`;
  });
  borrowerList.innerHTML=html;
}

/* PROFILE */
function renderProfile(id){

  const b = state.borrowers.find(x=>x.id===id);
  if(!b) return;

  const photo = b.profileImage ||
  "https://cdn-icons-png.flaticon.com/512/149/149071.png";

  const docs = b.documents || [];

  let html = `
  <div class="card">
    <div style="text-align:center">
      <img id="profileImg"
           src="${photo}"
           class="profile-big"
           style="width:150px;height:150px;border-radius:50%;cursor:pointer;">
      <input type="file"
             id="photoInput"
             accept="image/*"
             hidden>
    </div>

    <h3>${b.name}</h3>

    <div class="profile-actions">
      <a href="tel:${b.phone}" class="call-btn">ðŸ“ž Call</a>
      <a target="_blank"
         href="https://wa.me/91${b.phone}"
         class="wa-btn">ðŸ’¬ WhatsApp</a>
    </div>

    <button class="btn btn-primary"
            onclick="createLoanUI()">
      + Create Loan
    </button>

    <div id="loanCreateBox"></div>
  </div>
  `;

  /* ===== LOANS ===== */

  const loans = state.loans
    .filter(l=>l.borrowerId===id)
    .sort((a,b)=>{
      if(a.status===b.status){
        return b.startDate - a.startDate;
      }
      return a.status==="active" ? -1 : 1;
    });

  loans.forEach(loan=>{
    html+=`
    <div class="card">
      <b>Loan â‚¹${loan.principal}</b><br>
      Installments: ${loan.count}<br>
      Start: ${new Date(loan.startDate).toLocaleDateString()}<br>
      Status: ${loan.status}<br><br>

      <button class="btn btn-success"
              onclick="toggleInstallments('${loan.id}')">
        View Installments
      </button>

      <div id="inst-${loan.id}"></div>
    </div>`;
  });

  /* ===== DOCUMENTS ===== */

  html += `
  <div class="card">
    <h3>Documents</h3>

    <input type="file" id="docInput" multiple><br><br>

    <div id="docList">
      ${docs.map((d,i)=>
        `<div>
           <a href="${d}" download="document_${i+1}">Download</a> |
           <a href="${d}" target="_blank">View</a>
         </div>`
      ).join("")}
    </div>
  </div>
  `;

  profileSection.innerHTML = html;

/* ===== PHOTO SAVE (Compressed Base64) ===== */

const photoInput = document.getElementById("photoInput");
const profileImg = document.getElementById("profileImg");

profileImg.onclick = () => photoInput.click();

photoInput.onchange = async e => {

  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = function(event){

    const img = new Image();
    img.src = event.target.result;

    img.onload = async function(){

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const MAX_WIDTH = 400;
      const scale = MAX_WIDTH / img.width;

      canvas.width = MAX_WIDTH;
      canvas.height = img.height * scale;

      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      const compressedBase64 = canvas.toDataURL("image/jpeg", 0.6);

      try {
        await updateDoc(doc(db,"borrowers",id),{
          profileImage: compressedBase64
        });

        profileImg.src = compressedBase64;
        alert("Profile Photo Saved âœ…");

      } catch(err){
        console.error(err);
        alert("Image too large. Try smaller image.");
      }

    };

  };

  reader.readAsDataURL(file);

};

  /* ===== DOCUMENT UPLOAD ===== */

  const docInput = document.getElementById("docInput");

  docInput.onchange = async e=>{
    const files = [...e.target.files];
    let newDocs = docs.slice();

    for(const file of files){
      const reader = new FileReader();
      reader.onload = async ev=>{
        newDocs.push(ev.target.result);
        await updateDoc(doc(db,"borrowers",id),{
          documents:newDocs
        });
      };
      reader.readAsDataURL(file);
    }
  };
}

/* INSTALLMENTS */
window.toggleInstallments = (loanId)=>{

  const box = document.getElementById("inst-"+loanId);

  if(openedLoanId === loanId){
    box.innerHTML="";
    openedLoanId=null;
    return;
  }

  openedLoanId = loanId;

  const today = new Date();
  today.setHours(0,0,0,0);

  const list = state.installments
    .filter(i => i.loanId === loanId)
    .sort((a,b)=> a.number - b.number);

  let grouped = {
    "Due Today":[],
    "Overdue":[],
    "Pending":[],
    "Paid":[]
  };

  list.forEach(i=>{

    const due = new Date(i.dueDate);
    due.setHours(0,0,0,0);

    if(i.status==="completed"){
      grouped["Paid"].push(i);
    }
    else if(due.getTime()===today.getTime()){
      grouped["Due Today"].push(i);
    }
    else if(due<today){
      grouped["Overdue"].push(i);
    }
    else{
      grouped["Pending"].push(i);
    }

  });

  let html="";

  Object.keys(grouped).forEach(group=>{

    if(grouped[group].length===0) return;

    html+=`<h4>${group}</h4>`;

    grouped[group].forEach(i=>{
      html+=`
      <div class="inst-card">
        Installment ${i.number}
        <br>Amount: â‚¹${i.amount}
        <br>Due: ${new Date(i.dueDate).toLocaleDateString()}
        <br>Status: ${i.status}
        <br>
        ${i.status==="pending" ? `
        <button onclick="confirmMarkPaid('${i.id}','${loanId}','${i.borrowerId}',${i.amount})">
          Mark Paid
        </button>` : ""}
      </div>`;
    });

  });

  box.innerHTML = html;
};

/* MARK PAID */
window.markPaid=async(id,loanId,borrowerId,amt)=>{

  if(!confirm("Mark this installment as paid?")) return;

  await updateDoc(doc(db,"installments",id),{
    status:"completed"
  });

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    agentId:uid,
    amount:amt,
    type:"installment",
    date:Date.now()
  });

  alert("Payment recorded successfully");
};

/* CREATE LOAN */
window.createLoanUI=()=>{
  loanCreateBox.innerHTML=`
    <input id="loanAmt" type="number" placeholder="Principal Amount"><br><br>

    <input id="loanInterest" type="number" placeholder="Upfront Interest %"><br><br>

    <input id="loanCount" type="number" placeholder="Installments Count"><br><br>

    <select id="loanInterval">
      <option value="">Select Interval</option>
      <option value="7">7 Days</option>
      <option value="15">15 Days</option>
      <option value="30">30 Days</option>
    </select><br><br>

    <input type="date" id="loanStart"><br><br>

    <button class="btn btn-primary" onclick="createLoan()">Create Loan</button>
  `;
};

window.createLoan = async () => {

  const principal = Number(loanAmt.value);
  const interest = Number(loanInterest.value) || 0;
  const count = Number(loanCount.value);
  const interval = Number(loanInterval.value);
  const start = loanStart.value;

  if (!principal || !count || !interval || !start) {
    alert("All fields required.");
    return;
  }

  const startTime = new Date(start).getTime();

  /* ðŸ”¥ UPFRONT MODEL */

  const interestAmount = (principal * interest) / 100;
  const disbursedAmount = principal - interestAmount;
  const installmentAmount = Number((principal / count).toFixed(2));

  const preview = `
Loan Preview (Upfront Interest Model):

Principal: â‚¹${principal}
Upfront Interest: â‚¹${interestAmount}
Borrower Receives: â‚¹${disbursedAmount}
Total Payable: â‚¹${principal}
Installments: ${count}
Each Installment: â‚¹${installmentAmount}
Start Date: ${new Date(startTime).toLocaleDateString()}

Proceed?
  `;

  if (!confirm(preview)) return;

  /* CREATE LOAN */

  const ref = await addDoc(collection(db, "loans"), {
    borrowerId: currentProfileId,
    agentId: uid,
    principal,
    interestPercent: interest,
    interestAmount,
    disbursedAmount,
    totalAmount: principal, // ðŸ”¥ total is principal only
    count,
    interval,
    startDate: startTime,
    status: "active",
    createdAt: Date.now()
  });

  /* CREATE INSTALLMENTS */

  for (let i = 0; i < count; i++) {

    await addDoc(collection(db, "installments"), {
      loanId: ref.id,
      borrowerId: currentProfileId,
      agentId: uid,
      number: i + 1,
      amount: installmentAmount,
      dueDate: startTime + ((i + 1) * interval * 86400000),
      status: "pending"
    });

  }

  alert("Loan Created Successfully âœ…");
};
/* LOGOUT */
window.logout=async()=>{
  await signOut(auth);
  window.location.replace("index.html");
};

</script>
</body>
</html>