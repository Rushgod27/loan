<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Agent App</title>
<meta name="viewport" 
content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

<link rel="stylesheet" href="css/styles.css?v=17.3">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">

</head>

<body>
  <div class="swipe-bar" id="swipeBar"></div>

<div class="header">
  <span id="pageTitle">Dashboard</span>
  <button id="themeToggle" onclick="toggleTheme()">üåô</button>
</div>


<div id="dashboardSection" class="section-content"></div>
<div id="borrowersSection" class="section-content hidden"></div>
<div id="profileSection" class="section-content hidden"></div>

<div class="logout-wrapper">
<button class="btn btn-danger" onclick="logout()">Logout</button>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, query, where, onSnapshot,
  addDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let uid=null;
let state={
  borrowers:[],
  loans:[],
  installments:[],
  collections:[],
  documents:[]   // üî• NEW
};
let currentView="dashboard";
let currentProfileId=null;
let openedLoanId=null;

/* AUTH */
let agentName = "Agent";

onAuthStateChanged(auth,user=>{
  if(!user){location.href="index.html";return;}
  uid=user.uid;

  agentName = user.displayName || 
              user.email?.split("@")[0] || 
              "Agent";

  startRealtime();
});

function startRealtime(){

  // BORROWERS
  onSnapshot(
    query(collection(db,"borrowers"),where("agentId","==",uid)),
    s=>{
      state.borrowers=[];
      s.forEach(d=>state.borrowers.push({id:d.id,...d.data()}));
      refresh();
    }
  );

  // LOANS
  onSnapshot(
    query(collection(db,"loans"),where("agentId","==",uid)),
    s=>{
      state.loans=[];
      s.forEach(d=>state.loans.push({id:d.id,...d.data()}));
      refresh();
    }
  );

  // INSTALLMENTS
  onSnapshot(
    query(collection(db,"installments"),where("agentId","==",uid)),
    s=>{
      state.installments=[];
      s.forEach(d=>state.installments.push({id:d.id,...d.data()}));
      refresh();
    }
  );

  // COLLECTIONS
  onSnapshot(
    query(collection(db,"collections"),where("agentId","==",uid)),
    s=>{
      state.collections=[];
      s.forEach(d=>state.collections.push({id:d.id,...d.data()}));
      refresh();
    }
  );

  // üî• DOCUMENTS (NEW COLLECTION)
  onSnapshot(
    query(collection(db,"documents"),where("agentId","==",uid)),
    s=>{
      state.documents=[];
      s.forEach(d=>state.documents.push({id:d.id,...d.data()}));
      refresh();
    }
  );

}

function refresh(){

  if(currentView==="dashboard"){
    renderDashboard();
    return;
  }

  if(currentView==="borrowers"){
    renderBorrowers();
    return;
  }

  if(currentView==="profile" && currentProfileId){
    renderProfile(currentProfileId);
  }
  
  setTimeout(()=>{
  animateCounters();
  renderSparkline();
},50);

}

/* NAVIGATION */
window.showDashboard=()=>{currentView="dashboard";setActive("Dashboard")}
window.showBorrowers=()=>{currentView="borrowers";setActive("Borrowers")}
window.showProfile=(id)=>{currentProfileId=id;currentView="profile";setActive("Profile")}

function setActive(title){

  pageTitle.innerText = title;

  dashboardSection.classList.add("hidden");
  borrowersSection.classList.add("hidden");
  profileSection.classList.add("hidden");

  document.getElementById("tabDashboard")?.classList.remove("active");
  document.getElementById("tabBorrowers")?.classList.remove("active");

  if(title === "Dashboard"){
    dashboardSection.classList.remove("hidden");
    document.getElementById("tabDashboard")?.classList.add("active");
  }

  if(title === "Borrowers"){
    borrowersSection.classList.remove("hidden");
    document.getElementById("tabBorrowers")?.classList.add("active");
  }

  if(title === "Profile"){
    profileSection.classList.remove("hidden");
    document.getElementById("tabBorrowers")?.classList.add("active");
  }

  refresh();
}

/* DASHBOARD */
function renderDashboard(){

  const today = new Date();
  today.setHours(0,0,0,0);
  
  /* =====================
   KPI CALCULATIONS
===================== */

const activeBorrowers = state.borrowers.filter(b =>
  state.loans.some(l => l.borrowerId === b.id && l.status === "active")
).length;

const completedLoans = state.loans.filter(l=>l.status==="completed").length;
const activeLoans = state.loans.filter(l=>l.status==="active").length;

let todayCollection = 0;
let dueCount = 0;
let overdueCount = 0;
let next7Days = 0;

const nextWeek = new Date(today.getTime() + 7*86400000);

state.collections.forEach(c=>{
  const d = new Date(c.date);
  d.setHours(0,0,0,0);
  if(d.getTime()===today.getTime()){
    todayCollection += c.amount;
  }
});

state.installments.forEach(i=>{
  if(i.status!=="pending") return;

  const due = new Date(i.dueDate);
  due.setHours(0,0,0,0);

  if(due.getTime()===today.getTime()) dueCount++;
  if(due < today) overdueCount++;

  if(due > today && due <= nextWeek) next7Days++;
});





  let overviewHTML = "";
  let dueHTML = "";
  let overdueHTML = "";


overviewHTML = `
<div class="dashboard-top">

  <div class="hero-card">
    <div class="hero-text">
      Hi ${agentName} üëã
      <div class="hero-sub">Here's your 7-day performance</div>
    </div>
    <svg id="sparklineChart"></svg>
  </div>

  <div class="kpi-grid">

    <div class="kpi-card kpi-blue">
      <div class="kpi-number counter" data-count="${activeBorrowers}">0</div>
      <div class="kpi-label">Active Borrowers</div>
    </div>

    <div class="kpi-card kpi-purple">
      <div class="kpi-number counter" data-count="${activeLoans}">0</div>
      <div class="kpi-label">Active Loans</div>
    </div>

    <div class="kpi-card kpi-green">
      <div class="kpi-number counter" data-count="${todayCollection}">0</div>
      <div class="kpi-label">Today Collection</div>
    </div>

    <div class="kpi-card kpi-teal">
      <div class="kpi-number counter" data-count="${next7Days}">0</div>
      <div class="kpi-label">Next 7 Days</div>
    </div>

    <div class="kpi-card kpi-orange">
      <div class="kpi-number counter" data-count="${dueCount}">0</div>
      <div class="kpi-label">Due Today</div>
    </div>

    <div class="kpi-card kpi-red">
      <div class="kpi-number counter" data-count="${overdueCount}">0</div>
      <div class="kpi-label">Overdue</div>
    </div>

  </div>
</div>
`;


  /* ===== INSTALLMENTS LOOP ===== */
  state.installments.forEach(inst =>{

    if(inst.status!=="pending") return;

    const due = new Date(inst.dueDate);
    due.setHours(0,0,0,0);

    const borrower = state.borrowers.find(b=>b.id===inst.borrowerId);
    const loan = state.loans.find(l=>l.id===inst.loanId);

    if(!borrower || !loan) return;

    const photo = borrower.profileImage ||
      "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    const daysLate = Math.floor((today - due)/86400000);

    /* FULL REMINDER MESSAGE */
const reminderMsg =
`Hello ${borrower.name},

Loan Amount: ‚Çπ${loan.principal}
Total Loan With Interest: ‚Çπ${loan.totalAmount || loan.principal}
Installment No: ${inst.number}
Installment Amount: ‚Çπ${inst.amount}
Due Date: ${due.toLocaleDateString()}

${daysLate>0?`You are ${daysLate} days overdue.`:""}

Please pay at the earliest.`;

    const waLink = 
`https://wa.me/91${borrower.phone}?text=${encodeURIComponent(reminderMsg)}`;

const actionButtons = `
  <button class="btn btn-info"
    onclick="confirmCall('${borrower.phone}')">
    üìû Call
  </button>

  <button class="btn btn-warning"
    onclick="confirmReminder('${waLink}')">
    üîî Send Reminder
  </button>

<button class="btn btn-success"
  onclick="confirmMarkPaid('${inst.id}','${inst.loanId}','${inst.borrowerId}', ${inst.amount})">
  ‚úÖ Mark Paid
</button>
`;

    const cardTemplate = `
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;">
          <img src="${photo}" 
               style="width:60px;height:60px;border-radius:50%;object-fit:cover;">
          <div>
            <b>${borrower.name}</b><br>
            ‚Çπ${inst.amount}
          </div>
        </div>
        <br>
        ${actionButtons}
      </div>
    `;

    /* DUE TODAY */
    if(due.getTime()===today.getTime()){
      dueHTML += cardTemplate.replace(
        `‚Çπ${inst.amount}`,
        `‚Çπ${inst.amount} ‚Ä¢ Due Today`
      );
    }

    /* OVERDUE */
    if(due < today){
      overdueHTML += cardTemplate.replace(
        `‚Çπ${inst.amount}`,
        `‚Çπ${inst.amount} ‚Ä¢ ${daysLate} days overdue`
      );
    }

  });

  dashboardSection.innerHTML =
  overviewHTML +
  `<div class="card"><h3>Due Today</h3>${dueHTML || "No dues today"}</div>` +
  `<div class="card"><h3>Overdue</h3>${overdueHTML || "No overdue payments"}</div>`;

/* Run animations AFTER render */
setTimeout(()=>{
  animateCounters();
  renderSparkline();
  renderPieChart(activeLoans, completedLoans);
},100);
}
window.confirmCall = (phone)=>{
  if(confirm("Call this borrower?")){
    window.location.href="tel:"+phone;
  }
};

window.confirmReminder = (waLink)=>{
  if(confirm("Send reminder message?")){
    window.open(waLink,"_blank");
  }
};

window.markPaid = (id, loanId, borrowerId, amt)=>{
  openConfirm("Mark this installment as paid?", async ()=>{
    await processPayment(id, loanId, borrowerId, amt);
    showToast("Payment recorded successfully ‚úÖ");
  });
};



/* BORROWERS */
function renderBorrowers(){

  borrowersSection.innerHTML = `
    <div class="card">
      <input id="searchInput" placeholder="Search borrower">
      <br><br>
      <button class="btn btn-primary" onclick="showAddBorrower()">
        + Add New Borrower
      </button>
    </div>

    <div id="addBorrowerBox"></div>
    <div id="borrowerList"></div>
  `;

  renderBorrowerList(state.borrowers);

  const searchInput = document.getElementById("searchInput");

  if (searchInput) {
    searchInput.addEventListener("input", e=>{
      const v = e.target.value.toLowerCase();

      renderBorrowerList(
        state.borrowers.filter(b =>
          b.name.toLowerCase().includes(v) ||
          b.phone.includes(v)
        )
      );
    });
  }
}

window.showAddBorrower = () => {

  const box = document.getElementById("addBorrowerBox");

  // If open ‚Üí close properly
  if(box.innerHTML.trim() !== ""){
    box.innerHTML = "";
    document.removeEventListener("click", handleOutsideClick); // ‚úÖ remove listener
    return;
  }

  box.innerHTML = `
    <div class="card" id="borrowerFormCard">

      <h3>Add New Borrower</h3>

      <input id="newName" placeholder="Full Name"
        pattern="[A-Za-z ]+"
        inputmode="text" />

      <br><br>

      <input id="newPhone" placeholder="Phone Number"
        maxlength="10"
        inputmode="numeric" />

      <br><br>

      <button class="btn btn-success"
              onclick="createBorrower()">
        Save Borrower
      </button>
    </div>
  `;

  // Delay to avoid immediate trigger
  setTimeout(()=>{
    document.addEventListener("click", handleOutsideClick);
  },50);
};


window.createBorrower = async () => {

  const nameInput = document.getElementById("newName");
  const phoneInput = document.getElementById("newPhone");

  const name = nameInput.value.trim();
  const phone = phoneInput.value.trim();

  // üîí Name: letters and spaces only
  const nameRegex = /^[A-Za-z ]+$/;

  if (!nameRegex.test(name)) {
    alert("Name should contain letters only.");
    return;
  }

  // üîí Phone: exactly 10 digits
  const phoneRegex = /^[0-9]{10}$/;

  if (!phoneRegex.test(phone)) {
    alert("Phone number must be exactly 10 digits.");
    return;
  }

  // üîç Duplicate Check
  const existing = state.borrowers.find(b => b.phone === phone);

  if (existing) {
    alert(`This number already exists under name: ${existing.name}`);
    return;
  }

  // ‚úÖ Save borrower
  await addDoc(collection(db,"borrowers"),{
    name,
    nameLower: name.toLowerCase(),
    phone,
    agentId: uid,
    createdAt: Date.now()
  });

showToast("Borrower Added Successfully ‚úÖ");

  nameInput.value = "";
  phoneInput.value = "";
};

function renderBorrowerList(list){
  let html="";
  list.forEach(b=>{
    const activeLoan=state.loans.some(l=>l.borrowerId===b.id&&l.status==="active");
    const photo=b.profileImage||"https://cdn-icons-png.flaticon.com/512/149/149071.png";
    html+=`
      <div class="card borrower-card" onclick="showProfile('${b.id}')">
        <div style="display:flex;align-items:center;gap:12px">
          <img src="${photo}" style="width:55px;height:55px;border-radius:50%;object-fit:cover">
          <div><b>${b.name}</b><br>${b.phone}</div>
          ${activeLoan?`<span class="badge-active">Active</span>`:""}
        </div>
      </div>`;
  });
const borrowerListEl = document.getElementById("borrowerList");
if (borrowerListEl) {
  borrowerListEl.innerHTML = html;
}
}

/* PROFILE */
function renderProfile(id){

  const b = state.borrowers.find(x=>x.id===id);
  if(!b) return;

  const photo = b.profileImage ||
    "https://cdn-icons-png.flaticon.com/512/149/149071.png";

  let html=`
  <div class="card">
    <div style="text-align:center">
<div class="profile-photo-wrapper">
  <img id="profileImg" src="${photo}">
</div>
      <input type="file" id="photoInput" accept="image/*" hidden>
    </div>

    <h3>${b.name}</h3>
<div class="profile-actions">
  <a href="tel:${b.phone}" class="call-btn contact-link">
    üìû Call
  </a>

  <a target="_blank" 
     href="https://wa.me/91${b.phone}" 
     class="wa-btn contact-link">
    üí¨ WhatsApp
  </a>

  <a onclick="scrollToDocuments()" 
     class="doc-link contact-link">
    üìÑ Documents
  </a>
</div>

    <button class="btn btn-primary" onclick="createLoanUI()">+ Create Loan</button>
    <div id="loanCreateBox"></div>
  </div>`;

// ===== LOANS GROUPED LIKE INSTALLMENTS =====

const borrowerLoans = state.loans
  .filter(l => l.borrowerId === id)
  .sort((a,b)=>b.createdAt - a.createdAt);

const activeLoans = borrowerLoans.filter(l => l.status === "active");
const completedLoans = borrowerLoans.filter(l => l.status !== "active");

function renderLoanGroup(title, loans, isCompleted=false){

  if(!loans.length) return "";

  let h = `
    <div class="section-header">
      ${title}
    </div>
  `;

  loans.forEach(loan=>{
    h += `
      <div class="card ${isCompleted ? "loan-completed" : ""}">
        <b>Loan ‚Çπ${loan.principal}</b><br>
        Installments: ${loan.count}<br>
        Start: ${new Date(loan.startDate).toLocaleDateString()}<br>
        Status: ${loan.status}<br>

        ${!isCompleted ? `
          <button class="btn btn-success"
            onclick="toggleInstallments('${loan.id}')">
            View Installments
          </button>
        ` : ""}

        <div id="inst-${loan.id}"></div>
      </div>
    `;
  });

  return h;
}

html += renderLoanGroup("Active Loans", activeLoans, false);
html += renderLoanGroup("Completed Loans", completedLoans, true);

  // DOCUMENT SECTION
html += `
  <div class="card" id="documentsSectionCard">
    <h3>Documents</h3>
<div class="file-upload">
  <label for="docInput" class="file-label">
    üìÑ Choose Files
  </label>
  <span id="fileName">No files selected</span>
  <input type="file" id="docInput" multiple hidden>
</div>
    <div id="docList"></div>
  </div>
`;

  profileSection.innerHTML = html;

  /* ===== CALL DOCUMENT RENDER AFTER HTML LOAD ===== */
  renderDocs(id);

  /* ===== GET DOM ELEMENTS PROPERLY ===== */
  const photoInput = document.getElementById("photoInput");
  const profileImg = document.getElementById("profileImg");
  const docInput = document.getElementById("docInput");

const fileNameText = document.getElementById("fileName");

docInput.addEventListener("change", function(){
  if(this.files.length === 0){
    fileNameText.innerText = "No files selected";
  } else if(this.files.length === 1){
    fileNameText.innerText = this.files[0].name;
  } else{
    fileNameText.innerText = this.files.length + " files selected";
  }
});


  profileImg.onclick = () => photoInput.click();

  /* PHOTO UPDATE */
  photoInput.onchange = e => {

    const file = e.target.files[0];
    if (!file) return;

    const img = new Image();
    const reader = new FileReader();

    reader.onload = event => img.src = event.target.result;

    img.onload = async () => {

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const MAX_WIDTH = 400;
      const scale = MAX_WIDTH / img.width;

      canvas.width = MAX_WIDTH;
      canvas.height = img.height * scale;

      ctx.drawImage(img,0,0,canvas.width,canvas.height);

      const compressed =
        canvas.toDataURL("image/jpeg",0.6);

      await updateDoc(doc(db,"borrowers",id),{
        profileImage: compressed
      });

      alert("Photo Updated Successfully ‚úÖ");
    };

    reader.readAsDataURL(file);
  };

  /* DOCUMENT UPLOAD */
  docInput.onchange = async e => {

    const files = [...e.target.files];

    for(const f of files){

      const reader = new FileReader();

      reader.onload = async ev => {

        const img = new Image();
        img.src = ev.target.result;

        img.onload = async () => {

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          const MAX_WIDTH = 600;
          const scale = MAX_WIDTH / img.width;

          canvas.width = MAX_WIDTH;
          canvas.height = img.height * scale;

          ctx.drawImage(img,0,0,canvas.width,canvas.height);

          const compressedFile =
            canvas.toDataURL("image/jpeg",0.5);

          await addDoc(collection(db,"documents"),{
            borrowerId:id,
            agentId:uid,
            file:compressedFile,
            createdAt:Date.now()
          });

          alert("Document Uploaded ‚úÖ");
        };
      };

      reader.readAsDataURL(f);
    }
  };
}

window.scrollToDocuments = () => {

  const section = document.getElementById("documentsSectionCard");

  if(section){
    section.scrollIntoView({
      behavior: "smooth",
      block: "start"
    });
  }

};

/* ===== RENDER DOCUMENTS FUNCTION (OUTSIDE PROFILE) ===== */
function renderDocs(borrowerId){

  const docList = document.getElementById("docList");
  if(!docList) return;

  const list = state.documents
    .filter(d=>d.borrowerId===borrowerId)
    .sort((a,b)=>b.createdAt-a.createdAt);

  docList.innerHTML = "";

  if(list.length===0){
    docList.innerHTML="No documents uploaded";
    return;
  }

docList.innerHTML = "";

list.forEach((d) => {

  const img = document.createElement("img");

  img.src = d.file;
  img.style.width = "100px";
  img.style.height = "100px";
  img.style.objectFit = "cover";
  img.style.borderRadius = "8px";
  img.style.cursor = "pointer";
  img.style.marginBottom = "10px";

  img.addEventListener("click", () => {
    showDocModal(d.file);
  });

  docList.appendChild(img);
});

window.showDocModal = (file) => {

  const modal = document.createElement("div");

  modal.style.position = "fixed";
  modal.style.top = "0";
  modal.style.left = "0";
  modal.style.width = "100%";
  modal.style.height = "100%";
  modal.style.background = "rgba(0,0,0,0.95)";
  modal.style.display = "flex";
  modal.style.flexDirection = "column";
  modal.style.justifyContent = "center";
  modal.style.alignItems = "center";
  modal.style.zIndex = "9999";

  modal.innerHTML = `
    <img src="${file}" 
         style="max-width:95%;max-height:80%;border-radius:8px;">
    
    <br>

    <a href="${file}" 
       download="document.jpg"
       style="padding:10px 20px;
              background:#16a34a;
              color:white;
              text-decoration:none;
              border-radius:6px;
              margin-top:10px;">
      Download
    </a>

    <br>

    <button style="margin-top:15px;
                   padding:8px 16px;
                   border:none;
                   border-radius:6px;"
            onclick="this.parentElement.remove()">
      Close
    </button>
  `;

  document.body.appendChild(modal);
};
}


/* INSTALLMENTS */
window.toggleInstallments = (loanId) => {

  const box = document.getElementById("inst-" + loanId);

  // ‚úÖ Collapse previously opened loan
  if (openedLoanId && openedLoanId !== loanId) {
    const prevBox = document.getElementById("inst-" + openedLoanId);
    if (prevBox) prevBox.innerHTML = "";
  }

  // ‚úÖ Close if same clicked
  if (openedLoanId === loanId) {
    box.innerHTML = "";
    openedLoanId = null;
    return;
  }

  openedLoanId = loanId;

  const today = new Date();
  today.setHours(0,0,0,0);

  const list = state.installments
    .filter(i => i.loanId === loanId)
    .sort((a,b)=>a.number-b.number);

  const dueToday = [];
  const overdue = [];
  const pending = [];
  const completed = [];

  list.forEach(i => {

    const due = new Date(i.dueDate);
    due.setHours(0,0,0,0);

    if (i.status === "completed") {
      completed.push(i);
    } 
    else if (due.getTime() === today.getTime()) {
      dueToday.push(i);
    }
    else if (due < today) {
      overdue.push(i);
    } 
    else {
      pending.push(i);
    }
  });

  function renderGroup(title, arr, color){
    if(!arr.length) return "";

    let h = `<h4 style="margin-top:10px;color:${color};">${title}</h4>`;

    arr.forEach(i=>{
      h += `
        <div class="inst-card">
          Installment ${i.number}<br>
          Amount: ‚Çπ${i.amount}<br>
          Due: ${new Date(i.dueDate).toLocaleDateString()}<br>
          Status: ${i.status}<br>
          ${i.status==="pending" ? `
            <button class="btn btn-success"
              onclick="markPaid('${i.id}','${loanId}','${i.borrowerId}',${i.amount})">
              Mark Paid
            </button>` : ""}
        </div>
      `;
    });

    return h;
  }
  box.innerHTML =
    renderGroup("Due Today", dueToday, "#f59e0b") +
    renderGroup("Overdue", overdue, "#ef4444") +
    renderGroup("Pending", pending, "#2563eb") +
    renderGroup("Completed", completed, "#16a34a");
};

window.confirmMarkPaid = (id, loanId, borrowerId, amt)=>{
  openConfirm("Mark this installment as paid?", async ()=>{
    await processPayment(id, loanId, borrowerId, amt);
    showToast("Payment recorded successfully ‚úÖ");
  });
};


/* CREATE LOAN */
window.createLoanUI = () => {

  const box = document.getElementById("loanCreateBox");

  // If already open ‚Üí close
  if(box.innerHTML.trim() !== ""){
    box.innerHTML = "";
    document.removeEventListener("click", handleLoanOutsideClick);
    return;
  }

  box.innerHTML = `
    <div class="card" id="loanFormCard">

      <input id="loanAmt" type="number" placeholder="Principal Amount"><br><br>

      <input id="loanInterest" type="number" placeholder="Upfront Interest %"><br><br>

      <input id="loanCount" type="number" placeholder="Installments Count"><br><br>

      <select id="loanInterval">
        <option value="">Select Interval</option>
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select><br><br>

      <input type="date" id="loanStart"><br><br>

      <button class="btn btn-primary" onclick="createLoan()">Create Loan</button>
    </div>
  `;

  // Delay to prevent immediate close
  setTimeout(()=>{
    document.addEventListener("click", handleLoanOutsideClick);
  },50);
};


window.createLoan = async () => {

  const principal = Number(loanAmt.value);
  const interest = Number(loanInterest.value) || 0;
  const count = Number(loanCount.value);
  const interval = Number(loanInterval.value);
  const start = loanStart.value;

  if (!principal || !count || !interval || !start) {
    alert("All fields required.");
    return;
  }

  const startTime = new Date(start).getTime();

  /* üî• UPFRONT MODEL */

  const interestAmount = (principal * interest) / 100;
  const disbursedAmount = principal - interestAmount;
  const installmentAmount = Number((principal / count).toFixed(2));

  const preview = `
Loan Preview (Upfront Interest Model):

Principal: ‚Çπ${principal}
Upfront Interest: ‚Çπ${interestAmount}
Borrower Receives: ‚Çπ${disbursedAmount}
Total Payable: ‚Çπ${principal}
Installments: ${count}
Each Installment: ‚Çπ${installmentAmount}
Start Date: ${new Date(startTime).toLocaleDateString()}

Proceed?
  `;

  if (!confirm(preview)) return;

  /* CREATE LOAN */

  const ref = await addDoc(collection(db, "loans"), {
    borrowerId: currentProfileId,
    agentId: uid,
    principal,
    interestPercent: interest,
    interestAmount,
    disbursedAmount,
    totalAmount: principal, // üî• total is principal only
    count,
    interval,
    startDate: startTime,
    status: "active",
    createdAt: Date.now()
  });

  /* CREATE INSTALLMENTS */

  for (let i = 0; i < count; i++) {

    await addDoc(collection(db, "installments"), {
      loanId: ref.id,
      borrowerId: currentProfileId,
      agentId: uid,
      number: i + 1,
      amount: installmentAmount,
      dueDate: startTime + ((i + 1) * interval * 86400000),
      status: "pending"
    });

  }

showToast("Loan Created Successfully ‚úÖ");
};

function handleOutsideClick(e){

  const formCard = document.getElementById("borrowerFormCard");
  const box = document.getElementById("addBorrowerBox");

  if(!formCard) return;

  if(!formCard.contains(e.target)){
    box.innerHTML = "";
    document.removeEventListener("click", handleOutsideClick);
  }
}


/* ========================
MARK PAID 
======================== */
async function processPayment(id, loanId, borrowerId, amt){

  await updateDoc(doc(db,"installments",id),{
    status:"completed"
  });

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    agentId:uid,
    amount:amt,
    type:"installment",
    date:Date.now()
  });

  const loanInstallments = state.installments.filter(i => i.loanId === loanId);

  const allCompleted = loanInstallments.every(i =>
    i.status === "completed" || i.id === id
  );

  if(allCompleted){
    await updateDoc(doc(db,"loans",loanId),{
      status:"completed"
    });
  }

}
/* ========================
   REAL SWIPE ONLY ENGINE
======================== */

let startX = 0;
let startY = 0;
let endX = 0;
let endY = 0;

document.addEventListener("touchstart", e=>{
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
});

document.addEventListener("touchend", e=>{
  endX = e.changedTouches[0].clientX;
  endY = e.changedTouches[0].clientY;

  const diffX = endX - startX;
  const diffY = endY - startY;

  const horizontalDistance = Math.abs(diffX);
  const verticalDistance = Math.abs(diffY);

  const MIN_SWIPE_DISTANCE = 120;  // require large swipe
  const MAX_VERTICAL_ALLOW = 50;   // prevent diagonal/scroll trigger

  // ‚úÖ Only trigger if it's a strong horizontal swipe
  if(
    horizontalDistance > MIN_SWIPE_DISTANCE &&
    verticalDistance < MAX_VERTICAL_ALLOW
  ){

    // Swipe Left
    if(diffX < 0){
      if(currentView === "dashboard") showBorrowers();
    }

    // Swipe Right
    if(diffX > 0){
      if(currentView === "borrowers") showDashboard();
      else if(currentView === "profile") showBorrowers();
    }

  }
});


function handleLoanOutsideClick(e){

  const box = document.getElementById("loanCreateBox");
  const form = document.getElementById("loanFormCard");

  if(!form) return;

  if(!form.contains(e.target)){
    box.innerHTML = "";
    document.removeEventListener("click", handleLoanOutsideClick);
  }
}

function animateCounters(){

  document.querySelectorAll(".counter").forEach(el=>{

    const target = +el.getAttribute("data-count");

    if(el.dataset.animated === "true") return;
    el.dataset.animated = "true";

    let count = 0;
    const step = Math.ceil(target / 40);

    const interval = setInterval(()=>{
      count += step;

      if(count >= target){
        el.innerText = target;
        clearInterval(interval);
      } else{
        el.innerText = count;
      }
    },15);

  });
}

function renderSparkline(){

  const svg = document.getElementById("sparklineChart");
  if(!svg) return;

  svg.innerHTML = "";
  svg.setAttribute("viewBox","0 0 200 60");

  const points = [];

  for(let i=6;i>=0;i--){
    const day = new Date(Date.now() - i*86400000);
    day.setHours(0,0,0,0);

    const total = state.collections
      .filter(c=>{
        const d = new Date(c.date);
        d.setHours(0,0,0,0);
        return d.getTime()===day.getTime();
      })
      .reduce((s,c)=>s+c.amount,0);

    points.push(total);
  }

  const max = Math.max(...points,1);

  const coords = points.map((v,i)=>{
    const x = i*(200/6);
    const y = 60 - (v/max)*50;
    return `${x},${y}`;
  }).join(" ");

  const poly = document.createElementNS("http://www.w3.org/2000/svg","polyline");
  poly.setAttribute("points",coords);
  poly.setAttribute("fill","none");
  poly.setAttribute("stroke","#ffffff");
  poly.setAttribute("stroke-width","3");

  svg.appendChild(poly);
}

/* LOGOUT */
window.logout=async()=>{
  await signOut(auth);
  window.location.replace("index.html");
};


/* =========================
   DARK MODE SYSTEM
========================= */

window.toggleTheme = function(){

  document.body.classList.toggle("dark-mode");

  const isDark = document.body.classList.contains("dark-mode");

  localStorage.setItem("theme", isDark ? "dark" : "light");

  const btn = document.getElementById("themeToggle");
  if(btn){
    btn.innerText = isDark ? "‚òÄÔ∏è" : "üåô";
  }
};

/* Load saved theme safely */
window.addEventListener("DOMContentLoaded", function(){

  const saved = localStorage.getItem("theme");
  const btn = document.getElementById("themeToggle");

  if(saved === "dark"){
    document.body.classList.add("dark-mode");
    if(btn) btn.innerText = "‚òÄÔ∏è";
  } else{
    if(btn) btn.innerText = "üåô";
  }

});


function showToast(message){
  const toast = document.getElementById("toast");
  toast.innerText = message;
  toast.classList.add("show");

  setTimeout(()=>{
    toast.classList.remove("show");
  },3000);
}


function openConfirm(message, onConfirm){
  const modal = document.getElementById("confirmModal");
  const text = document.getElementById("confirmText");
  const okBtn = document.getElementById("confirmOkBtn");

  text.innerText = message;
  modal.classList.remove("hidden");

  okBtn.onclick = ()=>{
    onConfirm();
    closeConfirm();
  };
}

window.closeConfirm = function(){
  document.getElementById("confirmModal")
    .classList.add("hidden");
};


</script>

<div class="bottom-nav">
  <div id="tabDashboard" class="tab active" onclick="showDashboard()">
    <span class="icon">üõñ</span>
  </div>

  <div id="tabBorrowers" class="tab" onclick="showBorrowers()">
    <span class="icon">üè¶</span>
  </div>
</div>



<div id="confirmModal" class="confirm-modal hidden">
  <div class="confirm-card">
    <p id="confirmText"></p>
    <div class="confirm-actions">
      <button onclick="closeConfirm()" class="btn">Cancel</button>
      <button id="confirmOkBtn" class="btn btn-success">Confirm</button>
    </div>
  </div>
</div>


<div id="toast"></div>
</body>
</html>