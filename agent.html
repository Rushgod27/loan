<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Agent App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css?v=31">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f46e5">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>

<body>

<div class="header" id="pageTitle">Dashboard</div>

<div class="nav">
  <div id="navDashboard" class="active" onclick="showDashboard()">Dashboard</div>
  <div id="navBorrowers" onclick="showBorrowers()">Borrowers</div>
</div>

<div id="dashboardSection" class="section-content"></div>
<div id="borrowersSection" class="section-content hidden"></div>
<div id="profileSection" class="section-content hidden"></div>

<div class="logout-wrapper">
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, query, where, onSnapshot,
  addDoc, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ================= GLOBAL STATE ================= */

let uid=null;
let ownerId=null;

let state={
  borrowers:[],
  loans:[],
  installments:[],
  collections:[]
};

let currentView="dashboard";
let currentProfileId=null;

/* ================= AUTH ================= */

onAuthStateChanged(auth, user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  uid=user.uid;
  startRealtimeListeners();
});

/* ================= REALTIME LISTENERS ================= */

function startRealtimeListeners(){

  onSnapshot(query(
    collection(db,"borrowers"),
    where("agentId","==",uid)
  ), snap=>{
    state.borrowers=[];
    snap.forEach(d=>state.borrowers.push({id:d.id,...d.data()}));
    refreshView();
  });

  onSnapshot(query(
    collection(db,"loans"),
    where("agentId","==",uid)
  ), snap=>{
    state.loans=[];
    snap.forEach(d=>state.loans.push({id:d.id,...d.data()}));
    refreshView();
  });

  onSnapshot(query(
    collection(db,"installments"),
    where("agentId","==",uid)
  ), snap=>{
    state.installments=[];
    snap.forEach(d=>state.installments.push({id:d.id,...d.data()}));
    refreshView();
  });

  onSnapshot(query(
    collection(db,"collections"),
    where("agentId","==",uid)
  ), snap=>{
    state.collections=[];
    snap.forEach(d=>state.collections.push({id:d.id,...d.data()}));
    refreshView();
  });
}

/* ================= VIEW SWITCH ================= */

window.showDashboard=()=>{
  currentView="dashboard";
  setActive("Dashboard");
};

window.showBorrowers=()=>{
  currentView="borrowers";
  setActive("Borrowers");
};

window.showProfile=(id)=>{
  currentProfileId=id;
  currentView="profile";
  setActive("Profile");
};

function setActive(title){

  pageTitle.innerText=title;

  dashboardSection.classList.add("hidden");
  borrowersSection.classList.add("hidden");
  profileSection.classList.add("hidden");

  navDashboard.classList.remove("active");
  navBorrowers.classList.remove("active");

  if(title==="Dashboard"){
    dashboardSection.classList.remove("hidden");
    navDashboard.classList.add("active");
  }

  if(title==="Borrowers"){
    borrowersSection.classList.remove("hidden");
    navBorrowers.classList.add("active");
  }

  if(title==="Profile"){
    profileSection.classList.remove("hidden");
  }

  refreshView();
}

function refreshView(){
  if(currentView==="dashboard") renderDashboard();
  if(currentView==="borrowers") renderBorrowers();
  if(currentView==="profile") renderProfile(currentProfileId);
}

/* ================= DASHBOARD ================= */

function renderDashboard(){

  const today=new Date();
  today.setHours(0,0,0,0);

  let dueHTML="";
  let overdueHTML="";
  let dueCount=0;
  let overdueCount=0;
  let todayCollection=0;

  state.installments.forEach(i=>{

    if(i.status!=="pending") return;

    const borrower=state.borrowers.find(b=>b.id===i.borrowerId);
    const loan=state.loans.find(l=>l.id===i.loanId);
    if(!borrower || !loan) return;

    const due=new Date(i.dueDate);
    due.setHours(0,0,0,0);

    const phone=borrower.phone;
    const daysLate=Math.floor((today-due)/86400000);

    const message=
`Hello ${borrower.name},

Loan Amount: ‚Çπ${loan.principal}
Installment No: ${i.number}
Installment Amount: ‚Çπ${i.amount}
Due Date: ${due.toLocaleDateString()}
${daysLate>0?`Overdue by ${daysLate} days`:""}

Please clear the payment at the earliest.`;

    const waLink=`https://wa.me/91${phone}?text=${encodeURIComponent(message)}`;

    const markBtn=`
      <button class="btn btn-success"
      onclick="markPaid('${i.id}','${i.loanId}','${i.borrowerId}',${i.amount})">
      Mark Paid üí∞</button>
    `;

    if(due.getTime()===today.getTime()){
      dueCount++;
      dueHTML+=`
        <div class="card">
          <b>${borrower.name}</b><br>
          ‚Çπ${i.amount} ‚Ä¢ Due Today
          <div class="card-actions">
            ${markBtn}
            <button onclick="window.location.href='tel:${phone}'">üìû</button>
            <button onclick="window.open('${waLink}','_blank')">üí¨ Reminder</button>
          </div>
        </div>
      `;
    }

    if(due<today){
      overdueCount++;
      overdueHTML+=`
        <div class="card">
          <b>${borrower.name}</b><br>
          ‚Çπ${i.amount} ‚Ä¢ ${daysLate} days overdue
          <div class="card-actions">
            ${markBtn}
            <button onclick="window.location.href='tel:${phone}'">üìû</button>
            <button onclick="window.open('${waLink}','_blank')">üí¨ Reminder</button>
          </div>
        </div>
      `;
    }

  });

  state.collections.forEach(c=>{
    const d=new Date(c.date);
    d.setHours(0,0,0,0);
    if(d.getTime()===today.getTime())
      todayCollection+=c.amount;
  });

  dashboardSection.innerHTML=`
    <div class="card">
      <div class="card-row"><div>Total Borrowers</div><b>${state.borrowers.length}</b></div>
      <div class="card-row"><div>Today's Collection</div><b>‚Çπ${todayCollection}</b></div>
      <div class="card-row"><div>Due Today</div><b>${dueCount}</b></div>
      <div class="card-row"><div>Overdue</div><b>${overdueCount}</b></div>
    </div>

    <div class="card">
      <h3>Due Today</h3>
      ${dueHTML || "No dues today"}
    </div>

    <div class="card">
      <h3>Overdue</h3>
      ${overdueHTML || "No overdue payments"}
    </div>
  `;
}

/* ================= BORROWERS ================= */

function renderBorrowers(){
  borrowersSection.innerHTML=`
    <div id="borrowerList"></div>
  `;

  let html="";
  state.borrowers.forEach(b=>{
    html+=`
      <div class="card borrower-card"
        onclick="showProfile('${b.id}')">
        <b>${b.name}</b><br>${b.phone}
      </div>
    `;
  });

  borrowerList.innerHTML=html;
}

/* ================= PROFILE ================= */

function renderProfile(id){

  const b=state.borrowers.find(x=>x.id===id);
  if(!b) return;

  const loans=state.loans.filter(l=>l.borrowerId===id);

  let html=`
    <div class="card">
      <h3>${b.name}</h3>
      <a href="tel:${b.phone}">üìû Call</a>
      <button onclick="showBorrowers()">‚Üê Back</button>
    </div>
  `;

  loans.forEach(loan=>{

    const installments=state.installments
      .filter(i=>i.loanId===loan.id)
      .sort((a,b)=>a.number-b.number);

    html+=`<div class="card">
      <b>Loan ‚Çπ${loan.principal}</b><br>`;

    installments.forEach(i=>{
      html+=`
        <div class="inst-card">
          Installment ${i.number} - ‚Çπ${i.amount}
          (${i.status})
          ${i.status==="pending"?
          `<button onclick="markPaid('${i.id}','${loan.id}','${id}',${i.amount}')">
          Mark Paid</button>`:""}
        </div>
      `;
    });

    html+=`</div>`;
  });

  profileSection.innerHTML=html;
}

/* ================= MARK PAID ================= */

window.markPaid=async(instId,loanId,borrowerId,amount)=>{

  await updateDoc(doc(db,"installments",instId),
    {status:"completed"});

  await addDoc(collection(db,"collections"),{
    loanId,
    borrowerId,
    agentId:uid,
    amount,
    type:"installment",
    date:Date.now()
  });
};

/* ================= LOGOUT ================= */

window.logout=async()=>{
  await signOut(auth);
  sessionStorage.setItem("justLoggedOut","true");
  window.location.replace("index.html");
};

/* ================= PWA ================= */

if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("/sw.js");
  });
}

</script>
</body>
</html>