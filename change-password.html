<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Change Password</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="login-wrapper">
  <div class="login-card">
    <div class="login-title">Set New Password</div>

    <input id="newPassword" 
           type="password"
           placeholder="New Password">

    <input id="confirmPassword" 
           type="password"
           placeholder="Confirm Password">

    <button class="login-btn" 
            onclick="updatePasswordNow()">
      Update Password
    </button>

    <div class="login-footer">
      You must change your temporary password
    </div>
  </div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  updatePassword
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  doc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUser=null;

/* ================= AUTH CHECK ================= */

onAuthStateChanged(auth,user=>{
  if(!user){
    window.location.href="index.html";
    return;
  }
  currentUser=user;
});

/* ================= UPDATE PASSWORD ================= */

window.updatePasswordNow = async ()=>{

  const newPass = newPassword.value.trim();
  const confirmPass = confirmPassword.value.trim();

  if(newPass.length < 6){
    alert("Password must be at least 6 characters");
    return;
  }

  if(newPass !== confirmPass){
    alert("Passwords do not match");
    return;
  }

  try{

    /* Update Firebase Auth password */
    await updatePassword(currentUser,newPass);

    /* Update Firestore flag */
    await updateDoc(doc(db,"users",currentUser.uid),{
      mustChangePassword:false
    });

    alert("Password updated successfully");

    window.location.href="agent-dashboard.html";

  }catch(err){
    alert("Error: " + err.message);
  }

};

</script>
</body>
</html>
