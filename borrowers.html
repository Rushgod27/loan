<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css?v=50">
</head>
<body>

<div class="header">Borrowers</div>

<div class="nav">
  <div onclick="goDashboard()">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="section-content">

  <!-- ADD BORROWER -->
  <div class="card">
    <button class="btn btn-primary"
            onclick="toggleAddForm()">
      + Add Borrower
    </button>

    <div id="addSection" class="collapsible">
      <input id="nameInput" placeholder="Borrower Name">
      <input id="phoneInput" placeholder="Phone Number">
      <button class="btn btn-success"
              onclick="createBorrower()">
        Save Borrower
      </button>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <input id="searchInput"
           placeholder="Search borrower by name or phone">
  </div>

  <!-- LIST -->
  <div id="borrowerList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  addDoc,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let borrowerCache=[];

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

window.goDashboard=()=>location.href="agent-dashboard.html";
window.logout=async()=>{
  await signOut(auth);
  location.href="index.html";
};

/* ADD TOGGLE */
window.toggleAddForm=()=>{
  addSection.classList.toggle("show");
};

/* CREATE BORROWER */
window.createBorrower=async()=>{
  const name=nameInput.value.trim();
  const phone=phoneInput.value.trim();

  if(!name||!phone){
    alert("Fill all fields");
    return;
  }

  const q=query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId),
    where("phone","==",phone)
  );

  const snap=await getDocs(q);

  if(!snap.empty){
    alert("Borrower already exists under you.");
    return;
  }

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    nameLower:name.toLowerCase(),
    agentId:currentUserId,
    createdAt:Date.now()
  });

  nameInput.value="";
  phoneInput.value="";
  addSection.classList.remove("show");

  loadBorrowers();
};

/* LOAD BORROWERS */
async function loadBorrowers(){
  borrowerCache=[];

  const q=query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap=await getDocs(q);

  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });

  borrowerCache.sort((a,b)=>a.name.localeCompare(b.name));

  renderBorrowers(borrowerCache);
}

/* SEARCH */
searchInput.addEventListener("input",e=>{
  const val=e.target.value.toLowerCase();

  if(!val){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered=borrowerCache.filter(b=>
    b.name.toLowerCase().includes(val) ||
    b.phone.includes(val)
  );

  renderBorrowers(filtered);
});

/* RENDER */
function renderBorrowers(list){

  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML=
      `<div class="card">No borrowers found</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="card card-expand">
        <b>${b.name}</b><br>
        ${b.phone}<br><br>

        <button class="btn btn-primary"
                onclick="toggleLoans('${b.id}')">
          View Loans
        </button>

        <div id="loan-${b.id}" class="collapsible"></div>
      </div>
    `;
  });
}

/* TOGGLE LOANS */
window.toggleLoans=async(borrowerId)=>{

  document.querySelectorAll(".loan-box")
  .forEach(e=>e.classList.remove("show"));

  const box=document.getElementById(`loan-${borrowerId}`);
  box.classList.add("loan-box");
  box.classList.toggle("show");

  if(box.innerHTML!=="") return;

  const q=query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  );

  const snap=await getDocs(q);

  if(snap.empty){
    box.innerHTML=`<div class="card">No Loans</div>`;
    return;
  }

  snap.forEach(d=>{
    const loan=d.data();

    box.innerHTML+=`
      <div class="card card-expand">
        Principal: ₹${loan.principal}<br>
        Status: ${loan.status}<br><br>

        <button class="btn btn-success"
          onclick="toggleInstallments('${d.id}')">
          View Installments
        </button>

        <div id="inst-${d.id}" class="collapsible"></div>
      </div>
    `;
  });
};

/* INSTALLMENTS */
window.toggleInstallments=async(loanId)=>{

  document.querySelectorAll(".inst-box")
  .forEach(e=>e.classList.remove("show"));

  const box=document.getElementById(`inst-${loanId}`);
  box.classList.add("inst-box");
  box.classList.toggle("show");

  if(box.innerHTML!=="") return;

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  const list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  list.forEach(i=>{
    box.innerHTML+=`
      <div class="card card-expand">
        EMI ${i.number} - ₹${i.amount}<br>
        ${new Date(i.dueDate).toLocaleDateString()}<br>
        ${
          i.status==="pending"?
          `<button class="btn btn-success"
             onclick="pay('${i.id}')">
             Mark Paid</button>`:
          "Paid"
        }
      </div>
    `;
  });
};

/* PAY */
window.pay=async(id)=>{
  await updateDoc(doc(db,"installments",id),
  {status:"completed"});
  location.reload();
};

</script>
</body>
</html>