<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f5f7fb;
}

/* HEADER */
.header{
  background:#2563eb;
  color:white;
  padding:16px;
  font-weight:600;
  font-size:18px;
}

/* NAV */
.nav{
  display:flex;
  background:white;
  border-bottom:1px solid #eee;
}
.nav div{
  flex:1;
  text-align:center;
  padding:14px;
  cursor:pointer;
}
.nav .active{
  font-weight:600;
  border-bottom:3px solid #2563eb;
}

/* LAYOUT */
.app{
  display:flex;
  height:calc(100vh - 108px);
}

.sidebar{
  width:320px;
  background:white;
  border-right:1px solid #eee;
  overflow:auto;
}

.content{
  flex:1;
  overflow:auto;
  padding:20px;
}

/* SEARCH */
.search-box{
  padding:12px;
}
.search-box input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
}

/* LIST */
.list-item{
  padding:14px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.list-item:hover{
  background:#f3f4f6;
}

/* CARDS */
.card{
  background:white;
  padding:18px;
  border-radius:12px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05);
}

button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  font-weight:600;
  cursor:pointer;
  margin-top:8px;
}

.badge{
  padding:4px 8px;
  border-radius:10px;
  font-size:12px;
  font-weight:600;
}

.badge-active{
  background:#dcfce7;
  color:#166534;
}

.badge-completed{
  background:#eee;
  color:#666;
}

.gray{
  opacity:.6;
}

.progress{
  height:10px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
  margin-top:10px;
}

.progress-bar{
  height:100%;
  background:#22c55e;
}

/* MOBILE */
@media(max-width:900px){
  .app{
    flex-direction:column;
  }
  .sidebar{
    width:100%;
    height:100%;
  }
  .content{
    display:none;
  }
}
</style>
</head>
<body>

<div class="header">Borrowers</div>

<div class="nav">
  <div onclick="goDashboard()">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logoutUser()">Logout</div>
</div>

<div class="app">

  <div class="sidebar">
    <div class="search-box">
      <input id="searchBorrower"
             placeholder="Search borrower..."
             onkeyup="debouncedSearch()">
      <button onclick="addBorrower()">âž• Add Borrower</button>
    </div>
    <div id="borrowerList"></div>
  </div>

  <div class="content" id="contentPanel">
    <div style="color:#999;">
      Select a borrower to view profile
    </div>
  </div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, addDoc,
  query, where, getDocs,
  doc, getDoc, updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let currentBorrowerId=null;
let borrowerCache=[];
let searchTimeout=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

/* NAV */
window.goDashboard=()=>location.href="agent-dashboard.html";
window.logoutUser=()=>signOut(auth);

/* ADD */
window.addBorrower=async()=>{
  const name=prompt("Borrower Name");
  const phone=prompt("Phone");

  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    nameLower:name.toLowerCase(),
    agentId:currentUserId,
    createdAt:Date.now()
  });

  loadBorrowers();
};

/* LOAD LIST */
async function loadBorrowers(){
  borrowerCache=[];

  const q=query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap=await getDocs(q);

  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });

  renderBorrowers(borrowerCache);
}

/* RENDER */
function renderBorrowers(list){
  borrowerList.innerHTML="";
  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="list-item"
      onclick="viewBorrower('${b.id}')">
        <b>${b.name}</b><br>
        ${b.phone}
      </div>`;
  });
}

/* SEARCH */
window.debouncedSearch=()=>{
  const value=
    searchBorrower.value.trim().toLowerCase();
  clearTimeout(searchTimeout);

  searchTimeout=setTimeout(()=>{
    if(!value){
      renderBorrowers(borrowerCache);
      return;
    }
    const filtered=borrowerCache.filter(b=>
      (b.name||"").toLowerCase().includes(value)||
      (b.phone||"").includes(value)
    );
    renderBorrowers(filtered);
  },300);
};

/* PROFILE */
window.viewBorrower=async(id)=>{
  currentBorrowerId=id;

  document.querySelector(".content")
    .style.display="block";

  const snap=await getDoc(
    doc(db,"borrowers",id)
  );

  const b=snap.data();

  contentPanel.innerHTML=`
    <div class="card">
      <h2>${b.name}</h2>
      ðŸ“ž <a href="tel:${b.phone}">
      ${b.phone}</a><br>
      ðŸ’¬ <a href="https://wa.me/${b.phone}"
      target="_blank">WhatsApp</a>
      <br><br>
      <button onclick="toggleLoanForm()">
      âž• Create Loan</button>
      <div id="loanFormSection"></div>
    </div>

    <div id="loanSection"></div>
    <div id="installmentSection"></div>
  `;

  loadLoans(id);
};

/* TOGGLE LOAN */
window.toggleLoanForm=()=>{
  const section=
    document.getElementById("loanFormSection");

  if(section.innerHTML!==""){
    section.innerHTML="";
    return;
  }

  section.innerHTML=`
    <div class="card">
      <input id="principalInput"
             placeholder="Principal">
      <input id="interestInput"
             placeholder="Interest %">
      <input id="countInput"
             placeholder="Installments">
      <select id="intervalInput">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>
      <input type="date" id="startInput">
      <button onclick="createLoan()">
        Confirm Loan
      </button>
    </div>`;
};

/* CREATE LOAN */
window.createLoan=async()=>{

  const principal=parseFloat(principalInput.value);
  const percent=parseFloat(interestInput.value);
  const count=parseInt(countInput.value);
  const interval=parseInt(intervalInput.value);
  const startValue=startInput.value;

  if(!principal||isNaN(percent)
     ||!count||!startValue){
    alert("Fill correctly");
    return;
  }

  const start=new Date(startValue).getTime();
  const interestAmount=
    (principal*percent)/100;

  const installmentAmount=
    principal/count;

  const loan=await addDoc(
    collection(db,"loans"),{
    borrowerId:currentBorrowerId,
    agentId:currentUserId,
    principal,
    interestPercent:percent,
    interestAmount,
    count,
    interval,
    startDate:start,
    status:"active"
  });

  for(let i=0;i<count;i++){
    await addDoc(
      collection(db,"installments"),{
        loanId:loan.id,
        borrowerId:currentBorrowerId,
        number:i+1,
        amount:installmentAmount,
        dueDate:start+
        ((i+1)*interval*86400000),
        status:"pending"
      });
  }

  document.getElementById(
    "loanFormSection").innerHTML="";

  loadLoans(currentBorrowerId);
};

/* LOAD LOANS */
async function loadLoans(id){

  const q=query(
    collection(db,"loans"),
    where("borrowerId","==",id)
  );

  const snap=await getDocs(q);

  let activeHTML=
    `<div class="card">
      <h3>Active Loans</h3>`;

  let completedHTML=
    `<div class="card gray">
      <h3>Completed Loans</h3>`;

  snap.forEach(d=>{
    const loan=d.data();
    const badge=
      loan.status==="active"
      ? `<span class="badge badge-active">
         Active</span>`
      : `<span class="badge badge-completed">
         Completed</span>`;

    const loanCard=`
      <div class="card ${loan.status!=="active"?"gray":""}">
      Loan â‚¹${loan.principal}<br>
      ${badge}
      <button onclick=
      "viewInstallments('${d.id}')">
      Installments</button>
      </div>`;

    if(loan.status==="active")
      activeHTML+=loanCard;
    else
      completedHTML+=loanCard;
  });

  activeHTML+="</div>";
  completedHTML+="</div>";

  loanSection.innerHTML=
    activeHTML+completedHTML;
}

/* INSTALLMENTS */
window.viewInstallments=
async(loanId)=>{

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  let list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  let total=0,paid=0;

  list.forEach(i=>{
    total+=i.amount;
    if(i.status==="completed")
      paid+=i.amount;
  });

  const percent=
    total?
    Math.round((paid/total)*100):0;

  installmentSection.innerHTML=`
    <div class="card">
    ${percent}% Paid
    <div class="progress">
      <div class="progress-bar"
      style="width:${percent}%"></div>
    </div>
    </div>`;

  list.forEach(i=>{
    installmentSection.innerHTML+=`
    <div class="card
    ${i.status!=="pending"?"gray":""}">
      Installment ${i.number}<br>
      â‚¹${i.amount}<br>
      ${i.status}
      ${
        i.status==="pending"?
        `<button onclick=
        "markPaid('${i.id}',
        '${loanId}',
        ${i.amount})">
        Mark Paid</button>`:""
      }
    </div>`;
  });
};

/* MARK */
window.markPaid=
async(instId,loanId,amount)=>{

  await updateDoc(
    doc(db,"installments",instId),
    {status:"completed"});

  await addDoc(
    collection(db,"collections"),{
      loanId,
      agentId:currentUserId,
      amount,
      type:"installment",
      date:Date.now()
    });

  viewInstallments(loanId);
};

</script>

</body>
</html>