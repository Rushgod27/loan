<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  Borrowers
</div>

<div class="nav">
  <div onclick="goDashboard()">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container">

  <!-- ACTION ICONS -->
  <div class="action-bar">
    <div class="icon-btn" onclick="toggleSearch()">üîç</div>
    <div class="icon-btn" onclick="toggleAdd()">‚ûï</div>
  </div>

  <!-- SEARCH -->
  <div id="searchSection" class="hidden card">
    <input id="searchInput" placeholder="Search by name or phone">
  </div>

  <!-- ADD -->
  <div id="addSection" class="hidden card">
    <input id="nameInput" placeholder="Borrower Name">
    <input id="phoneInput" placeholder="Phone Number">
    <button onclick="createBorrower()">Save Borrower</button>
  </div>

  <!-- LIST -->
  <div id="borrowerList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  addDoc,
  getDocs
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId = null;
let borrowerCache = [];

/* ================= AUTH PROTECTION ================= */
onAuthStateChanged(auth, user => {

  if(!user){
    window.location.href = "index.html";
    return;
  }

  currentUserId = user.uid;
  loadBorrowers();
});

/* ================= NAVIGATION ================= */
window.goDashboard = () => {
  window.location.href = "agent-dashboard.html";
};

window.logout = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

/* ================= TOGGLE SECTIONS ================= */
window.toggleSearch = () => {
  searchSection.classList.toggle("hidden");
  addSection.classList.add("hidden");
};

window.toggleAdd = () => {
  addSection.classList.toggle("hidden");
  searchSection.classList.add("hidden");
};

/* ================= CREATE BORROWER ================= */
window.createBorrower = async () => {

  const name = nameInput.value.trim();
  const phone = phoneInput.value.trim();

  if(!name || !phone){
    alert("Fill all fields");
    return;
  }

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    nameLower: name.toLowerCase(),
    agentId: currentUserId,
    createdAt: Date.now()
  });

  nameInput.value="";
  phoneInput.value="";
  addSection.classList.add("hidden");

  loadBorrowers();
};

/* ================= LOAD BORROWERS ================= */
async function loadBorrowers(){

  borrowerCache = [];

  const q = query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap = await getDocs(q);

  snap.forEach(d=>{
    borrowerCache.push({id:d.id, ...d.data()});
  });

  borrowerCache.sort((a,b)=>
    a.name.localeCompare(b.name)
  );

  renderBorrowers(borrowerCache);
}

/* ================= RENDER LIST ================= */
function renderBorrowers(list){

  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML =
    `<div class="card">No borrowers found</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML += `
      <div class="list-item"
        onclick="openProfile('${b.id}')">
        <b>${b.name}</b><br>
        ${b.phone}
      </div>
    `;
  });
}

/* ================= SEARCH ================= */
searchInput?.addEventListener("input", e => {

  const value = e.target.value.toLowerCase();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered = borrowerCache.filter(b =>
    b.name.toLowerCase().includes(value) ||
    b.phone.includes(value)
  );

  renderBorrowers(filtered);
});

/* ================= OPEN PROFILE ================= */
window.openProfile = (id) => {
  window.location.href = "borrower-profile.html?id="+id;
};

</script>
</body>
</html>