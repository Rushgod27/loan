<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css?v=15">
</head>
<body>

<div class="header">
  Borrowers
</div>

<div class="nav">
  <div onclick="goDashboard()">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container">

  <!-- ADD BUTTON -->
  <div class="card">
    <button class="btn btn-primary"
            onclick="toggleAddForm()">
      + Add Borrower
    </button>

    <div id="addSection" class="hidden" style="margin-top:15px;">
      <input id="nameInput" placeholder="Borrower Name">
      <input id="phoneInput" placeholder="Phone Number">
      <button class="btn btn-success"
              onclick="createBorrower()">
        Save Borrower
      </button>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <input id="searchInput"
           placeholder="Search by name or phone">
  </div>

  <!-- LIST -->
  <div id="borrowerList"></div>

</div>


<!-- ================= MODAL ================= -->
<div id="warningModal" class="modal hidden">
  <div class="modal-box">

    <div class="modal-header">
      ⚠ Borrower Exists
    </div>

    <div class="modal-body" id="modalMessage"></div>

    <div class="modal-actions">
      <button class="btn btn-danger"
              onclick="closeModal()">
        Cancel
      </button>

      <button class="btn btn-primary"
              id="confirmAddBtn">
        Add Anyway
      </button>
    </div>

  </div>
</div>


<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  addDoc,
  getDocs,
  doc,
  getDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId = null;
let borrowerCache = [];


/* ================= AUTH ================= */
onAuthStateChanged(auth, user => {

  if(!user){
    window.location.href = "index.html";
    return;
  }

  currentUserId = user.uid;
  loadBorrowers();
});

/* ================= NAVIGATION ================= */

window.goDashboard = () => {
  location.href = "agent-dashboard.html";
};

window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};

/* ================= ADD TOGGLE ================= */

window.toggleAddForm = () => {
  addSection.classList.toggle("hidden");
};

/* ================= CREATE BORROWER ================= */

window.createBorrower = async () => {

  const name = nameInput.value.trim();
  let phone = phoneInput.value.trim();

  if(!name || !phone){
    alert("Fill all fields");
    return;
  }

  phone = phone.replace(/\s+/g,"");

  try{

    /* 1️⃣ SAME AGENT CHECK */
    const sameQuery = query(
      collection(db,"borrowers"),
      where("agentId","==",currentUserId),
      where("phone","==",phone)
    );

    const sameSnap = await getDocs(sameQuery);

    if(!sameSnap.empty){
      showModal(
        "This borrower already exists under you.",
        null
      );
      return;
    }

    /* 2️⃣ OTHER AGENTS CHECK */
    const otherQuery = query(
      collection(db,"borrowers"),
      where("phone","==",phone)
    );

    const otherSnap = await getDocs(otherQuery);

    let agentsList = [];
    let activeLoanAgents = [];

    for(const docSnap of otherSnap.docs){

      const data = docSnap.data();

      if(data.agentId === currentUserId) continue;

      const agentSnap = await getDoc(
        doc(db,"users",data.agentId)
      );

      let agentName = "Unknown Agent";

      if(agentSnap.exists()){
        agentName = agentSnap.data().name;
      }

      agentsList.push(agentName);

      const loanQuery = query(
        collection(db,"loans"),
        where("borrowerId","==",docSnap.id),
        where("status","==","active")
      );

      const loanSnap = await getDocs(loanQuery);

      if(!loanSnap.empty){
        activeLoanAgents.push(agentName);
      }
    }

    if(agentsList.length > 0){

      let message =
        "<b>Borrower exists under:</b><br>" +
        agentsList.join("<br>");

      if(activeLoanAgents.length > 0){
        message += "<br><br><b>Active loan under:</b><br>" +
                   activeLoanAgents.join("<br>");
      }

      message += "<br><br>Do you want to add anyway?";

      showModal(message, async () => {

        await addDoc(collection(db,"borrowers"),{
          name,
          phone,
          nameLower:name.toLowerCase(),
          agentId: currentUserId,
          createdAt: Date.now()
        });

        resetForm();
      });

      return;
    }

    /* 3️⃣ CREATE DIRECTLY */
    await addDoc(collection(db,"borrowers"),{
      name,
      phone,
      nameLower:name.toLowerCase(),
      agentId: currentUserId,
      createdAt: Date.now()
    });

    resetForm();

  }catch(err){
    alert("Error: "+err.message);
  }
};


/* ================= RESET FORM ================= */

function resetForm(){
  nameInput.value="";
  phoneInput.value="";
  addSection.classList.add("hidden");
  loadBorrowers();
}

/* ================= LOAD BORROWERS ================= */

async function loadBorrowers(){

  borrowerCache = [];

  const q = query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap = await getDocs(q);

  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });

  borrowerCache.sort((a,b)=>a.name.localeCompare(b.name));

  renderBorrowers(borrowerCache);
}

/* ================= RENDER ================= */

function renderBorrowers(list){

  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML =
    `<div class="card">No borrowers found</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="card borrower-card"
           onclick="openProfile('${b.id}')">
        <div class="borrower-info">
          <b>${b.name}</b><br>
          <span>${b.phone}</span>
        </div>
      </div>
    `;
  });
}

/* ================= SEARCH ================= */

searchInput.addEventListener("input", e => {

  const value = e.target.value.toLowerCase();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered = borrowerCache.filter(b =>
    b.name.toLowerCase().includes(value) ||
    b.phone.includes(value)
  );

  renderBorrowers(filtered);
});

/* ================= PROFILE ================= */

window.openProfile = (id) => {
  location.href = "borrower-profile.html?id="+id;
};


/* ================= MODAL ================= */

window.closeModal = () => {
  warningModal.classList.add("hidden");
};

function showModal(message, onConfirm){

  modalMessage.innerHTML = message;
  warningModal.classList.remove("hidden");

  const btn = confirmAddBtn;

  if(!onConfirm){
    btn.style.display = "none";
    return;
  }

  btn.style.display = "inline-flex";

  btn.onclick = () => {
    warningModal.classList.add("hidden");
    onConfirm();
  };
}

</script>
</body>
</html>