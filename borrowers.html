<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/borrowers.css">
</head>
<body>

<div class="header">
  <span id="backBtn" class="back hidden"
        onclick="goBack()">â¬…</span>
  Borrowers
</div>

<!-- LIST SCREEN -->
<div id="listScreen">

  <div class="top-bar">
    <input id="searchInput"
      placeholder="Search borrower..."
      onkeyup="searchBorrowers()">
    <button onclick="addBorrower()">âž•</button>
  </div>

  <div id="borrowerList"></div>
</div>

<!-- PROFILE SCREEN -->
<div id="profileScreen" class="hidden">
  <div id="profileContent"></div>
  <div id="loansContainer"></div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, addDoc,
  query, where, getDocs,
  doc, getDoc, updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let currentBorrowerId=null;
let borrowerCache=[];

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

/* =========================
   LOAD BORROWERS LIST
========================= */

async function loadBorrowers(){
  borrowerCache=[];

  const snap=await getDocs(query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  ));

  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });

  renderBorrowers(borrowerCache);
}

function renderBorrowers(list){
  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML=
      `<div class="card">No Borrowers</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="list-item"
      onclick="viewBorrower('${b.id}')">
      <b>${b.name}</b><br>
      ${b.phone}
      </div>`;
  });
}

/* SEARCH */
window.searchBorrowers=()=>{
  const value=searchInput.value
    .toLowerCase().trim();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered=
    borrowerCache.filter(b=>
      (b.name||"").toLowerCase().includes(value)||
      (b.phone||"").includes(value)
    );

  renderBorrowers(filtered);
};

/* =========================
   ADD BORROWER
========================= */

window.addBorrower=async()=>{
  const name=prompt("Borrower Name");
  const phone=prompt("Phone");
  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    agentId:currentUserId,
    createdAt:Date.now()
  });

  loadBorrowers();
};

/* =========================
   VIEW BORROWER PROFILE
========================= */

window.viewBorrower=async(id)=>{
  currentBorrowerId=id;

  const snap=await getDoc(
    doc(db,"borrowers",id)
  );

  const b=snap.data();

  listScreen.classList.add("hidden");
  profileScreen.classList.remove("hidden");
  backBtn.classList.remove("hidden");

  profileContent.innerHTML=`
    <div class="card">
      <h2>${b.name}</h2>

      ðŸ“ž <a href="tel:${b.phone}">
      ${b.phone}</a><br>

      ðŸ’¬ <a href="https://wa.me/${b.phone}"
      target="_blank">
      WhatsApp</a><br>

      <button onclick="toggleLoanForm()">
      âž• Create Loan</button>

      <div id="loanForm"></div>
    </div>
  `;

  loadLoans(id);
};

window.goBack=()=>{
  profileScreen.classList.add("hidden");
  listScreen.classList.remove("hidden");
  backBtn.classList.add("hidden");
};

/* =========================
   LOAN FORM
========================= */

window.toggleLoanForm=()=>{

  const container=document.getElementById("loanForm");

  if(container.innerHTML!==""){
    container.innerHTML="";
    return;
  }

  container.innerHTML=`
    <div class="card">
      <input id="principal"
       placeholder="Principal">
      <input id="interest"
       placeholder="Interest %">
      <input id="count"
       placeholder="Installments">
      <button onclick="createLoan()">
       Confirm Loan</button>
    </div>`;
};

window.createLoan=async()=>{

  const principalVal=
    parseFloat(document.getElementById("principal").value);

  const percentVal=
    parseFloat(document.getElementById("interest").value);

  const countVal=
    parseInt(document.getElementById("count").value);

  if(!principalVal||isNaN(percentVal)||!countVal){
    alert("Fill all fields correctly");
    return;
  }

  const interestAmount=
    (principalVal*percentVal)/100;

  const installmentAmount=
    principalVal/countVal;

  const loan=await addDoc(
    collection(db,"loans"),{
      borrowerId:currentBorrowerId,
      agentId:currentUserId,
      principal:principalVal,
      interestPercent:percentVal,
      interestAmount,
      count:countVal,
      status:"active",
      createdAt:Date.now()
    });

  for(let i=0;i<countVal;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loan.id,
      borrowerId:currentBorrowerId,
      number:i+1,
      amount:installmentAmount,
      dueDate:Date.now()+((i+1)*7*86400000),
      status:"pending"
    });
  }

  document.getElementById("loanForm").innerHTML="";
  loadLoans(currentBorrowerId);
};

/* =========================
   LOAD LOANS + INSTALLMENTS
========================= */

async function loadLoans(borrowerId){

  const loanSnap=await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  loansContainer.innerHTML=`
    <div class="section-title">
    Active Loans</div>
    <div id="activeLoans"></div>

    <div class="section-title">
    Completed Loans</div>
    <div id="completedLoans"></div>
  `;

  const activeDiv=
    document.getElementById("activeLoans");

  const completedDiv=
    document.getElementById("completedLoans");

  for(const loanDoc of loanSnap.docs){

    const loan=loanDoc.data();
    const loanId=loanDoc.id;

    const instSnap=await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",loanId)
    ));

    let total=0;
    let paid=0;

    let pendingHTML="";
    let completedHTML="";

    const today=Date.now();

    instSnap.forEach(d=>{
      const i=d.data();
      total+=i.amount;

      const overdue=
        i.status==="pending" &&
        i.dueDate<today;

      const card=`
        <div class="card ${
          overdue ? "overdue" :
          i.status==="completed"
          ? "gray-out" : ""
        }">
        Installment ${i.number}<br>
        â‚¹${i.amount}<br>
        ðŸ“… ${new Date(i.dueDate)
          .toLocaleDateString("en-IN")}<br>
        Status: ${i.status}
        ${
          i.status==="pending"
          ? `<button onclick="
            markPaid('${d.id}',
            '${loanId}',
            ${i.amount})">
            Mark Paid</button>`
          : ""
        }
        </div>
      `;

      if(i.status==="completed"){
        paid+=i.amount;
        completedHTML+=card;
      }else{
        pendingHTML+=card;
      }
    });

    const percent=
      total?Math.round((paid/total)*100):0;

    const loanCard=`
      <div class="card ${
        loan.status!=="active"
        ? "gray-out" : ""
      }">
        <b>Loan â‚¹${loan.principal}</b><br>
        Interest: ${loan.interestPercent}%<br>
        Status: ${loan.status}
        <div class="progress">
          <div class="progress-bar"
            style="width:${percent}%">
          </div>
        </div>
        ${percent}% Paid
      </div>

      ${
        pendingHTML
        ? `<div class="section-title">
           Pending Installments
           </div>${pendingHTML}`
        : ""
      }

      ${
        completedHTML
        ? `<div class="section-title">
           Completed Installments
           </div>${completedHTML}`
        : ""
      }
    `;

    if(loan.status==="active"){
      activeDiv.innerHTML+=loanCard;
    }else{
      completedDiv.innerHTML+=loanCard;
    }
  }
}

/* =========================
   MARK PAID
========================= */

window.markPaid=async(instId,loanId,amount)=>{

  await updateDoc(
    doc(db,"installments",instId),
    {status:"completed"}
  );

  await addDoc(
    collection(db,"collections"),{
      loanId,
      borrowerId:currentBorrowerId,
      agentId:currentUserId,
      amount,
      type:"installment",
      date:Date.now()
  });

  loadLoans(currentBorrowerId);
};

</script>
</body>
</html>