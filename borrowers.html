<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/borrowers.css">
</head>
<body>

<div class="header">
  <span id="backBtn" class="back hidden"
        onclick="goBack()">â¬…</span>
  Borrowers
</div>

<!-- LIST -->
<div id="listScreen">
  <div class="top-bar">
    <input id="searchInput"
      placeholder="Search borrower..."
      onkeyup="searchBorrowers()">
    <button onclick="addBorrower()">âž•</button>
  </div>
  <div id="borrowerList"></div>
</div>

<!-- PROFILE -->
<div id="profileScreen" class="hidden">
  <div id="profileContent"></div>
  <div id="loansContainer"></div>
</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, addDoc,
  query, where, getDocs,
  onSnapshot,
  doc, getDoc, updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let currentBorrowerId=null;
let borrowerCache=[];
let unsubscribeLoans=null;

/* ============ AUTH ============ */

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

/* ============ LOAD BORROWERS ============ */

async function loadBorrowers(){
  borrowerCache=[];
  const snap=await getDocs(query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  ));
  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });
  renderBorrowers(borrowerCache);
}

function renderBorrowers(list){
  borrowerList.innerHTML="";
  if(list.length===0){
    borrowerList.innerHTML=
      `<div class="card">No Borrowers</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="list-item"
      onclick="viewBorrower('${b.id}')">
      <b>${b.name}</b><br>
      ${b.phone}
      </div>`;
  });
}

window.searchBorrowers=()=>{
  const value=searchInput.value
    .toLowerCase().trim();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered=
    borrowerCache.filter(b=>
      (b.name||"").toLowerCase().includes(value)||
      (b.phone||"").includes(value)
    );

  renderBorrowers(filtered);
};

window.addBorrower=async()=>{
  const name=prompt("Borrower Name");
  const phone=prompt("Phone");
  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name, phone,
    agentId:currentUserId,
    createdAt:Date.now()
  });

  loadBorrowers();
};

/* ============ PROFILE VIEW ============ */

window.viewBorrower=async(id)=>{

  currentBorrowerId=id;

  const snap=await getDoc(doc(db,"borrowers",id));
  const b=snap.data();

  listScreen.classList.add("hidden");
  profileScreen.classList.remove("hidden");
  backBtn.classList.remove("hidden");

  profileContent.innerHTML=`
    <div class="card">
      <h2>${b.name}</h2>

      ðŸ“ž <a href="tel:${b.phone}">
      ${b.phone}</a><br>

      ðŸ’¬ <a href="https://wa.me/${b.phone}"
      target="_blank">
      WhatsApp</a><br>

      <button onclick="toggleLoanForm()">
      âž• Create Loan</button>

      <div id="loanForm"></div>
    </div>
  `;

  loadLoans(id);
};

window.goBack=()=>{
  profileScreen.classList.add("hidden");
  listScreen.classList.remove("hidden");
  backBtn.classList.add("hidden");

  if(unsubscribeLoans) unsubscribeLoans();
};

/* ============ LOAN FORM ============ */

window.toggleLoanForm=()=>{
  const container=document.getElementById("loanForm");
  if(container.innerHTML!==""){
    container.innerHTML="";
    return;
  }

  container.innerHTML=`
    <div class="card">

      <input id="principal"
        placeholder="Principal">

      <input id="interest"
        placeholder="Interest %">

      <input id="count"
        placeholder="Installments">

      <select id="emiType">
        <option value="7">7 Days (Weekly)</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days (Monthly)</option>
      </select>

      <label style="font-size:13px;">
        Loan Start Date
      </label>
      <input type="date" id="loanStartDate">

      <button onclick="previewLoan()">
        Preview EMI
      </button>

      <div id="previewBox"></div>

    </div>`;
};

window.previewLoan=()=>{

  const principal=
    parseFloat(document.getElementById("principal").value);

  const percent=
    parseFloat(document.getElementById("interest").value);

  const count=
    parseInt(document.getElementById("count").value);

  const emiDays=
    parseInt(document.getElementById("emiType").value);

  const startInput=
    document.getElementById("loanStartDate").value;

  if(!principal||isNaN(percent)||!count||!startInput){
    alert("Fill correctly");
    return;
  }

  const startDate=
    new Date(startInput).getTime();

  const interestAmount=
    (principal*percent)/100;

  const installmentAmount=
    principal/count;

  const endDate=
    startDate + (count*emiDays*86400000);

  document.getElementById("previewBox")
  .innerHTML=`

  <div class="card" style="
    background:#f0f9ff;
    border-left:4px solid #2563eb;">

    Principal: â‚¹${principal}<br>
    Interest: â‚¹${interestAmount}<br>
    Installment: â‚¹${installmentAmount.toFixed(2)}<br>

    First Due:
    ${new Date(startDate+(emiDays*86400000))
      .toLocaleDateString("en-IN")}<br>

    Last Due:
    ${new Date(endDate)
      .toLocaleDateString("en-IN")}<br>

    <button onclick="createLoan()">
      Confirm Loan
    </button>
  </div>`;
};

window.createLoan=async()=>{

  const principal=
    parseFloat(document.getElementById("principal").value);

  const percent=
    parseFloat(document.getElementById("interest").value);

  const count=
    parseInt(document.getElementById("count").value);

  const emiDays=
    parseInt(document.getElementById("emiType").value);

  const startInput=
    document.getElementById("loanStartDate").value;

  if(!principal||isNaN(percent)||!count||!startInput){
    alert("Fill properly");
    return;
  }

  const startDate=
    new Date(startInput).getTime();

  const interestAmount=
    (principal*percent)/100;

  const installmentAmount=
    principal/count;

  const endDate=
    startDate + (count*emiDays*86400000);

  const loan=await addDoc(
    collection(db,"loans"),{
      borrowerId:currentBorrowerId,
      agentId:currentUserId,
      principal,
      interestPercent:percent,
      interestAmount,
      count,
      emiType:emiDays,
      startDate,
      endDate,
      status:"active",
      createdAt:Date.now()
  });

  for(let i=0;i<count;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loan.id,
      borrowerId:currentBorrowerId,
      number:i+1,
      amount:installmentAmount,
      dueDate:startDate+((i+1)*emiDays*86400000),
      status:"pending"
    });
  }

  document.getElementById("loanForm").innerHTML="";
};

/* ============ LOAD LOANS REALTIME ============ */

function loadLoans(borrowerId){

  if(unsubscribeLoans) unsubscribeLoans();

  const q=query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  );

  unsubscribeLoans=
  onSnapshot(q,async(snapshot)=>{

    loansContainer.innerHTML="";

    for(const loanDoc of snapshot.docs){

      const loan=loanDoc.data();
      const loanId=loanDoc.id;

      const instSnap=await getDocs(query(
        collection(db,"installments"),
        where("loanId","==",loanId)
      ));

      let total=0;
      let paid=0;
      let dueToday=0;

      const today=new Date();
      today.setHours(0,0,0,0);
      const tomorrow=new Date(today);
      tomorrow.setDate(today.getDate()+1);

      instSnap.forEach(d=>{
        const i=d.data();
        total+=i.amount;
        if(i.status==="completed") paid+=i.amount;

        const dueDate=new Date(i.dueDate);
        if(i.status==="pending" &&
           dueDate>=today &&
           dueDate<tomorrow){
          dueToday++;
        }
      });

      const percent=
        total?Math.round((paid/total)*100):0;

      const remaining=total-paid;

      loansContainer.innerHTML+=`
        <div class="card">

          <b>Loan â‚¹${loan.principal}</b><br>
          EMI: ${loan.emiType} days<br>
          Start:
          ${new Date(loan.startDate)
            .toLocaleDateString("en-IN")}<br>
          End:
          ${new Date(loan.endDate)
            .toLocaleDateString("en-IN")}<br>

          ${
            dueToday>0
            ? `<div style="color:#ef4444;
               font-weight:600;">
               âš  ${dueToday}
               Due Today</div>`
            : ""
          }

          <div class="progress">
            <div class="progress-bar"
              style="width:${percent}%">
            </div>
          </div>

          ${percent}% Paid<br>
          Remaining â‚¹${remaining}

          <button onclick=
           "toggleInst('${loanId}')">
           View Installments</button>

          <div id="inst-${loanId}"
           class="hidden"></div>

        </div>`;
    }
  });
}

window.toggleInst=
async(loanId)=>{

  const container=
    document.getElementById(`inst-${loanId}`);

  if(!container.classList.contains("hidden")){
    container.classList.add("hidden");
    container.innerHTML="";
    return;
  }

  container.classList.remove("hidden");

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  snap.forEach(d=>{
    const i=d.data();

    container.innerHTML+=`
      <div class="card">
        Installment ${i.number}<br>
        â‚¹${i.amount}<br>
        ${new Date(i.dueDate)
          .toLocaleDateString("en-IN")}
      </div>`;
  });
};

</script>
</body>
</html>