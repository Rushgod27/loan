<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css?v=20">
</head>
<body>

<div class="header">Borrowers</div>

<div class="nav">
  <div onclick="goDashboard()">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="section-content">

  <!-- ADD BORROWER -->
  <div class="card">
    <button type="button"
            class="btn btn-primary"
            onclick="toggleAdd()">
      + Add Borrower
    </button>

    <div id="addSection" class="hidden" style="margin-top:15px;">
      <input id="nameInput" placeholder="Borrower Name">
      <input id="phoneInput" placeholder="Phone Number">
      <button type="button"
              class="btn btn-success"
              onclick="createBorrower()">
        Save Borrower
      </button>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <input id="searchInput"
           placeholder="Search borrower by name or phone">
  </div>

  <!-- LIST -->
  <div id="borrowerList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  getDocs,
  addDoc,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId = null;
let borrowerCache = [];

/* ================= AUTH ================= */

onAuthStateChanged(auth, user => {

  if(!user){
    location.href = "index.html";
    return;
  }

  currentUserId = user.uid;
  loadBorrowers();
});

/* ================= NAVIGATION ================= */

window.goDashboard = () => {
  location.href = "agent-dashboard.html";
};

window.logout = async () => {
  await signOut(auth);
  location.href = "index.html";
};

/* ================= TOGGLE ADD ================= */

window.toggleAdd = () => {
  addSection.classList.toggle("hidden");
};

/* ================= CREATE BORROWER ================= */

window.createBorrower = async () => {

  const name = nameInput.value.trim();
  let phone = phoneInput.value.trim();

  if(!name || !phone){
    alert("Please enter name and phone");
    return;
  }

  phone = phone.replace(/\s+/g,"");

  try{

    /* ===== CHECK SAME AGENT ===== */
    const sameQuery = query(
      collection(db,"borrowers"),
      where("agentId","==",currentUserId),
      where("phone","==",phone)
    );

    const sameSnap = await getDocs(sameQuery);

    if(!sameSnap.empty){
      alert("Borrower already exists under you.");
      return;
    }

    /* ===== CHECK OTHER AGENTS ===== */
    const otherQuery = query(
      collection(db,"borrowers"),
      where("phone","==",phone)
    );

    const otherSnap = await getDocs(otherQuery);

    let otherAgents = [];

    for(const b of otherSnap.docs){

      const data = b.data();

      if(data.agentId === currentUserId) continue;

      const agentSnap = await getDoc(doc(db,"users",data.agentId));
      if(agentSnap.exists()){
        otherAgents.push(agentSnap.data().name);
      }
    }

    if(otherAgents.length > 0){
      const confirmAdd = confirm(
        "Borrower exists under:\n" +
        otherAgents.join(", ") +
        "\n\nAdd anyway?"
      );

      if(!confirmAdd) return;
    }

    /* ===== CREATE ===== */
    await addDoc(collection(db,"borrowers"),{
      name,
      phone,
      nameLower:name.toLowerCase(),
      agentId: currentUserId,
      createdAt: Date.now()
    });

    nameInput.value="";
    phoneInput.value="";
    addSection.classList.add("hidden");

    loadBorrowers();

  }catch(err){
    alert("Error: "+err.message);
  }
};

/* ================= LOAD BORROWERS ================= */

async function loadBorrowers(){

  borrowerCache = [];

  const q = query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap = await getDocs(q);

  snap.forEach(d=>{
    borrowerCache.push({id:d.id, ...d.data()});
  });

  borrowerCache.sort((a,b)=>a.name.localeCompare(b.name));

  renderBorrowers(borrowerCache);
}

/* ================= RENDER ================= */

function renderBorrowers(list){

  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML =
      `<div class="card">No borrowers found</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="card borrower-card"
           onclick="openProfile('${b.id}')">
        <div>
          <b>${b.name}</b><br>
          <span>${b.phone}</span>
        </div>
      </div>`;
  });
}

/* ================= SEARCH ================= */

searchInput.addEventListener("input", e=>{

  const value = e.target.value.toLowerCase();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered = borrowerCache.filter(b =>
    b.name.toLowerCase().includes(value) ||
    b.phone.includes(value)
  );

  renderBorrowers(filtered);
});

/* ================= OPEN PROFILE ================= */

window.openProfile = (id)=>{
  location.href = "borrower-profile.html?id="+id;
};

</script>
</body>
</html>