<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/borrowers.css">
</head>

<body>

<div class="header">
  <span id="backBtn" class="back hidden"
        onclick="goBack()">â¬…</span>
  Borrowers
</div>

<!-- LIST SCREEN -->
<div id="listScreen">

  <div class="top-bar">
    <input id="searchInput"
      placeholder="Search borrower..."
      onkeyup="searchBorrowers()">
    <button onclick="addBorrower()">âž•</button>
  </div>

  <div id="borrowerList"></div>

</div>

<!-- PROFILE SCREEN -->
<div id="profileScreen" class="hidden"></div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection, addDoc,
  query, where, getDocs,
  doc, getDoc, updateDoc
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let borrowerCache=[];
let currentBorrowerId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

/* LOAD BORROWERS */
async function loadBorrowers(){
  borrowerCache=[];
  const snap=await getDocs(query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  ));
  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });
  renderBorrowers(borrowerCache);
}

function renderBorrowers(list){
  borrowerList.innerHTML="";
  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="list-item"
      onclick="viewBorrower('${b.id}')">
      <b>${b.name}</b><br>
      ${b.phone}
      </div>`;
  });
}

/* SEARCH */
window.searchBorrowers=()=>{
  const value=searchInput.value
    .toLowerCase().trim();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered=
  borrowerCache.filter(b=>
    b.name.toLowerCase().includes(value)||
    b.phone.includes(value)
  );

  renderBorrowers(filtered);
};

/* ADD BORROWER */
window.addBorrower=async()=>{
  const name=prompt("Borrower Name");
  const phone=prompt("Phone");
  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    agentId:currentUserId,
    createdAt:Date.now()
  });

  loadBorrowers();
};

/* VIEW PROFILE */
window.viewBorrower=async(id)=>{
  currentBorrowerId=id;

  const snap=await getDoc(
    doc(db,"borrowers",id)
  );

  const b=snap.data();

  listScreen.classList.add("hidden");
  profileScreen.classList.remove("hidden");
  backBtn.classList.remove("hidden");

  profileScreen.innerHTML=`
    <div class="card">
      <h2>${b.name}</h2>
      ðŸ“ž <a href="tel:${b.phone}">
      ${b.phone}</a><br>
      ðŸ’¬ <a href="https://wa.me/${b.phone}"
      target="_blank">
      WhatsApp</a><br>

      <button onclick="toggleLoanForm()">
      âž• Create Loan</button>

      <div id="loanForm"></div>
    </div>

    <div id="loansContainer"></div>
  `;

  loadLoans(id);
};

/* BACK */
window.goBack=()=>{
  profileScreen.classList.add("hidden");
  listScreen.classList.remove("hidden");
  backBtn.classList.add("hidden");
};

/* CREATE LOAN FORM */
window.toggleLoanForm=()=>{
  if(loanForm.innerHTML!==""){
    loanForm.innerHTML="";
    return;
  }

  loanForm.innerHTML=`
    <div class="card">
    <input id="principal"
      placeholder="Principal">
    <input id="interest"
      placeholder="Interest %">
    <input id="count"
      placeholder="Installments">
    <button onclick="createLoan()">
      Confirm
    </button>
    </div>`;
};

/* CREATE LOAN */
window.createLoan=async()=>{
  const principal=parseFloat(principal.value);
  const percent=parseFloat(interest.value);
  const count=parseInt(count.value);

  if(!principal||isNaN(percent)||!count){
    alert("Fill properly");
    return;
  }

  const interestAmount=
    (principal*percent)/100;

  const installmentAmount=
    principal/count;

  const loan=await addDoc(
    collection(db,"loans"),{
      borrowerId:currentBorrowerId,
      agentId:currentUserId,
      principal,
      interestPercent:percent,
      interestAmount,
      count,
      status:"active",
      createdAt:Date.now()
    });

  for(let i=0;i<count;i++){
    await addDoc(
      collection(db,"installments"),{
        loanId:loan.id,
        borrowerId:currentBorrowerId,
        number:i+1,
        amount:installmentAmount,
        dueDate:Date.now()+((i+1)*7*86400000),
        status:"pending"
      });
  }

  loanForm.innerHTML="";
  loadLoans(currentBorrowerId);
};

/* LOAD LOANS */
async function loadLoans(borrowerId){
  const snap=await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  loansContainer.innerHTML="";

  for(const docSnap of snap.docs){
    const loan=docSnap.data();

    const instSnap=await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",docSnap.id)
    ));

    let total=0;
    let paid=0;

    instSnap.forEach(i=>{
      total+=i.data().amount;
      if(i.data().status==="completed"){
        paid+=i.data().amount;
      }
    });

    const percent=
      total?Math.round((paid/total)*100):0;

    loansContainer.innerHTML+=`
      <div class="card ${
        loan.status!=="active"?
        "gray-out":""}">
        Loan â‚¹${loan.principal}
        <div class="progress">
        <div class="progress-bar"
          style="width:${percent}%">
        </div>
        </div>
        ${percent}% paid
      </div>`;
  }
}

</script>
</body>
</html>