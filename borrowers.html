<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">
  Borrowers
</div>

<div class="nav">
  <div onclick="goDashboard()">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="container">

  <!-- SEARCH & ADD BAR -->
  <div class="card" style="margin-bottom:20px;">
    <div style="display:flex; gap:10px;">
      <input id="searchInput"
             placeholder="Search by name or phone"
             style="flex:1;">
<button class="btn btn-primary"
        onclick="toggleAddForm()">
  + Add Borrower
</button>
    </div>

<div id="addSection" class="hidden add-box">
      <input id="nameInput" placeholder="Borrower Name">
      <input id="phoneInput" placeholder="Phone Number">
<button class="btn btn-success"
        onclick="createBorrower()">
  Save Borrower
</button>
    </div>
  </div>

  <!-- BORROWER LIST -->
  <div id="borrowerList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";

import {
  onAuthStateChanged,
  signOut
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  collection,
  query,
  where,
  addDoc,
  getDocs
} from
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId = null;
let borrowerCache = [];

/* ================= AUTH ================= */
onAuthStateChanged(auth, user => {
  if(!user){
    window.location.href = "index.html";
    return;
  }
  currentUserId = user.uid;
  loadBorrowers();
});

/* ================= NAVIGATION ================= */
window.goDashboard = () => {
  window.location.href = "agent-dashboard.html";
};

window.logout = async () => {
  await signOut(auth);
  window.location.href = "index.html";
};

/* ================= TOGGLE ADD ================= */
window.toggleAddForm = () => {
  document.getElementById("addSection")
    .classList.toggle("hidden");
};

/* ================= CREATE BORROWER ================= */
window.createBorrower = async () => {

  const name = nameInput.value.trim();
  const phone = phoneInput.value.trim();

  if(!name || !phone){
    alert("Fill all fields");
    return;
  }

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    nameLower: name.toLowerCase(),
    agentId: currentUserId,
    createdAt: Date.now()
  });

  nameInput.value="";
  phoneInput.value="";
  document.getElementById("addSection")
    .classList.add("hidden");

  loadBorrowers();
};

/* ================= LOAD BORROWERS ================= */
async function loadBorrowers(){

  borrowerCache = [];

  const q = query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap = await getDocs(q);

  snap.forEach(d=>{
    borrowerCache.push({id:d.id, ...d.data()});
  });

  borrowerCache.sort((a,b)=>
    a.name.localeCompare(b.name)
  );

  renderBorrowers(borrowerCache);
}

/* ================= RENDER ================= */
function renderBorrowers(list){

  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML =
    `<div class="card">No borrowers found</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML += `
      <div class="card borrower-card"
        onclick="openProfile('${b.id}')"
        style="cursor:pointer; margin-bottom:15px;">
        
        <div style="font-weight:600; font-size:16px;">
          ${b.name}
        </div>

        <div style="color:#6b7280; margin-top:4px;">
          ${b.phone}
        </div>

      </div>
    `;
  });
}

/* ================= SEARCH ================= */
searchInput.addEventListener("input", e => {

  const value = e.target.value.toLowerCase();

  if(!value){
    renderBorrowers(borrowerCache);
    return;
  }

  const filtered = borrowerCache.filter(b =>
    b.name.toLowerCase().includes(value) ||
    b.phone.includes(value)
  );

  renderBorrowers(filtered);
});

/* ================= OPEN PROFILE ================= */
window.openProfile = (id) => {
  window.location.href = "borrower-profile.html?id="+id;
};

</script>
</body>
</html>