<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">

<style>
.overdue{background:#fee2e2}
.badge{
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  color:#fff;
}
.badge-active{background:#22c55e}
.badge-completed{background:#6b7280}
.loan-section-title{
  margin:14px 0 6px;
  font-weight:600;
}
.progress{
  height:8px;
  background:#e5e7eb;
  border-radius:8px;
  overflow:hidden;
}
.progress-bar{
  height:100%;
  background:#22c55e;
}
.action-link{
  text-decoration:none;
  font-weight:600;
}
</style>

</head>
<body>

<div class="header">Agent Panel</div>

<div class="nav">
  <div onclick="location.href='agent-dashboard.html'">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logoutUser()">Logout</div>
</div>

<div class="section-content">

<div class="card">
<input id="searchBorrower" placeholder="Search borrower...">
<button onclick="addBorrower()">Add Borrower</button>
</div>

<div id="borrowerList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, addDoc, query, where,
getDocs, doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let borrowerCache=[];

const borrowerList =
  document.getElementById("borrowerList");

const searchInput =
  document.getElementById("searchBorrower");

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){ location.href="index.html"; return; }
  currentUserId=user.uid;
  loadBorrowers();
});

/* LOGOUT */
window.logoutUser=()=>signOut(auth);

/* ADD BORROWER */
window.addBorrower=async()=>{
  const name=prompt("Borrower Name");
  const phone=prompt("Phone");
  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name, phone,
    nameLower:name.toLowerCase(),
    agentId:currentUserId,
    createdAt:Date.now()
  });

  loadBorrowers();
};

/* LOAD BORROWERS */
async function loadBorrowers(){
  borrowerCache=[];
  const q=query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );
  const snap=await getDocs(q);
  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });
  renderBorrowers(borrowerCache);
}

/* RENDER LIST */
function renderBorrowers(list){
  borrowerList.innerHTML="";
  if(list.length===0){
    borrowerList.innerHTML=
    `<div class="card">No Borrowers</div>`;
    return;
  }
  list.forEach(b=>{
    borrowerList.innerHTML+=`
    <div class="card"
      onclick="viewBorrower('${b.id}')">
      <b>${b.name}</b><br>
      ${b.phone}
    </div>`;
  });
}

/* SEARCH */
searchInput.addEventListener("keyup",()=>{
  const val=searchInput.value.trim().toLowerCase();
  if(!val){ renderBorrowers(borrowerCache); return; }
  const filtered=borrowerCache.filter(b=>{
    return (b.name||"").toLowerCase().includes(val)
     || (b.phone||"").includes(val);
  });
  renderBorrowers(filtered);
});

/* VIEW BORROWER */
window.viewBorrower=async(id)=>{
  const snap=await getDoc(doc(db,"borrowers",id));
  const b=snap.data();

  borrowerList.innerHTML=`
  <div class="card">
    <h2>${b.name}</h2>

    ðŸ“ž <a href="tel:${b.phone}"
        class="action-link">
        ${b.phone}
    </a><br><br>

    ðŸ’¬ <a href="https://wa.me/${b.phone}"
        target="_blank"
        style="color:#22c55e"
        class="action-link">
        WhatsApp
    </a><br><br>

    <button onclick="showLoanForm('${id}')">
      âž• Create Loan
    </button>

    <div id="loanFormContainer"></div>
  </div>

  <div id="activeLoans"></div>
  <div id="completedLoans"></div>
  `;

  loadLoans(id);
};

/* LOAN FORM (No duplicate) */
window.showLoanForm=(borrowerId)=>{
  const container =
    document.getElementById("loanFormContainer");

  if(container.innerHTML!=="") return;

  container.innerHTML=`
  <div class="card">
    <input id="principalInput"
      placeholder="Principal">
    <input id="interestInput"
      placeholder="Interest %">
    <input id="countInput"
      placeholder="Installments">
    <select id="intervalInput">
      <option value="7">7 Days</option>
      <option value="15">15 Days</option>
      <option value="30">30 Days</option>
    </select>
    <input type="date" id="startInput">
    <button onclick="createLoan('${borrowerId}')">
      Confirm Loan
    </button>
  </div>`;
};

/* CREATE LOAN */
window.createLoan=async(borrowerId)=>{
  const principal=
   parseFloat(document.getElementById("principalInput").value);
  const percent=
   parseFloat(document.getElementById("interestInput").value);
  const count=
   parseInt(document.getElementById("countInput").value);
  const interval=
   parseInt(document.getElementById("intervalInput").value);
  const startValue=
   document.getElementById("startInput").value;

  if(!principal||isNaN(percent)
     ||!count||!startValue){
    alert("Fill correctly"); return;
  }

  const start=new Date(startValue).getTime();
  const interestAmount=(principal*percent)/100;
  const installmentAmount=principal/count;

  const loan=await addDoc(collection(db,"loans"),{
    borrowerId,
    agentId:currentUserId,
    principal,
    interestPercent:percent,
    interestAmount,
    count,
    interval,
    startDate:start,
    status:"active",
    createdAt:Date.now()
  });

  await addDoc(collection(db,"collections"),{
    loanId:loan.id,
    borrowerId,
    agentId:currentUserId,
    amount:interestAmount,
    type:"upfront_interest",
    date:Date.now()
  });

  for(let i=0;i<count;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loan.id,
      borrowerId,
      number:i+1,
      amount:installmentAmount,
      dueDate:start+((i+1)*interval*86400000),
      status:"pending"
    });
  }

  alert("Loan Created");
  viewBorrower(borrowerId);
};

/* LOAD LOANS */
async function loadLoans(borrowerId){

  const activeDiv=
    document.getElementById("activeLoans");
  const completedDiv=
    document.getElementById("completedLoans");

  activeDiv.innerHTML=
    `<div class="loan-section-title">Active Loans</div>`;
  completedDiv.innerHTML=
    `<div class="loan-section-title">Completed Loans</div>`;

  const snap=await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  for(const d of snap.docs){

    const loan=d.data();

    const instSnap=await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",d.id)
    ));

    let total=0, paid=0;
    instSnap.forEach(i=>{
      total+=i.data().amount;
      if(i.data().status==="completed") paid+=i.data().amount;
    });

    const percent=
      total?Math.round((paid/total)*100):0;

    const badge=
      loan.status==="active"
      ? "<span class='badge badge-active'>Active</span>"
      : "<span class='badge badge-completed'>Completed</span>";

    const card=`
    <div class="card">
      <div style="display:flex;justify-content:space-between;">
        <b>â‚¹${loan.principal}</b>
        ${badge}
      </div>
      <small>
      Start:
      ${new Date(loan.startDate)
      .toLocaleDateString("en-IN")}
      </small>

      <div class="progress"
        style="margin-top:6px;">
        <div class="progress-bar"
        style="width:${percent}%"></div>
      </div>
      ${percent}% paid

      <button style="margin-top:10px"
        onclick="viewInstallments('${d.id}')">
        View Installments
      </button>
    </div>`;

    loan.status==="active"
     ? activeDiv.innerHTML+=card
     : completedDiv.innerHTML+=card;
  }
}

/* INSTALLMENTS */
window.viewInstallments=async(loanId)=>{

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  borrowerList.innerHTML=
  `<div class="card">
   <button onclick="loadBorrowers()">
   Back</button></div>`;

  let installments=[];
  snap.forEach(d=>{
    installments.push({id:d.id,...d.data()});
  });

  installments.sort((a,b)=>a.number-b.number);

  installments.forEach(i=>{
    const overdue=
     i.status==="pending"
     && i.dueDate<Date.now();

    borrowerList.innerHTML+=`
    <div class="card ${overdue?'overdue':''}">
      Installment ${i.number}<br>
      â‚¹${i.amount}<br>
      ðŸ“… ${new Date(i.dueDate)
      .toLocaleDateString("en-IN")}<br>
      ${i.status}
      ${
      i.status==="pending"
      ? `<button onclick="
         markPaid('${i.id}',
         '${loanId}',
         ${i.amount})">
         Mark Paid</button>`
      : ""
      }
    </div>`;
  });
};

/* MARK PAID + AUTO COMPLETE + WA */
window.markPaid=async(instId,loanId,amount)=>{

  await updateDoc(
    doc(db,"installments",instId),
    {status:"completed"}
  );

  await addDoc(collection(db,"collections"),{
    loanId,
    agentId:currentUserId,
    amount,
    type:"installment",
    date:Date.now()
  });

  const instSnap=
    await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",loanId)
    ));

  let allPaid=true;
  let borrowerId=null;

  instSnap.forEach(d=>{
    borrowerId=d.data().borrowerId;
    if(d.data().status!=="completed")
      allPaid=false;
  });

  if(allPaid){
    await updateDoc(doc(db,"loans",loanId),
    {status:"completed"});

    const borrowerSnap=
      await getDoc(
        doc(db,"borrowers",borrowerId)
      );

    if(borrowerSnap.exists()){
      const b=borrowerSnap.data();

      const message=
      `Dear ${b.name},

ðŸŽ‰ Congratulations!

Your loan has been fully completed.
Thank you for your timely payments.`;

      window.open(
      `https://wa.me/${b.phone}?text=${
      encodeURIComponent(message)
      }`,
      "_blank");
    }
  }

  viewInstallments(loanId);
};

</script>
</body>
</html>