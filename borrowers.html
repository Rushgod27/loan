<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

/* ===== GLOBAL ===== */

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui;
  background:#f4f6f9;
  color:#1f2937;
}

.app{
  display:flex;
  height:100vh;
}

/* ===== SIDEBAR ===== */

.sidebar{
  width:340px;
  background:#ffffff;
  border-right:1px solid #e5e7eb;
  display:flex;
  flex-direction:column;
}

.sidebar-header{
  padding:20px;
  font-size:20px;
  font-weight:600;
  border-bottom:1px solid #e5e7eb;
}

.search-box{
  padding:16px;
}

.search-box input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #d1d5db;
}

.borrower-list{
  flex:1;
  overflow:auto;
}

.borrower-item{
  padding:16px;
  border-bottom:1px solid #f1f5f9;
  cursor:pointer;
  transition:0.2s;
}

.borrower-item:hover{
  background:#f1f5f9;
}

/* ===== CONTENT PANEL ===== */

.content{
  flex:1;
  padding:30px;
  overflow:auto;
}

.placeholder{
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  color:#6b7280;
}

/* ===== CARDS ===== */

.card{
  background:white;
  padding:20px;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.04);
  margin-bottom:20px;
}

.section-title{
  font-size:18px;
  font-weight:600;
  margin:24px 0 12px;
}

/* ===== BADGES ===== */

.badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  margin-left:8px;
}

.badge-active{
  background:#dcfce7;
  color:#166534;
}

.badge-complete{
  background:#e5e7eb;
  color:#6b7280;
}

/* ===== PROGRESS ===== */

.progress{
  height:8px;
  background:#e5e7eb;
  border-radius:8px;
  overflow:hidden;
  margin:8px 0;
}

.progress-bar{
  height:100%;
  background:#2563eb;
}

/* ===== BUTTON ===== */

button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:white;
  font-weight:600;
  cursor:pointer;
}

/* ===== MOBILE BEHAVIOR ===== */

.hidden-mobile{
  display:block;
}

@media(max-width:900px){

  .app{
    flex-direction:column;
  }

  .sidebar{
    width:100%;
    height:100vh;
  }

  .content{
    width:100%;
    height:100vh;
  }

  .hidden-mobile{
    display:none;
  }

}

.loan-gray{
  opacity:.6;
}

.installment-overdue{
  border-left:4px solid red;
}

</style>
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">

    <div class="sidebar-header">
      Borrowers
    </div>

    <div class="search-box">
      <input id="searchBorrower"
             placeholder="Search borrower...">
    </div>

    <div class="borrower-list"
         id="borrowerList">
    </div>

  </div>

  <!-- CONTENT -->
  <div class="content hidden-mobile"
       id="contentPanel">

    <div class="placeholder">
      Select a borrower to view profile
    </div>

  </div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, query, where,
getDocs, doc, getDoc,
addDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let borrowerCache=[];
let currentBorrowerId=null;

const borrowerList=document.getElementById("borrowerList");
const contentPanel=document.getElementById("contentPanel");

/* AUTH */

onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

/* LOAD BORROWERS */

async function loadBorrowers(){
  borrowerCache=[];
  const snap=await getDocs(query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  ));
  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });
  renderBorrowers(borrowerCache);
}

function renderBorrowers(list){
  borrowerList.innerHTML="";
  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="borrower-item"
        onclick="viewBorrower('${b.id}')">
        <strong>${b.name}</strong><br>
        ${b.phone}
      </div>
    `;
  });
}

/* SEARCH */

document.getElementById("searchBorrower")
.addEventListener("keyup",function(){

  const val=this.value.toLowerCase();

  const filtered=borrowerCache.filter(b=>{
    return b.name.toLowerCase().includes(val)
        || b.phone.includes(val);
  });

  renderBorrowers(filtered);
});

/* VIEW BORROWER */

window.viewBorrower = async(id)=>{

  currentBorrowerId=id;

  const snap=await getDoc(doc(db,"borrowers",id));
  const b=snap.data();

  // MOBILE toggle
  if(window.innerWidth<=900){
    document.getElementById("sidebar").style.display="none";
    document.getElementById("contentPanel")
      .classList.remove("hidden-mobile");
  }

  contentPanel.innerHTML=`
    <div class="card">
      <button onclick="goBack()">â¬… Back</button>

      <h2>${b.name}</h2>

      ðŸ“ž <a href="tel:${b.phone}">
        ${b.phone}
      </a><br><br>

      ðŸ’¬ <a href="https://wa.me/${b.phone}"
           target="_blank">
        WhatsApp
      </a>
    </div>

    <div id="loanSection"></div>
    <div id="installmentSection"></div>
  `;

  loadLoans(id);
};

window.goBack=()=>{
  if(window.innerWidth<=900){
    document.getElementById("sidebar")
      .style.display="block";
    document.getElementById("contentPanel")
      .classList.add("hidden-mobile");
  }
};

/* LOAD LOANS */

async function loadLoans(borrowerId){

  const loanSection=document.getElementById("loanSection");
  loanSection.innerHTML=
    `<div class="section-title">Loans</div>`;

  const snap=await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  for(const d of snap.docs){

    const loan=d.data();

    loanSection.innerHTML+=`
      <div class="card ${
        loan.status==='completed'
        ? 'loan-gray':''
      }">

        â‚¹${loan.principal}

        <span class="badge ${
          loan.status==='active'
          ?'badge-active'
          :'badge-complete'
        }">
          ${loan.status}
        </span>

        <div>
          Start:
          ${new Date(loan.startDate)
          .toLocaleDateString("en-IN")}
        </div>

        <button onclick="
          viewInstallments('${d.id}')">
          View Installments
        </button>

      </div>
    `;
  }
}

/* INSTALLMENTS */

window.viewInstallments = async(loanId)=>{

  const section=document
    .getElementById("installmentSection");

  section.innerHTML=
    `<div class="section-title">
     Installments
     </div>`;

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  snap.forEach(d=>{

    const i=d.data();
    const overdue=
      i.status==='pending' &&
      i.dueDate<Date.now();

    section.innerHTML+=`
      <div class="card ${
        i.status==='completed'
        ?'loan-gray':''
      } ${
        overdue
        ?'installment-overdue':''
      }">

      Installment ${i.number}<br>
      â‚¹${i.amount}<br>
      ðŸ“… ${new Date(i.dueDate)
       .toLocaleDateString("en-IN")}<br>
      Status: ${i.status}

      ${
        i.status==='pending'
        ? `<button onclick="
            markPaid(
            '${d.id}',
            '${loanId}',
            ${i.amount})">
            Mark Paid
          </button>`
        : ""
      }

      </div>
    `;
  });
};

/* MARK PAID */

window.markPaid =
async(instId,loanId,amount)=>{

  await updateDoc(doc(
    db,"installments",instId),
    {status:"completed"}
  );

  await addDoc(
    collection(db,"collections"),{
      loanId,
      agentId:currentUserId,
      amount,
      date:Date.now()
  });

  viewInstallments(loanId);
};

</script>

</body>
</html>