<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">

<style>
.top-actions{
  display:flex;
  justify-content:flex-end;
  gap:12px;
  margin:14px;
}

.icon-btn{
  width:42px;
  height:42px;
  border-radius:50%;
  background:#2563eb;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  cursor:pointer;
}

.action-panel{
  background:white;
  margin:0 14px 14px;
  padding:14px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.hidden{display:none;}

.badge{
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  color:#fff;
}

.badge-active{background:#22c55e;}
.badge-completed{background:#6b7280;}

.progress{
  height:8px;
  background:#e5e7eb;
  border-radius:8px;
  overflow:hidden;
  margin-top:6px;
}

.progress-bar{
  height:100%;
  background:#22c55e;
}

.overdue{
  background:#fee2e2;
}
</style>
</head>

<body>

<div class="header">Agent Panel</div>

<div class="nav">
  <div onclick="location.href='agent-dashboard.html'">Dashboard</div>
  <div class="active">Borrowers</div>
  <div onclick="logoutUser()">Logout</div>
</div>

<div class="section-content">

  <div class="top-actions">
    <div class="icon-btn" onclick="toggleSearch()">üîç</div>
    <div class="icon-btn" onclick="toggleAdd()">‚ûï</div>
  </div>

  <div id="searchContainer" class="action-panel hidden">
    <input id="searchBorrower" placeholder="Search borrower...">
  </div>

  <div id="addContainer" class="action-panel hidden">
    <input id="newName" placeholder="Borrower Name">
    <input id="newPhone" placeholder="Phone">
    <button onclick="confirmAdd()">Save Borrower</button>
  </div>

  <div id="borrowerList"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
collection, addDoc, query, where,
getDocs, doc, getDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let borrowerCache=[];
let currentBorrowerId=null;

const borrowerList=document.getElementById("borrowerList");
const searchInput=document.getElementById("searchBorrower");

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){ location.href="index.html"; return; }
  currentUserId=user.uid;
  loadBorrowers();
});

window.logoutUser=()=>signOut(auth);

/* TOGGLES */
window.toggleSearch=()=>{
  searchContainer.classList.toggle("hidden");
  addContainer.classList.add("hidden");
};

window.toggleAdd=()=>{
  addContainer.classList.toggle("hidden");
  searchContainer.classList.add("hidden");
};

/* ADD */
window.confirmAdd=async()=>{
  const name=newName.value.trim();
  const phone=newPhone.value.trim();
  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name,phone,
    nameLower:name.toLowerCase(),
    agentId:currentUserId,
    createdAt:Date.now()
  });

  newName.value="";
  newPhone.value="";
  addContainer.classList.add("hidden");
  loadBorrowers();
};

/* LOAD LIST */
async function loadBorrowers(){
  currentBorrowerId=null;
  borrowerCache=[];
  const q=query(collection(db,"borrowers"),
    where("agentId","==",currentUserId));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });
  renderBorrowers(borrowerCache);
}

function renderBorrowers(list){
  borrowerList.innerHTML="";
  if(list.length===0){
    borrowerList.innerHTML=
    `<div class="card">No Borrowers</div>`;
    return;
  }
  list.forEach(b=>{
    borrowerList.innerHTML+=`
    <div class="card"
      onclick="viewBorrower('${b.id}')">
      <b>${b.name}</b><br>${b.phone}
    </div>`;
  });
}

/* SEARCH */
searchInput.addEventListener("keyup",()=>{
  const val=searchInput.value.trim().toLowerCase();
  if(!val){ renderBorrowers(borrowerCache); return; }
  const filtered=borrowerCache.filter(b=>{
    return (b.name||"").toLowerCase().includes(val)
       || (b.phone||"").includes(val);
  });
  renderBorrowers(filtered);
});

/* PROFILE VIEW */
window.viewBorrower=async(id)=>{
  currentBorrowerId=id;

  const snap=await getDoc(doc(db,"borrowers",id));
  const b=snap.data();

  borrowerList.innerHTML=`
    <div class="card">
      <h2>${b.name}</h2>

      üìû <a href="tel:${b.phone}">
        ${b.phone}
      </a><br><br>

      üí¨ <a href="https://wa.me/${b.phone}"
            target="_blank"
            style="color:#22c55e">
         WhatsApp
      </a><br><br>

      <button onclick="showLoanForm('${id}')">
        ‚ûï Create Loan
      </button>

      <div id="loanFormContainer"></div>
    </div>

    <div id="loanContent"></div>
  `;

  loadLoans(id);
};

/* SHOW LOAN FORM */
window.showLoanForm=(borrowerId)=>{
  const container=
    document.getElementById("loanFormContainer");

  if(container.innerHTML!=="") return;

  container.innerHTML=`
    <div class="card">
      <input id="principalInput" placeholder="Principal">
      <input id="interestInput" placeholder="Interest %">
      <input id="countInput" placeholder="Installments">
      <select id="intervalInput">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>
      <input type="date" id="startInput">
      <button onclick="createLoan('${borrowerId}')">
        Confirm Loan
      </button>
    </div>
  `;
};

/* CREATE LOAN */
window.createLoan=async(borrowerId)=>{

  const principal=parseFloat(principalInput.value);
  const percent=parseFloat(interestInput.value);
  const count=parseInt(countInput.value);
  const interval=parseInt(intervalInput.value);
  const startValue=startInput.value;

  if(!principal||isNaN(percent)
     ||!count||!startValue){ alert("Fill correctly");return;}

  const start=new Date(startValue).getTime();
  const installmentAmount=principal/count;
  const interestAmount=(principal*percent)/100;

  const loan=await addDoc(collection(db,"loans"),{
    borrowerId,
    agentId:currentUserId,
    principal,
    interestPercent:percent,
    interestAmount,
    count,
    interval,
    startDate:start,
    status:"active",
    createdAt:Date.now()
  });

  await addDoc(collection(db,"collections"),{
    loanId:loan.id,
    agentId:currentUserId,
    amount:interestAmount,
    type:"upfront_interest",
    date:Date.now()
  });

  for(let i=0;i<count;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loan.id,
      borrowerId,
      number:i+1,
      amount:installmentAmount,
      dueDate:start+(i+1)*interval*86400000,
      status:"pending"
    });
  }

  alert("Loan Created");
  viewBorrower(borrowerId);
};

/* LOAD LOANS */
async function loadLoans(borrowerId){

  const loanContent=document.getElementById("loanContent");
  loanContent.innerHTML="";

  const snap=await getDocs(query(
    collection(db,"loans"),
    where("borrowerId","==",borrowerId)
  ));

  if(snap.empty){
    loanContent.innerHTML=
    `<div class="card">No Loans</div>`;
    return;
  }

  for(const d of snap.docs){
    const loan=d.data();

    const instSnap=await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",d.id)
    ));

    let total=0,paid=0;
    instSnap.forEach(i=>{
      total+=i.data().amount;
      if(i.data().status==="completed")
        paid+=i.data().amount;
    });

    const percent=
      total?Math.round((paid/total)*100):0;

    loanContent.innerHTML+=`
      <div class="card">
        <b>‚Çπ${loan.principal}</b><br>
        Start:
        ${new Date(loan.startDate)
         .toLocaleDateString("en-IN")}<br>
        <div class="progress">
          <div class="progress-bar"
           style="width:${percent}%"></div>
        </div>
        ${percent}% paid<br>
        <button onclick="viewInstallments('${d.id}')">
          View Installments
        </button>
      </div>
    `;
  }
}

/* VIEW INSTALLMENTS */
window.viewInstallments=async(loanId)=>{

  const loanContent=
    document.getElementById("loanContent");

  const snap=await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  loanContent.innerHTML=`
    <div class="card">
      <button onclick="loadLoans(currentBorrowerId)">
        ‚¨Ö Back to Loans
      </button>
    </div>
  `;

  let list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  list.sort((a,b)=>a.number-b.number);

  list.forEach(i=>{
    const overdue=
      i.status==="pending"
      && i.dueDate<Date.now();

    loanContent.innerHTML+=`
      <div class="card ${overdue?"overdue":""}">
        Installment ${i.number}<br>
        ‚Çπ${i.amount}<br>
        üìÖ ${new Date(i.dueDate)
         .toLocaleDateString("en-IN")}<br>
        ${i.status}
        ${i.status==="pending"
          ? `<button onclick="
             markPaid('${i.id}',
             '${loanId}',
             ${i.amount})">
             Mark Paid</button>`
          : ""
        }
      </div>
    `;
  });
};

/* MARK PAID */
window.markPaid=async(instId,loanId,amount)=>{

  await updateDoc(doc(db,"installments",instId),
  {status:"completed"});

  await addDoc(collection(db,"collections"),{
    loanId,
    agentId:currentUserId,
    amount,
    type:"installment",
    date:Date.now()
  });

  viewInstallments(loanId);
};

</script>
</body>
</html>