<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Borrowers</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="header">Borrowers</div>

<div class="nav">
  <div onclick="location.href='agent-dashboard.html'">
    Dashboard
  </div>
  <div class="active">Borrowers</div>
  <div onclick="logout()">Logout</div>
</div>

<div class="content">

<!-- SEARCH + ADD -->
<div id="topActions" class="actions">
  <div class="icon-btn" onclick="toggleSearch()">üîç</div>
  <div class="icon-btn" onclick="toggleAdd()">‚ûï</div>
</div>

<div id="searchBox" class="hidden">
  <input id="searchInput"
    placeholder="Search name or phone">
</div>

<div id="addBox" class="hidden">
  <input id="newName" placeholder="Name">
  <input id="newPhone" placeholder="Phone">
  <button onclick="createBorrower()">Save</button>
</div>

<!-- LIST -->
<div id="borrowerList"></div>

<!-- PROFILE -->
<div id="profileView" class="hidden"></div>

</div>

<script type="module">

import { auth, db } from "./js/firebase.js";
import {
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  collection,
  query,
  where,
  addDoc,
  getDocs,
  doc,
  getDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

let currentUserId=null;
let borrowerCache=[];
let currentBorrowerId=null;
let openedLoanId=null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUserId=user.uid;
  loadBorrowers();
});

/* LOGOUT */
window.logout=()=>signOut(auth);

/* TOGGLE SEARCH */
window.toggleSearch=()=>{
  searchBox.classList.toggle("hidden");
  addBox.classList.add("hidden");
};

/* TOGGLE ADD */
window.toggleAdd=()=>{
  addBox.classList.toggle("hidden");
  searchBox.classList.add("hidden");
};

/* CREATE BORROWER */
window.createBorrower=async()=>{
  const name=newName.value.trim();
  const phone=newPhone.value.trim();
  if(!name||!phone)return;

  await addDoc(collection(db,"borrowers"),{
    name,
    phone,
    agentId:currentUserId,
    createdAt:Date.now()
  });

  newName.value="";
  newPhone.value="";
  loadBorrowers();
};

/* LOAD BORROWERS */
async function loadBorrowers(){

  profileView.classList.add("hidden");
  borrowerList.classList.remove("hidden");

  const q=query(
    collection(db,"borrowers"),
    where("agentId","==",currentUserId)
  );

  const snap=await getDocs(q);

  borrowerCache=[];
  snap.forEach(d=>{
    borrowerCache.push({id:d.id,...d.data()});
  });

  borrowerCache.sort((a,b)=>a.name.localeCompare(b.name));

  renderList(borrowerCache);
}

/* RENDER LIST */
function renderList(list){

  borrowerList.innerHTML="";

  if(list.length===0){
    borrowerList.innerHTML=
      `<div class="card">No borrowers</div>`;
    return;
  }

  list.forEach(b=>{
    borrowerList.innerHTML+=`
      <div class="list-item"
        onclick="openProfile('${b.id}')">
        <b>${b.name}</b><br>
        ${b.phone}
      </div>`;
  });
}

/* SEARCH */
searchInput.addEventListener("input",e=>{
  const val=e.target.value.toLowerCase();
  const filtered=borrowerCache.filter(b=>
    b.name.toLowerCase().includes(val) ||
    b.phone.includes(val)
  );
  renderList(filtered);
});

/* OPEN PROFILE */
window.openProfile=async(id)=>{

  currentBorrowerId=id;

  borrowerList.classList.add("hidden");
  profileView.classList.remove("hidden");

  const snap=await getDoc(doc(db,"borrowers",id));
  const b=snap.data();

  profileView.innerHTML=`
    <div class="profile-card">
      <div class="profile-top">
        <img src="${
          b.photoUrl || 
          'https://via.placeholder.com/80'
        }">

        <div>
          <h2>${b.name}</h2>

          üìû <a href="tel:${b.phone}">
          ${b.phone}</a><br>

          üí¨ <a target="_blank"
          href="https://wa.me/${b.phone}">
          WhatsApp</a>
        </div>
      </div>

      <button onclick="toggleLoanForm()">
        ‚ûï Create Loan
      </button>

      <div id="loanForm"></div>
    </div>

    <div id="activeLoans"></div>
    <div id="completedLoans"></div>
  `;

  loadLoans(id);
};

/* LOAN FORM */
window.toggleLoanForm=()=>{

  if(loanForm.innerHTML!==""){
    loanForm.innerHTML="";
    return;
  }

  loanForm.innerHTML=`
    <div class="card">
      <input id="principal"
        placeholder="Principal">
      <input id="interest"
        placeholder="Interest %">
      <input id="count"
        placeholder="Installments">

      <select id="emiType">
        <option value="7">7 Days</option>
        <option value="15">15 Days</option>
        <option value="30">30 Days</option>
      </select>

      <input type="date" id="startDate">

      <button onclick="createLoan()">
        Confirm
      </button>
    </div>`;
};

/* CREATE LOAN */
window.createLoan=async()=>{

  const p=parseFloat(principal.value);
  const per=parseFloat(interest.value);
  const c=parseInt(count.value);
  const emi=parseInt(emiType.value);
  const start=new Date(startDate.value).getTime();

  if(!p||isNaN(per)||!c||!start)return;

  const interestAmount=(p*per)/100;

  const loan=await addDoc(
    collection(db,"loans"),{
      borrowerId:currentBorrowerId,
      agentId:currentUserId,
      principal:p,
      interestPercent:per,
      interestAmount,
      count:c,
      emiType:emi,
      startDate:start,
      status:"active",
      createdAt:Date.now()
    });

  for(let i=0;i<c;i++){
    await addDoc(
      collection(db,"installments"),{
        loanId:loan.id,
        borrowerId:currentBorrowerId,
        number:i+1,
        amount:p/c,
        dueDate:start+
          ((i+1)*emi*86400000),
        status:"pending"
      });
  }

  loanForm.innerHTML="";
};

/* LOAD LOANS */
async function loadLoans(id){

  const q=query(
    collection(db,"loans"),
    where("borrowerId","==",id)
  );

  const snap=await getDocs(q);

  activeLoans.innerHTML=
    `<h3>Active Loans</h3>`;

  completedLoans.innerHTML=
    `<h3>Completed Loans</h3>`;

  if(snap.empty){
    activeLoans.innerHTML+=
      `<div class="card">No loans</div>`;
    return;
  }

  const loans=[];
  snap.forEach(d=>{
    loans.push({id:d.id,...d.data()});
  });

  loans.sort((a,b)=>b.createdAt-a.createdAt);

  loans.forEach(loan=>{

    const card=document.createElement("div");
    card.className=
      "card loan-card "+
      (loan.status==="completed"
       ? "completed":"");

    card.innerHTML=`
      <b>‚Çπ${loan.principal}</b><br>
      EMI: ${loan.emiType} days<br>
      Start:
      ${new Date(
        loan.startDate
      ).toLocaleDateString()}<br>
      <button onclick=
      "toggleInstallments('${loan.id}')">
      View Installments</button>

      <div id="inst-${loan.id}"
        class="inst hidden"></div>
    `;

    if(loan.status==="completed")
      completedLoans.appendChild(card);
    else
      activeLoans.appendChild(card);
  });
}

/* INSTALLMENTS */
window.toggleInstallments = async (loanId) => {

  /* CLOSE OTHER OPEN LOANS */
  document.querySelectorAll(".inst")
  .forEach(el=>{
    if(el.id !== `inst-${loanId}`){
      el.classList.add("hidden");
      el.innerHTML="";
    }
  });

  const box =
    document.getElementById(`inst-${loanId}`);

  /* CLOSE IF SAME LOAN CLICKED AGAIN */
  if(!box.classList.contains("hidden")){
    box.classList.add("hidden");
    box.innerHTML="";
    return;
  }

  box.classList.remove("hidden");
  box.innerHTML="Loading...";

  const snap = await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  if(snap.empty){
    box.innerHTML=
      `<div class="card">
       No Installments</div>`;
    return;
  }

  let list=[];
  snap.forEach(d=>{
    list.push({id:d.id,...d.data()});
  });

  /* SORT BY EMI NUMBER */
  list.sort((a,b)=>a.number - b.number);

  const pending=[];
  const completed=[];

  list.forEach(i=>{
    if(i.status==="completed")
      completed.push(i);
    else
      pending.push(i);
  });

  box.innerHTML="";

  /* ----- PENDING SECTION ----- */
  if(pending.length>0){
    box.innerHTML+=
      `<h4>Pending Installments</h4>`;

    pending.forEach(i=>{

      let className="installment-card pending";

      if(i.dueDate < Date.now())
        className="installment-card overdue";

      box.innerHTML+=`
        <div class="${className}">
          <b>EMI ${i.number}</b><br>
          ‚Çπ${i.amount}<br>
          üìÖ ${new Date(i.dueDate)
              .toLocaleDateString("en-IN")}
          <br><br>

          <button class="secondary"
            onclick="
            pay('${i.id}',
            '${loanId}',
            ${i.amount})">
            Mark Paid
          </button>
        </div>
      `;
    });
  }

  /* ----- COMPLETED SECTION ----- */
  if(completed.length>0){
    box.innerHTML+=
      `<h4 style="margin-top:16px;">
       Completed Installments
       </h4>`;

    completed.forEach(i=>{
      box.innerHTML+=`
        <div class="installment-card completed">
          <b>EMI ${i.number}</b><br>
          ‚Çπ${i.amount}<br>
          üìÖ ${new Date(i.dueDate)
              .toLocaleDateString("en-IN")}
          <br><br>

          <span class="badge badge-complete">
          Paid
          </span>
        </div>
      `;
    });
  }
};

window.pay = async(id, loanId, amt) => {

  await updateDoc(
    doc(db,"installments",id),
    {status:"completed"}
  );

  const snap = await getDocs(query(
    collection(db,"installments"),
    where("loanId","==",loanId)
  ));

  let allPaid=true;

  snap.forEach(d=>{
    if(d.data().status!=="completed")
      allPaid=false;
  });

  if(allPaid){
    await updateDoc(
      doc(db,"loans",loanId),
      {status:"completed"}
    );
  }

  /* REFRESH UI */
  toggleInstallments(loanId);
};

</script>
</body>
</html>